<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Lekcji - Nauczyciele</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f0f2f5;
            --card-bg: #fff;
            --primary: #007bff;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        body { font-family: var(--font-main); background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; }
        
        header { text-align: center; margin-bottom: 25px; }
        h1 { margin: 0; color: var(--primary); }
        .subtitle { color: var(--secondary); font-size: 0.9em; margin-top: 5px; }

        /* Panel Sterowania */
        .controls { 
            background: var(--card-bg); padding: 15px; border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-wrap: wrap; gap: 15px; 
            align-items: center; justify-content: center; margin-bottom: 20px;
        }
        select, input[type="date"] { padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 1rem; }
        button { 
            padding: 8px 16px; background: var(--primary); color: white; border: none; 
            border-radius: 4px; cursor: pointer; font-size: 1rem; transition: 0.2s; 
        }
        button:hover { background: #0056b3; }

        /* Status i Ładowanie */
        #status-bar { text-align: center; margin: 10px 0; font-weight: bold; min-height: 24px; }
        .loading { color: var(--primary); }
        .error { color: var(--danger); }

        /* Lista zdarzeń (Timeline) */
        .timeline { display: flex; flex-direction: column; gap: 10px; }
        
        .card {
            background: var(--card-bg); border-radius: 6px; padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 5px solid var(--secondary);
            display: grid; grid-template-columns: 80px 1fr; gap: 15px;
            position: relative;
        }

        .time-box { 
            display: flex; flex-direction: column; justify-content: center; 
            align-items: center; border-right: 1px solid #eee; padding-right: 15px;
            font-size: 0.85em; color: #555; font-weight: bold;
        }
        .period-num { font-size: 1.4em; color: var(--primary); margin-bottom: 2px; }

        .info-box { display: flex; flex-direction: column; justify-content: center; }
        .main-title { font-weight: bold; font-size: 1.1em; margin-bottom: 4px; }
        .sub-title { color: #666; font-size: 0.9em; }
        .details { font-size: 0.85em; color: #888; margin-top: 4px; }

        /* Rodzaje zdarzeń */
        .type-lesson { border-left-color: var(--primary); }
        .type-duty { border-left-color: var(--warning); background-color: #fffdf5; }
        .type-sub { border-left-color: var(--danger); background-color: #fff5f5; }
        .type-added { border-left-color: var(--success); background-color: #f0fff4; }

        .badge { 
            display: inline-block; padding: 2px 6px; border-radius: 4px; 
            font-size: 0.75em; color: white; font-weight: bold; margin-right: 5px; 
        }
        .bg-sub { background: var(--danger); }
        .bg-duty { background: var(--warning); color: #333; }
        .bg-new { background: var(--success); }

        .cancelled-text { text-decoration: line-through; opacity: 0.5; }
        
        /* Debug info o dopasowaniu nazwisk */
        .match-info { font-size: 0.7em; color: #aaa; margin-top: 5px; font-style: italic; display: none; }
        .show-debug .match-info { display: block; }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Plan Lekcji + Dyżury</h1>
        <div class="subtitle">Zintegrowany system z automatyczną korektą nazwisk</div>
    </header>

    <div class="controls">
        <label>Data: <input type="date" id="date-picker"></label>
        <select id="teacher-select" disabled>
            <option>Ładowanie danych...</option>
        </select>
        <button onclick="render()">Pokaż Plan</button>
        <label style="font-size: 0.8em; margin-left: 10px;">
            <input type="checkbox" id="debug-mode" onchange="document.body.classList.toggle('show-debug')"> Debug
        </label>
    </div>

    <div id="status-bar"></div>
    <div id="timeline" class="timeline"></div>
</div>

<script>
    // === KONFIGURACJA ===
    // Upewnij się, że nazwy plików w repozytorium są identyczne (wielkość liter ma znaczenie na GitHub!)
    const CONFIG = {
        xmlUrl: './plan.xml',
        dyzuryUrl: './dyzury.xlsx',
        zastepstwaUrl: './zastepstwa.xlsx'
    };

    // Baza danych w pamięci
    const DB = {
        teachers: {}, // Mapa: ID -> { name: "Nazwisko Imie", normalized: "imienazwisko" }
        periods: [],  // Godziny lekcyjne
        lessons: [],  // Lekcje z XML
        duties: [],   // Dyżury stałe
        substitutions: [], // Zastępstwa lekcyjne
        dutyChanges: []    // Zastępstwa dyżurowe
    };

    // === START ===
    window.onload = async () => {
        document.getElementById('date-picker').valueAsDate = new Date();
        setStatus("Ładowanie plików...", "loading");
        
        try {
            await loadXML();
            await loadExcel(CONFIG.dyzuryUrl, 'dyzury');
            await loadExcel(CONFIG.zastepstwaUrl, 'zastepstwa');
            
            populateSelect();
            setStatus("", "");
            // render(); // Opcjonalnie od razu pokaż dla pierwszego nauczyciela
        } catch (e) {
            console.error(e);
            setStatus("Błąd: " + e.message, "error");
        }
    };

    function setStatus(msg, type) {
        const el = document.getElementById('status-bar');
        el.innerText = msg;
        el.className = type;
    }

    // === 1. SILNIK NORMALIZACJI NAZWISK (FUZZY MATCHING) ===
    
    // Funkcja czyszcząca nazwę do porównań
    function normalizeString(str) {
        if (!str) return "";
        return str.toString().toLowerCase()
            .replace(/^(x\.|ks\.|p\.|pani|pan)\s+/g, '') // Usuń prefiksy
            .replace(/[^a-złąceźżńóś\s]/g, '')   // Usuń znaki specjalne (zostaw polskie litery i spacje)
            .trim()
            .split(/\s+/)       // Podziel na słowa
            .sort()             // Posortuj (Jan Kowalski == Kowalski Jan)
            .join(' ');         // Złącz
    }

    // Algorytm Levenshteina (odległość edycyjna)
    function levenshtein(a, b) {
        const matrix = [];
        for(let i=0; i<=b.length; i++) matrix[i] = [i];
        for(let j=0; j<=a.length; j++) matrix[0][j] = j;

        for(let i=1; i<=b.length; i++){
            for(let j=1; j<=a.length; j++){
                if(b.charAt(i-1) == a.charAt(j-1)){
                    matrix[i][j] = matrix[i-1][j-1];
                } else {
                    matrix[i][j] = Math.min(
                        matrix[i-1][j-1] + 1, // zamiana
                        Math.min(matrix[i][j-1] + 1, matrix[i-1][j] + 1) // wstawienie/usunięcie
                    );
                }
            }
        }
        return matrix[b.length][a.length];
    }

    // Znajdź ID nauczyciela z XML pasujące do nazwy z Excela
    function findTeacherId(rawName) {
        if (!rawName || rawName.length < 3) return null;
        if (rawName.toLowerCase().includes("wakat") || rawName.toLowerCase().includes("brak")) return null;

        const target = normalizeString(rawName);
        let bestId = null;
        let minDistance = 100;

        for (const [id, tData] of Object.entries(DB.teachers)) {
            const source = tData.normalized;
            
            // 1. Dokładne dopasowanie po normalizacji (szybkie)
            if (source === target) return id;

            // 2. Jeśli jedno zawiera drugie (np. "Kowalski" w "Kowalski Jan")
            if (target.length > 4 && (source.includes(target) || target.includes(source))) {
                // Preferujemy dokładniejsze dopasowania, ale to jest silny sygnał
                if (minDistance > 1) {
                    minDistance = 1;
                    bestId = id;
                }
            }

            // 3. Levenshtein dla literówek (Barabara)
            const dist = levenshtein(source, target);
            // Dopuszczamy błąd zależny od długości słowa (max 3 znaki różnicy dla długich)
            const threshold = source.length > 5 ? 3 : 1; 
            
            if (dist < minDistance && dist <= threshold) {
                minDistance = dist;
                bestId = id;
            }
        }
        
        return bestId;
    }

    // === 2. OBSŁUGA DANYCH ===

    async function loadXML() {
        const resp = await fetch(CONFIG.xmlUrl);
        if (!resp.ok) throw new Error("Brak pliku plan.xml");
        const txt = await resp.text();
        const xml = new DOMParser().parseFromString(txt, "text/xml");

        // 1. Nauczyciele
        xml.querySelectorAll('teachers teacher').forEach(t => {
            const id = t.getAttribute('id');
            const rawName = `${t.getAttribute('lastname')} ${t.getAttribute('firstname')} ${t.getAttribute('name')}`; 
            // Czasem name to skrót, firstname imię, lastname nazwisko. Składamy wszystko co jest.
            
            DB.teachers[id] = {
                name: `${t.getAttribute('firstname') || ''} ${t.getAttribute('lastname') || t.getAttribute('name')}`.trim(),
                normalized: normalizeString(`${t.getAttribute('firstname')} ${t.getAttribute('lastname')}`)
            };
        });

        // 2. Godziny
        xml.querySelectorAll('periods period').forEach(p => {
            DB.periods.push({
                nr: p.getAttribute('period'),
                start: p.getAttribute('starttime'),
                end: p.getAttribute('endtime')
            });
        });

        // 3. Lekcje
        // Pomocniczo: Przedmioty i Sale
        const subjects = {};
        xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));
        const rooms = {};
        xml.querySelectorAll('classrooms classroom').forEach(r => rooms[r.getAttribute('id')] = r.getAttribute('name'));

        xml.querySelectorAll('cards card').forEach(c => {
            const lessonId = c.getAttribute('lessonid');
            const lNode = xml.querySelector(`lessons lesson[id="${lessonId}"]`);
            if (!lNode) return;

            const teacherId = lNode.getAttribute('teacherids');
            const dayBit = c.getAttribute('days'); 
            const dayIdx = dayBit.indexOf('1') + 1; // 1=Poniedziałek
            
            if (dayIdx > 0 && teacherId) {
                DB.lessons.push({
                    teacherId: teacherId,
                    day: dayIdx,
                    period: c.getAttribute('period'),
                    subject: subjects[lNode.getAttribute('subjectid')] || 'Lekcja',
                    room: rooms[c.getAttribute('classroomids')] || '',
                    className: '' // XML aSc ma skomplikowaną relację klas, pomijam dla czytelności kodu
                });
            }
        });
    }

    async function loadExcel(url, type) {
        const resp = await fetch(url);
        if (!resp.ok) throw new Error(`Brak pliku ${url}`);
        const ab = await resp.arrayBuffer();
        const wb = XLSX.read(ab, {type: 'array'});

        if (type === 'dyzury') parseDuties(wb);
        if (type === 'zastepstwa') parseSubstitutions(wb);
    }

    function parseDuties(wb) {
        // Logika szukania arkusza z dyżurami
        const sheet = wb.Sheets[wb.SheetNames.find(n => n.toLowerCase().includes('plan')) || wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, {header: 1});

        // Szukanie wiersza nagłówkowego (Poniedziałek, Wtorek...)
        let headRow = -1;
        const dayMap = {};
        
        for(let i=0; i<data.length; i++) {
            const row = data[i];
            row.forEach((cell, idx) => {
                if(typeof cell === 'string') {
                    if(cell.includes('Poniedziałek')) { headRow = i; dayMap[idx] = 1; }
                    if(cell.includes('Wtorek')) { headRow = i; dayMap[idx] = 2; }
                    if(cell.includes('Środa')) { headRow = i; dayMap[idx] = 3; }
                    if(cell.includes('Czwartek')) { headRow = i; dayMap[idx] = 4; }
                    if(cell.includes('Piątek')) { headRow = i; dayMap[idx] = 5; }
                }
            });
            if(headRow > -1) break;
        }

        if(headRow === -1) return;

        // Czytanie danych
        for(let i = headRow + 1; i < data.length; i++) {
            const row = data[i];
            const place = row[0]; // Założenie: kol 0 to miejsce
            const timeRaw = row[1]; // Założenie: kol 1 to czas
            
            if(!timeRaw || !place) continue;

            for(const [colIdx, dayNr] of Object.entries(dayMap)) {
                const rawName = row[colIdx];
                if(rawName && rawName.length > 2) {
                    // TUTAJ DZIAŁA MAGICZNE DOPASOWANIE
                    const tId = findTeacherId(rawName);
                    if (tId) {
                        DB.duties.push({
                            teacherId: tId,
                            day: dayNr,
                            time: timeRaw.trim(),
                            place: place,
                            rawName: rawName // do debugowania
                        });
                    }
                }
            }
        }
    }

    function parseSubstitutions(wb) {
        // Arkusz Oddziały (zastępstwa lekcyjne)
        const sSub = wb.Sheets["Oddziały"] || wb.Sheets[0];
        const dSub = XLSX.utils.sheet_to_json(sSub);
        
        dSub.forEach(row => {
            const dateStr = normalizeDate(row['Dzień']);
            if(!dateStr) return;

            // Kto nieobecny?
            const absId = findTeacherId(row['Nauczyciel/wakat']);
            // Kto zastępuje?
            const subId = findTeacherId(row['Zastępca']);
            
            DB.substitutions.push({
                date: dateStr,
                periodInfo: row['Lekcja'], // "2, 08:50-09:35"
                absentId: absId,
                subId: subId,
                subject: row['Przedmiot'],
                branch: row['Oddział'],
                note: row['Uwagi'],
                rawAbs: row['Nauczyciel/wakat'], // debug
                rawSub: row['Zastępca'] // debug
            });
        });

        // Arkusz Dyżury (zmiany w dyżurach)
        const sDuty = wb.Sheets["Dyżury"];
        if(sDuty) {
            const dDuty = XLSX.utils.sheet_to_json(sDuty);
            dDuty.forEach(row => {
                DB.dutyChanges.push({
                    date: normalizeDate(row['Dzień']),
                    time: row['Godzina'],
                    absentId: findTeacherId(row['Nauczyciel']),
                    subId: findTeacherId(row['Zastępca']),
                    place: row['Miejsce dyżuru']
                });
            });
        }
    }

    function normalizeDate(val) {
        if(!val) return null;
        // Obsługa formatu Excel (liczba dni od 1900)
        if(typeof val === 'number') {
            const d = XLSX.SSF.parse_date_code(val);
            return `${d.y}-${pad(d.m)}-${pad(d.d)}`;
        }
        // Obsługa tekstu "08.12.2025"
        if(typeof val === 'string') {
            const parts = val.trim().split('.');
            if(parts.length === 3) return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }
        return null;
    }
    function pad(n) { return n < 10 ? '0'+n : n; }

    // === 3. WYŚWIETLANIE (UI) ===

    function populateSelect() {
        const sel = document.getElementById('teacher-select');
        sel.innerHTML = '<option value="">-- Wybierz Nauczyciela --</option>';
        sel.disabled = false;

        // Sortuj po nazwie wyświetlanej
        const sorted = Object.entries(DB.teachers).sort((a,b) => a[1].name.localeCompare(b[1].name));
        
        sorted.forEach(([id, t]) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = t.name;
            sel.appendChild(opt);
        });
    }

    function render() {
        const tId = document.getElementById('teacher-select').value;
        const dateVal = document.getElementById('date-picker').value;
        const box = document.getElementById('timeline');
        box.innerHTML = '';

        if(!tId || !dateVal) return;

        const dateObj = new Date(dateVal);
        const dayOfWeek = dateObj.getDay(); // 0-ND, 1-PN
        
        if(dayOfWeek === 0 || dayOfWeek === 6) {
            box.innerHTML = '<div style="padding:20px; text-align:center;">Weekend - brak zajęć</div>';
            return;
        }

        // --- ZBIERANIE DANYCH ---
        let events = [];

        // 1. Lekcje z planu bazowego (XML)
        DB.lessons.filter(l => l.teacherId === tId && l.day === dayOfWeek).forEach(l => {
            const period = DB.periods.find(p => p.nr == l.period);
            events.push({
                type: 'lesson',
                sortTime: period.start,
                period: l.period,
                timeDesc: `${period.start} - ${period.end}`,
                title: l.subject,
                subtitle: `Sala: ${l.room}`,
                original: true
            });
        });

        // 2. Dyżury stałe
        DB.duties.filter(d => d.teacherId === tId && d.day === dayOfWeek).forEach(d => {
            events.push({
                type: 'duty',
                sortTime: d.time.split('-')[0].trim(),
                timeDesc: d.time,
                title: 'DYŻUR',
                subtitle: d.place,
                original: true,
                rawName: d.rawName // do debugu
            });
        });

        // 3. Aplikowanie zastępstw
        
        // A. Lekcje - czy jestem nieobecny?
        const myAbsences = DB.substitutions.filter(s => s.date === dateVal && s.absentId === tId);
        myAbsences.forEach(sub => {
            const nr = sub.periodInfo.split(',')[0]; // "2"
            // Znajdź tę lekcję w events i oznacz
            const ev = events.find(e => e.type === 'lesson' && e.period == nr);
            if(ev) {
                ev.status = 'cancelled';
                ev.subInfo = `Zastępstwo: ${sub.rawSub || 'Brak'} (${sub.note || ''})`;
                ev.type = 'sub'; // Zmienia styl
            }
        });

        // B. Lekcje - czy zastępuję kogoś?
        const mySubs = DB.substitutions.filter(s => s.date === dateVal && s.subId === tId);
        mySubs.forEach(sub => {
            const parts = sub.periodInfo.split(',');
            const nr = parts[0];
            const timeRange = parts[1] || "";
            const startTime = timeRange.split('-')[0].trim() || "00:00";

            events.push({
                type: 'added',
                sortTime: startTime,
                period: nr,
                timeDesc: timeRange,
                title: `Zastępstwo za: ${sub.rawAbs}`,
                subtitle: `${sub.subject} | Klasa: ${sub.branch}`,
                note: sub.note
            });
        });

        // C. Dyżury - czy jestem nieobecny?
        const dutyAbs = DB.dutyChanges.filter(d => d.date === dateVal && d.absentId === tId);
        dutyAbs.forEach(da => {
            // Szukamy dyżuru o tej godzinie
            const ev = events.find(e => e.type === 'duty' && e.timeDesc === da.time);
            if(ev) {
                ev.status = 'cancelled';
                ev.subInfo = `Zastępstwo na dyżurze: ${da.subId ? 'Tak' : 'Nie'}`;
            }
        });

        // D. Dyżury - czy zastępuję?
        const dutyNew = DB.dutyChanges.filter(d => d.date === dateVal && d.subId === tId);
        dutyNew.forEach(dn => {
            events.push({
                type: 'duty',
                sortTime: dn.time.split('-')[0],
                timeDesc: dn.time,
                title: 'DYŻUR (Zastępstwo)',
                subtitle: dn.place,
                typeOverride: 'added'
            });
        });

        // --- SORTOWANIE I RENDEROWANIE ---
        events.sort((a,b) => a.sortTime.localeCompare(b.sortTime));

        if(events.length === 0) {
            box.innerHTML = '<div style="padding:20px; text-align:center;">Brak planu na ten dzień.</div>';
            return;
        }

        events.forEach(ev => {
            const el = document.createElement('div');
            // Klasy CSS
            let classes = ['card'];
            if(ev.type === 'lesson') classes.push('type-lesson');
            if(ev.type === 'duty') classes.push('type-duty');
            if(ev.type === 'sub') classes.push('type-sub');
            if(ev.type === 'added' || ev.typeOverride === 'added') classes.push('type-added');
            
            el.className = classes.join(' ');

            let html = `
                <div class="time-box">
                    ${ev.period ? `<span class="period-num">${ev.period}</span>` : ''}
                    <span>${ev.timeDesc}</span>
                </div>
                <div class="info-box">
                    <div class="main-title ${ev.status==='cancelled'?'cancelled-text':''}">
                        ${ev.status==='cancelled' ? '<span class="badge bg-sub">ODWOŁANE</span>' : ''}
                        ${ev.type==='added' ? '<span class="badge bg-new">NOWE</span>' : ''}
                        ${ev.title}
                    </div>
                    <div class="sub-title">${ev.subtitle}</div>
            `;
            
            if(ev.note) html += `<div class="details">Uwagi: ${ev.note}</div>`;
            if(ev.subInfo) html += `<div class="details" style="color:var(--danger)">${ev.subInfo}</div>`;
            
            // Debug info
            if(ev.rawName) {
                html += `<div class="match-info">Oryginał w Excelu: "${ev.rawName}" -> Zmapowano na ID XML</div>`;
            }

            html += `</div>`; // koniec info-box
            el.innerHTML = html;
            box.appendChild(el);
        });
    }

</script>

</body>
</html>
