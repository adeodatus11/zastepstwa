<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Nauczyciela - Wersja Finalna</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f3f4f6;
            --header-bg: #1f2937;
            --text-main: #111827;
            
            --card-bg: #ffffff;
            --lesson-border: #3b82f6;
            
            /* Kolory statusów */
            --sub-bg: #fef2f2; --sub-color: #991b1b; --sub-border: #f87171; /* Odwołane/Zastępowane */
            
            --new-bg: #dcfce7; --new-color: #166534; --new-border: #22c55e; /* Nowa lekcja (zwykła) */
            
            --duty-bg: #fffbeb; --duty-color: #92400e; --duty-border: #fcd34d; /* Zwykły dyżur */
            
            --duty-sub-bg: #ccff33; /* JASKRAWY ZIELONY dla zastępstwa na dyżurze */
            --duty-sub-border: #aadd00;
            --duty-sub-color: #000;

            --empty: #f9fafb;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text-main); }

        header { 
            background: var(--header-bg); color: white; padding: 15px 20px; 
            position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 15px;
        }
        h1 { margin: 0; font-size: 1.25rem; font-weight: 600; }
        
        .controls { display: flex; gap: 10px; align-items: center; }
        select, input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; }
        button { 
            background: #2563eb; color: white; border: none; padding: 9px 18px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s;
        }
        button:hover { background: #1d4ed8; }

        #debug-bar { 
            background: #e5e7eb; font-size: 0.75rem; padding: 4px 20px; color: #4b5563; 
            border-bottom: 1px solid #d1d5db; display: flex; justify-content: space-between;
        }

        .week-container {
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 15px; padding: 20px; align-items: start;
        }

        .day-col {
            background: #fff; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden; display: flex; flex-direction: column;
        }

        .day-header {
            background: #f3f4f6; color: #374151; padding: 12px; 
            text-align: center; font-weight: 700; border-bottom: 1px solid #e5e7eb;
        }
        .day-date { font-weight: 400; font-size: 0.8em; color: #6b7280; display: block; margin-top: 2px; }

        .day-content { padding: 10px; display: flex; flex-direction: column; gap: 8px; }

        /* Kafelki */
        .slot-wrapper { border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }

        .lesson-card {
            background: var(--card-bg); border-left: 4px solid var(--lesson-border);
            padding: 10px; min-height: 50px;
        }
        .lesson-card.empty {
            background: var(--empty); border-left-color: #d1d5db; color: #9ca3af;
            display: flex; align-items: center; justify-content: center; font-style: italic; font-size: 0.85rem;
        }
        
        .meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px; font-weight: 600; }
        .nr { background: #f3f4f6; padding: 1px 6px; border-radius: 4px; color: #374151; }
        
        .subject { font-weight: 700; font-size: 0.95rem; margin-bottom: 2px; }
        .details { font-size: 0.8rem; color: #4b5563; line-height: 1.3; }
        .pay-info { font-weight: 700; color: #047857; font-size: 0.75rem; margin-top: 4px; text-transform: uppercase; }

        /* Warianty Lekcji */
        .is-sub { background: var(--sub-bg); border-left-color: var(--sub-border); }
        .is-sub .subject { text-decoration: line-through; opacity: 0.7; }
        .note-red { color: var(--sub-color); font-weight: 600; font-size: 0.8rem; margin-top: 4px; display: block; }
        
        .is-new { background: var(--new-bg); border-left-color: var(--new-border); }
        .note-green { color: var(--new-color); font-weight: 600; font-size: 0.8rem; margin-top: 4px; display: block; }

        /* Dyżury */
        .duty-section {
            background: var(--duty-bg); color: var(--duty-color);
            border-top: 1px dashed var(--duty-border);
            padding: 6px 10px; font-size: 0.8rem;
        }
        
        /* Zastępstwo na dyżurze - JASKRAWY */
        .duty-section.duty-sub {
            background: var(--duty-sub-bg);
            color: var(--duty-sub-color);
            border-top: 2px solid var(--duty-sub-border);
        }

        .duty-header { font-weight: 700; font-size: 0.75em; opacity: 0.9; text-transform: uppercase; margin-bottom: 2px; }
        .duty-place { font-weight: 600; }

        /* Dyżur poranny */
        .morning-duty {
            background: var(--duty-bg); border-left: 4px solid #f59e0b;
            padding: 10px; border-radius: 8px; margin-bottom: 5px;
            color: var(--duty-color); font-size: 0.85rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        /* Poranne zastępstwo */
        .morning-duty.duty-sub {
            background: var(--duty-sub-bg); 
            border-left: 4px solid var(--duty-sub-border);
            color: var(--duty-sub-color);
        }

        @media (max-width: 900px) { .week-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <h1>Plan Lekcji</h1>
    <div class="controls">
        <input type="date" id="date-picker">
        <select id="teacher-select" disabled>
            <option>Wczytywanie...</option>
        </select>
        <button onclick="render()">Pokaż</button>
    </div>
</header>

<div id="debug-bar">Oczekiwanie na dane...</div>
<div id="grid" class="week-container"></div>

<script>
    const CONFIG = {
        xml: './plan.xml',
        dyzury: './dyzury.xlsx',
        zastepstwa: './zastepstwa.xlsx'
    };

    const DB = {
        teachers: {},
        periods: [],
        lessons: [],
        duties: [],
        subs: [],
        dutyChanges: []
    };

    const DAYS = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];

    window.onload = async () => {
        document.getElementById('date-picker').valueAsDate = new Date();
        log("Ładowanie plików...", true);
        
        try {
            await loadXML();
            await loadExcel(CONFIG.dyzury, 'dyzury');
            await loadExcel(CONFIG.zastepstwa, 'zastepstwa');
            
            populateSelect();
            log(`Gotowe. Wczytano ${DB.lessons.length} lekcji i zastępstw.`);
        } catch (e) {
            console.error(e);
            log("BŁĄD: " + e.message, true);
        }
    };

    function log(msg, important=false) {
        const el = document.getElementById('debug-bar');
        el.innerText = msg;
        if(important) el.style.fontWeight = "bold";
    }

    // === PARSOWANIE DANYCH ===

    async function fetchText(url) {
        const res = await fetch(url);
        if(!res.ok) throw new Error("Brak: " + url);
        const blob = await res.blob();
        return new Promise(r => {
            const reader = new FileReader();
            reader.onload = () => r(reader.result);
            reader.readAsText(blob, 'windows-1250'); 
        });
    }

    async function loadXML() {
        const txt = await fetchText(CONFIG.xml);
        const xml = new DOMParser().parseFromString(txt, "text/xml");

        xml.querySelectorAll('teachers teacher').forEach(t => {
            const id = t.getAttribute('id');
            const name = (t.getAttribute('firstname')||'') + ' ' + (t.getAttribute('lastname')||t.getAttribute('name'));
            DB.teachers[id] = { name: name.trim(), normalized: normalize(name) };
        });

        xml.querySelectorAll('periods period').forEach(p => {
            DB.periods.push({
                nr: parseInt(p.getAttribute('period')),
                start: p.getAttribute('starttime'),
                end: p.getAttribute('endtime')
            });
        });
        DB.periods.sort((a,b) => a.nr - b.nr);

        const subjects = {};
        xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));
        const rooms = {};
        xml.querySelectorAll('classrooms classroom').forEach(r => rooms[r.getAttribute('id')] = r.getAttribute('name'));

        xml.querySelectorAll('cards card').forEach(c => {
            const lesson = xml.querySelector(`lessons lesson[id="${c.getAttribute('lessonid')}"]`);
            if(!lesson) return;
            const tids = lesson.getAttribute('teacherids');
            const days = c.getAttribute('days');
            const dayIdx = days.indexOf('1') + 1;
            if(dayIdx > 0 && tids) {
                tids.split(',').forEach(tid => {
                    DB.lessons.push({
                        teacherId: tid.trim(),
                        day: dayIdx,
                        period: parseInt(c.getAttribute('period')),
                        subject: subjects[lesson.getAttribute('subjectid')] || 'Lekcja',
                        room: rooms[c.getAttribute('classroomids')] || ''
                    });
                });
            }
        });
    }

    async function loadExcel(url, type) {
        const res = await fetch(url);
        if(!res.ok) throw new Error("Brak: " + url);
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, {type: 'array'});
        if(type === 'dyzury') parseDuties(wb);
        if(type === 'zastepstwa') parseSub(wb);
    }

    function parseDuties(wb) {
        // Logika skanowania każdego arkusza i każdego bloku w poszukiwaniu dyżurów
        wb.SheetNames.forEach(sheetName => {
            const ws = wb.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(ws, {header: 1});
            let currentDayMap = null;

            for(let i=0; i<data.length; i++) {
                const row = data[i];
                if(!row || row.length === 0) continue;
                const rowStr = row.map(c => String(c || "").toLowerCase());

                if(rowStr.some(s => s.includes('poniedziałek'))) {
                    currentDayMap = {};
                    row.forEach((cell, idx) => {
                        const val = String(cell || "").toLowerCase();
                        if(val.includes('poniedziałek')) currentDayMap[idx] = 1;
                        if(val.includes('wtorek')) currentDayMap[idx] = 2;
                        if(val.includes('środa')) currentDayMap[idx] = 3;
                        if(val.includes('czwartek')) currentDayMap[idx] = 4;
                        if(val.includes('piątek')) currentDayMap[idx] = 5;
                    });
                    continue;
                }

                if(currentDayMap) {
                    let timeVal = null, placeVal = null;
                    for(let c=0; c<5; c++) {
                        if(row[c] && /\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/.test(String(row[c]))) {
                            timeVal = String(row[c]).trim();
                            if(c > 0 && row[c-1]) placeVal = row[c-1]; else if(row[0]) placeVal = row[0]; 
                            break;
                        }
                    }
                    if(timeVal) {
                        for(const [colIdx, dayNum] of Object.entries(currentDayMap)) {
                            const rawTeacher = row[colIdx];
                            if(rawTeacher && String(rawTeacher).length > 2) {
                                const tName = String(rawTeacher).trim();
                                if(/brak|wolne|dyżur|-/.test(tName.toLowerCase())) continue;
                                const tId = findTeacherId(tName);
                                if(tId) {
                                    DB.duties.push({
                                        teacherId: tId, day: dayNum, time: timeVal,
                                        startMin: timeToMin(timeVal.split('-')[0]),
                                        place: placeVal || "Dyżur"
                                    });
                                }
                            }
                        }
                    }
                }
            }
        });
    }

    function parseSub(wb) {
        // Arkusz "Oddziały" - lekcje
        const sh = wb.Sheets["Oddziały"] || wb.Sheets[0];
        XLSX.utils.sheet_to_json(sh).forEach(r => {
            const d = parseDate(r['Dzień']);
            if(d) DB.subs.push({
                date: d,
                periodRaw: r['Lekcja'],
                absent: findTeacherId(r['Nauczyciel/wakat']),
                sub: findTeacherId(r['Zastępca']),
                subject: r['Przedmiot'],
                room: r['Sala'],
                note: r['Uwagi'],
                rawSub: r['Zastępca'],
                branch: r['Oddział'], // NOWE: Oddział
                payInfo: r['Forma płatności'], // NOWE: Płatność
                rawAbs: r['Nauczyciel/wakat'] // NOWE: Kto nieobecny
            });
        });

        // Arkusz "Dyżury" - zmiany dyżurów
        const shDy = wb.Sheets["Dyżury"];
        if(shDy) {
            XLSX.utils.sheet_to_json(shDy).forEach(r => {
                const d = parseDate(r['Dzień']);
                if(d) DB.dutyChanges.push({
                    date: d,
                    time: r['Godzina'],
                    absent: findTeacherId(r['Nauczyciel']),
                    sub: findTeacherId(r['Zastępca']),
                    place: r['Miejsce dyżuru']
                });
            });
        }
    }

    // === NARZĘDZIA ===

    function normalize(str) {
        return (str||"").toLowerCase().replace(/^(x\.|ks\.|p\.|pani|pan)\s+/g, '').replace(/[^a-złąceźżńóś\s]/g, '').trim().split(/\s+/).sort().join(' ');
    }
    function levenshtein(a, b) {
        const m = [];
        for(let i=0; i<=b.length; i++) m[i]=[i];
        for(let j=0; j<=a.length; j++) m[0][j]=j;
        for(let i=1; i<=b.length; i++)
            for(let j=1; j<=a.length; j++)
                m[i][j] = b.charAt(i-1)===a.charAt(j-1) ? m[i-1][j-1] : Math.min(m[i-1][j-1]+1, Math.min(m[i][j-1]+1, m[i-1][j]+1));
        return m[b.length][a.length];
    }
    function findTeacherId(rawName) {
        if(!rawName || rawName.length < 3) return null;
        if(/wakat|brak|okienko/i.test(rawName)) return null;
        const target = normalize(rawName);
        let bestId = null, bestScore = 0;
        for(const [id, t] of Object.entries(DB.teachers)) {
            const source = t.normalized;
            if(source === target) return id;
            if(source.includes(target) || target.includes(source)) { if(bestScore<50) { bestScore=50; bestId=id; } }
            const dist = levenshtein(source, target);
            if(dist <= 2 && source.length>4 && bestScore<80) { bestScore=80; bestId=id; }
        }
        return bestId;
    }
    function timeToMin(str) {
        if(!str) return 0;
        const [h,m] = str.trim().split(':').map(Number);
        return h*60+m;
    }
    function parseDate(val) {
        if(!val) return null;
        if(typeof val === 'number') { const d = XLSX.SSF.parse_date_code(val); return `${d.y}-${d.m<10?'0':''}${d.m}-${d.d<10?'0':''}${d.d}`; }
        if(typeof val === 'string') { const p = val.trim().split('.'); if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`; }
        return null;
    }

    // === RENDEROWANIE ===

    function getMonday(d) {
        d = new Date(d); const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6:1);
        return new Date(d.setDate(diff));
    }

    function populateSelect() {
        const sel = document.getElementById('teacher-select');
        sel.innerHTML = ""; sel.disabled = false;
        const sorted = Object.entries(DB.teachers).sort((a,b) => a[1].name.localeCompare(b[1].name));
        sorted.forEach(([id, t]) => {
            const opt = document.createElement('option');
            opt.value = id; opt.innerText = t.name;
            sel.appendChild(opt);
        });
        if(sorted.length) sel.value = sorted[0][0];
    }

    function render() {
        const tId = document.getElementById('teacher-select').value;
        const dateInput = document.getElementById('date-picker').value;
        const grid = document.getElementById('grid');
        grid.innerHTML = "";
        if(!tId || !dateInput) return;

        const monday = getMonday(dateInput);

        for(let i=0; i<5; i++) {
            const curDate = new Date(monday); curDate.setDate(monday.getDate() + i);
            const dateStr = curDate.toISOString().split('T')[0];
            const dayNum = i + 1;

            const col = document.createElement('div'); col.className = 'day-col';
            col.innerHTML = `<div class="day-header">${DAYS[dayNum]}<span class="day-date">${dateStr}</span></div>`;
            const content = document.createElement('div'); content.className = 'day-content';

            // Dyżur poranny (< 8:00)
            getDutiesForTime(tId, dayNum, dateStr, 0, 480).forEach(d => {
                const div = document.createElement('div'); div.className = 'morning-duty';
                if(d.status==='added') div.classList.add('duty-sub'); // Jaskrawy
                if(d.status==='cancelled') div.style.textDecoration='line-through';
                
                div.innerHTML = `
                    <div style="font-weight:700">${d.status === 'added' ? 'ZASTĘPSTWO!' : 'DYŻUR'} ${d.time}</div>
                    <div>${d.place}</div>`;
                content.appendChild(div);
            });

            // Lekcje
            DB.periods.forEach(p => {
                const wrapper = document.createElement('div'); wrapper.className = 'slot-wrapper';
                const lDiv = document.createElement('div');
                const myL = DB.lessons.find(l => l.teacherId==tId && l.day==dayNum && l.period==p.nr);
                const sAbs = myL ? DB.subs.find(s => s.date==dateStr && s.absent==tId && s.periodRaw.startsWith(p.nr+',')) : null;
                const sAdd = DB.subs.find(s => s.date==dateStr && s.sub==tId && s.periodRaw.startsWith(p.nr+','));

                if(sAdd) {
                    // DODANA LEKCJA (ZASTĘPSTWO)
                    lDiv.className = 'lesson-card is-new';
                    lDiv.innerHTML = `
                        <div class="meta"><span class="nr">${p.nr}</span> ${p.start}-${p.end}</div>
                        <div class="subject">ZASTĘPSTWO</div>
                        <div class="details">
                            Oddział: <b>${sAdd.branch || '?'}</b><br>
                            Za: ${sAdd.rawAbs}<br>
                            Sala: ${sAdd.room}
                        </div>
                        <div class="subject" style="font-size:0.85em; margin-top:5px">${sAdd.subject}</div>
                        ${sAdd.payInfo ? `<div class="pay-info">${sAdd.payInfo}</div>` : ''}
                    `;
                } else if(myL) {
                    // MOJA LEKCJA
                    if(sAbs) {
                        lDiv.className = 'lesson-card is-sub';
                        lDiv.innerHTML = `<div class="meta"><span class="nr">${p.nr}</span> ${p.start}-${p.end}</div>
                                          <div class="subject">${myL.subject}</div>
                                          <span class="note-red">Nieobecność (Zast: ${sAbs.rawSub})</span>`;
                    } else {
                        lDiv.className = 'lesson-card';
                        lDiv.innerHTML = `<div class="meta"><span class="nr">${p.nr}</span> ${p.start}-${p.end}</div>
                                          <div class="subject">${myL.subject}</div><div class="room">Sala: ${myL.room}</div>`;
                    }
                } else {
                    lDiv.className = 'lesson-card empty'; lDiv.innerHTML = `${p.nr}. ${p.start}`;
                }
                wrapper.appendChild(lDiv);

                // Dyżury po lekcji
                const pEnd = timeToMin(p.end);
                getDutiesForTime(tId, dayNum, dateStr, pEnd-5, pEnd+15).forEach(d => {
                    const dDiv = document.createElement('div'); dDiv.className = 'duty-section';
                    
                    if(d.status === 'added') dDiv.classList.add('duty-sub'); // Jaskrawy
                    if(d.status === 'cancelled') dDiv.style.textDecoration='line-through';
                    
                    const label = d.status === 'added' ? 'ZASTĘPSTWO!' : 'DYŻUR';

                    dDiv.innerHTML = `
                        <div class="duty-header">${label} ${d.time}</div>
                        <div class="duty-place">${d.place}</div>
                        ${d.note ? `<div style="font-weight:bold; margin-top:2px">${d.note}</div>` : ''}`;
                    wrapper.appendChild(dDiv);
                });
                content.appendChild(wrapper);
            });
            col.appendChild(content); grid.appendChild(col);
        }
    }

    function getDutiesForTime(tid, day, date, min, max) {
        const res = [];
        // Stałe
        DB.duties.filter(d => d.teacherId==tid && d.day==day).forEach(d => {
            if(d.startMin >= min && d.startMin < max) {
                const canc = DB.dutyChanges.find(c => c.date==date && c.time==d.time && c.absent==tid);
                res.push({...d, status: canc?'cancelled':'ok', note: canc?'Zastępstwo':''});
            }
        });
        // Dodane (Zastępstwa)
        DB.dutyChanges.filter(c => c.date==date && c.sub==tid).forEach(c => {
            const start = timeToMin(c.time.split('-')[0]);
            if(start >= min && start < max) res.push({ time: c.time, place: c.place, startMin: start, status: 'added', note: 'Zastępstwo' });
        });
        return res;
    }
</script>
</body>
</html>
