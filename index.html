<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Nauczyciela + Dyżury</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f8f9fa;
            --header-bg: #2c3e50;
            --text-main: #333;
            
            /* Kolory kafelków */
            --less-bg: #ffffff;
            --less-border: #3498db;
            --empty-bg: #e9ecef;
            
            /* Dyżury */
            --duty-bg: #fff3cd; /* Żółty pastelowy */
            --duty-border: #ffecb5;
            --duty-text: #856404;

            /* Zastępstwa */
            --sub-bg: #f8d7da;
            --sub-border: #f5c6cb;
            --sub-text: #721c24;

            /* Nowe lekcje */
            --new-bg: #d4edda;
            --new-border: #c3e6cb;
            --new-text: #155724;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); color: var(--text-main); margin: 0; padding: 0; }
        
        header { background: var(--header-bg); padding: 15px 20px; color: white; position: sticky; top: 0; z-index: 100; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; justify-content: space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { margin: 0; font-size: 1.2rem; font-weight: 500; }
        
        .controls { display: flex; gap: 10px; }
        select, input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        button { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: #2980b9; }

        #status-bar { text-align: center; font-size: 0.8rem; padding: 5px; background: #ffeeba; display: none; }
        #status-bar.error { background: #f8d7da; color: #721c24; }

        /* GRID */
        .week-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 dni */
            gap: 12px;
            padding: 15px;
            align-items: start;
        }

        .day-column {
            background: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .day-header {
            background: #ecf0f1;
            color: #2c3e50;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #ddd;
        }
        .day-date { font-size: 0.75rem; font-weight: normal; display: block; color: #7f8c8d; margin-top: 2px; }

        .day-body {
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px; /* Odstęp między slotami lekcyjnymi */
        }

        /* SLOT LEKCJI (Zawiera lekcję + ewentualny dyżur po niej) */
        .slot-container {
            display: flex;
            flex-direction: column;
            gap: 0; /* Bez odstępu między lekcją a dyżurem */
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        /* LEKCJA */
        .lesson-card {
            background: var(--less-bg);
            border-left: 4px solid var(--less-border);
            padding: 8px;
            min-height: 50px;
        }
        
        /* PUSTE OKIENKO */
        .lesson-card.empty {
            background: var(--empty-bg);
            border-left-color: #adb5bd;
            color: #adb5bd;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-style: italic;
            font-size: 0.8rem;
        }

        .lesson-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: #888; margin-bottom: 4px; }
        .lesson-nr { background: #eee; padding: 0 4px; border-radius: 3px; font-weight: bold; color: #555; }
        .lesson-title { font-weight: bold; font-size: 0.9rem; margin-bottom: 2px; }
        .lesson-loc { font-size: 0.8rem; color: #666; }

        /* DYŻUR (Podklejony pod lekcję) */
        .duty-card {
            background: var(--duty-bg);
            color: var(--duty-text);
            padding: 6px 8px;
            font-size: 0.75rem;
            border-top: 1px dashed var(--duty-border);
            display: flex;
            flex-direction: column;
        }
        .duty-time { font-weight: bold; margin-bottom: 2px; }
        .duty-loc { font-style: italic; }

        /* SPECJALNY DYŻUR PORANNY (Osobny slot) */
        .morning-duty {
            background: var(--duty-bg);
            border-left: 4px solid #f1c40f;
            padding: 8px;
            margin-bottom: 5px;
            border-radius: 4px;
            font-size: 0.8rem;
            color: var(--duty-text);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* MODYFIKATORY ZASTĘPSTW */
        .is-sub { background: var(--sub-bg); border-left-color: var(--sub-border); color: var(--sub-text); }
        .is-new { background: var(--new-bg); border-left-color: var(--new-border); color: var(--new-text); }
        .cancelled-text { text-decoration: line-through; opacity: 0.6; }
        .note { font-size: 0.75rem; margin-top: 4px; font-weight: bold; }

        @media (max-width: 800px) {
            .week-grid { grid-template-columns: 1fr; }
            header { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>

<header>
    <h1>Plan Nauczyciela</h1>
    <div class="controls">
        <input type="date" id="date-picker">
        <select id="teacher-select" disabled>
            <option>Ładowanie...</option>
        </select>
        <button onclick="render()">Pokaż</button>
    </div>
</header>

<div id="status-bar"></div>

<div id="grid" class="week-grid"></div>

<script>
    // === KONFIGURACJA ===
    const CONFIG = {
        xml: './plan.xml',
        dyzury: './dyzury.xlsx',
        zastepstwa: './zastepstwa.xlsx'
    };

    // Baza danych w pamięci
    const DB = {
        teachers: {},
        periods: [], 
        lessons: [], 
        duties: [],
        subs: [],
        dutyChanges: []
    };

    const DAYS = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];

    window.onload = async () => {
        document.getElementById('date-picker').valueAsDate = new Date();
        status("Ładowanie danych...", false);
        try {
            await Promise.all([
                loadXML(),
                loadExcel(CONFIG.dyzury, 'dyzury'),
                loadExcel(CONFIG.zastepstwa, 'zastepstwa')
            ]);
            populateSelect();
            status("");
        } catch(e) {
            console.error(e);
            status("Błąd: " + e.message, true);
        }
    };

    function status(msg, err) {
        const el = document.getElementById('status-bar');
        el.innerText = msg;
        el.style.display = msg ? 'block' : 'none';
        if(err) el.classList.add('error'); else el.classList.remove('error');
    }

    // === 1. PARSOWANIE I NORMALIZACJA ===
    
    // Pobieranie tekstu z wymuszeniem kodowania dla polskich znaków (aSc XML)
    async function fetchText(url) {
        const res = await fetch(url);
        if(!res.ok) throw new Error("Brak pliku: " + url);
        const blob = await res.blob();
        return new Promise((resolve, reject) => {
            const r = new FileReader();
            r.onload = () => resolve(r.result);
            r.onerror = reject;
            r.readAsText(blob, 'windows-1250'); 
        });
    }

    function normalize(str) {
        if(!str) return "";
        return str.toString().toLowerCase()
            .replace(/^(x\.|ks\.|p\.|pani|pan)\s+/g, '')
            .replace(/[^a-złąceźżńóś\s]/g, '')
            .trim()
            .split(/\s+/)
            .sort()
            .join(' ');
    }

    function levenshtein(a, b) {
        const m = [];
        for(let i=0; i<=b.length; i++) m[i] = [i];
        for(let j=0; j<=a.length; j++) m[0][j] = j;
        for(let i=1; i<=b.length; i++) {
            for(let j=1; j<=a.length; j++) {
                if(b.charAt(i-1)===a.charAt(j-1)) m[i][j] = m[i-1][j-1];
                else m[i][j] = Math.min(m[i-1][j-1]+1, Math.min(m[i][j-1]+1, m[i-1][j]+1));
            }
        }
        return m[b.length][a.length];
    }

    function findTeacherId(rawName) {
        if(!rawName || rawName.length < 3) return null;
        if(rawName.toLowerCase().match(/wakat|brak|okienko/)) return null;
        
        const target = normalize(rawName);
        let bestId = null, bestScore = 0;

        for(const [id, t] of Object.entries(DB.teachers)) {
            const source = t.normalized;
            if(source === target) return id;
            if(source.includes(target) || target.includes(source)) {
                if(bestScore < 50) { bestScore = 50; bestId = id; }
            }
            const dist = levenshtein(source, target);
            if(dist <= 2 && source.length > 4) {
                 if(bestScore < 80) { bestScore = 80; bestId = id; }
            }
        }
        return bestId;
    }

    // === 2. ŁADOWANIE PLIKÓW ===

    async function loadXML() {
        const text = await fetchText(CONFIG.xml);
        const parser = new DOMParser();
        const xml = parser.parseFromString(text, "text/xml");

        xml.querySelectorAll('teachers teacher').forEach(t => {
            const id = t.getAttribute('id');
            const name = (t.getAttribute('firstname')||'') + ' ' + (t.getAttribute('lastname')||t.getAttribute('name'));
            DB.teachers[id] = { name: name.trim(), normalized: normalize(name) };
        });

        xml.querySelectorAll('periods period').forEach(p => {
            DB.periods.push({
                nr: parseInt(p.getAttribute('period')),
                start: p.getAttribute('starttime'),
                end: p.getAttribute('endtime')
            });
        });
        DB.periods.sort((a,b) => a.nr - b.nr);

        const subjects = {};
        xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));
        const rooms = {};
        xml.querySelectorAll('classrooms classroom').forEach(r => rooms[r.getAttribute('id')] = r.getAttribute('name'));

        xml.querySelectorAll('cards card').forEach(c => {
            const lesson = xml.querySelector(`lessons lesson[id="${c.getAttribute('lessonid')}"]`);
            if(!lesson) return;
            const tids = lesson.getAttribute('teacherids');
            if(!tids) return;
            const days = c.getAttribute('days'); 
            const dayIdx = days.indexOf('1') + 1;

            tids.split(',').forEach(tid => {
                if(dayIdx > 0) {
                    DB.lessons.push({
                        teacherId: tid.trim(),
                        day: dayIdx,
                        period: parseInt(c.getAttribute('period')),
                        subject: subjects[lesson.getAttribute('subjectid')] || 'Lekcja',
                        room: rooms[c.getAttribute('classroomids')] || ''
                    });
                }
            });
        });
    }

    async function loadExcel(url, type) {
        const res = await fetch(url);
        if(!res.ok) throw new Error("Brak " + url);
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, {type: 'array'});
        
        if(type === 'dyzury') parseDy(wb);
        if(type === 'zastepstwa') parseSub(wb);
    }

    function parseDy(wb) {
        const sheet = wb.Sheets[wb.SheetNames.find(n => n.includes('plan')) || wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
        let headRow = -1;
        const dayMap = {};
        
        data.forEach((row, i) => {
            if(row.some(c => typeof c==='string' && c.includes('Poniedziałek'))) {
                headRow = i;
                row.forEach((cell, idx) => {
                    if(!cell) return;
                    if(cell.includes('Poniedziałek')) dayMap[idx] = 1;
                    if(cell.includes('Wtorek')) dayMap[idx] = 2;
                    if(cell.includes('Środa')) dayMap[idx] = 3;
                    if(cell.includes('Czwartek')) dayMap[idx] = 4;
                    if(cell.includes('Piątek')) dayMap[idx] = 5;
                });
            }
        });

        if(headRow === -1) return;

        for(let i=headRow+1; i<data.length; i++) {
            const row = data[i];
            const place = row[0];
            const time = row[1];
            if(!place || !time) continue;
            
            const [start, end] = time.split('-');
            const startMin = timeToMin(start);

            for(const [col, day] of Object.entries(dayMap)) {
                if(row[col]) {
                    const tid = findTeacherId(row[col]);
                    if(tid) {
                        DB.duties.push({
                            teacherId: tid,
                            day: day,
                            time: time.trim(),
                            startMin: startMin,
                            place: place
                        });
                    }
                }
            }
        }
    }

    function parseSub(wb) {
        const sheet = wb.Sheets["Oddziały"] || wb.Sheets[0];
        XLSX.utils.sheet_to_json(sheet).forEach(r => {
            const date = parseDate(r['Dzień']);
            if(!date) return;
            DB.subs.push({
                date: date, 
                periodRaw: r['Lekcja'], 
                absent: findTeacherId(r['Nauczyciel/wakat']),
                sub: findTeacherId(r['Zastępca']),
                subject: r['Przedmiot'],
                room: r['Sala'],
                note: r['Uwagi'],
                rawSub: r['Zastępca']
            });
        });

        const sheetDy = wb.Sheets["Dyżury"];
        if(sheetDy) {
            XLSX.utils.sheet_to_json(sheetDy).forEach(r => {
                 const date = parseDate(r['Dzień']);
                 if(date) {
                     DB.dutyChanges.push({
                         date: date,
                         time: r['Godzina'],
                         absent: findTeacherId(r['Nauczyciel']),
                         sub: findTeacherId(r['Zastępca']),
                         place: r['Miejsce dyżuru']
                     });
                 }
            });
        }
    }

    // === 3. RENDEROWANIE I LOGIKA CZASU ===

    function timeToMin(str) {
        if(!str) return 0;
        const [h,m] = str.trim().split(':').map(Number);
        return h*60+m;
    }

    function parseDate(val) {
        if(!val) return null;
        if(typeof val === 'number') {
            const d = XLSX.SSF.parse_date_code(val);
            return `${d.y}-${pad(d.m)}-${pad(d.d)}`;
        }
        if(typeof val === 'string') {
            const p = val.trim().split('.');
            if(p.length === 3) return `${p[2]}-${p[1]}-${p[0]}`;
        }
        return null;
    }
    function pad(n) { return n<10?'0'+n:n; }
    function getMonday(d) {
        d = new Date(d);
        const day = d.getDay(), diff = d.getDate() - day + (day == 0 ? -6:1);
        return new Date(d.setDate(diff));
    }

    function populateSelect() {
        const sel = document.getElementById('teacher-select');
        sel.innerHTML = "";
        sel.disabled = false;
        const sorted = Object.entries(DB.teachers).sort((a,b) => a[1].name.localeCompare(b[1].name));
        sorted.forEach(([id, t]) => {
            const opt = document.createElement('option');
            opt.value = id;
            opt.innerText = t.name;
            sel.appendChild(opt);
        });
        if(sorted.length) sel.value = sorted[0][0];
    }

    // Główna logika parowania dyżurów z lekcjami
    function render() {
        const tId = document.getElementById('teacher-select').value;
        const dateInput = document.getElementById('date-picker').value;
        const grid = document.getElementById('grid');
        grid.innerHTML = "";

        if(!tId || !dateInput) return;

        const monday = getMonday(dateInput);

        for(let i=0; i<5; i++) {
            const curDate = new Date(monday);
            curDate.setDate(monday.getDate() + i);
            const dateStr = curDate.toISOString().split('T')[0];
            const dayNum = i + 1;

            const col = document.createElement('div');
            col.className = 'day-column';
            col.innerHTML = `<div class="day-header">${DAYS[dayNum]} <span class="day-date">${dateStr}</span></div>`;
            const body = document.createElement('div');
            body.className = 'day-body';

            // KROK 1: Sprawdź czy jest dyżur "poranny" (przed 1 lekcją, czyli < 08:00)
            const morningDuties = getDutiesForTime(tId, dayNum, dateStr, 0, timeToMin("08:00"));
            morningDuties.forEach(md => {
                const mdDiv = document.createElement('div');
                mdDiv.className = 'morning-duty';
                if(md.status==='cancelled') { mdDiv.style.textDecoration='line-through'; mdDiv.style.opacity=0.6; }
                mdDiv.innerHTML = `<b>DYŻUR ${md.time}</b><br>${md.place} ${md.note ? '<br>'+md.note : ''}`;
                body.appendChild(mdDiv);
            });

            // KROK 2: Iteruj po lekcjach
            DB.periods.forEach(period => {
                const slotContainer = document.createElement('div');
                slotContainer.className = 'slot-container';

                // A. KAFELES LEKCJI
                const lessonDiv = document.createElement('div');
                const myLesson = DB.lessons.find(l => l.teacherId === tId && l.day === dayNum && l.period === period.nr);
                
                // Zastępstwa
                const subAbsent = myLesson ? DB.subs.find(s => s.date === dateStr && s.absent === tId && s.periodRaw.startsWith(period.nr + ',')) : null;
                const subAdded = DB.subs.find(s => s.date === dateStr && s.sub === tId && s.periodRaw.startsWith(period.nr + ','));

                if(subAdded) {
                    lessonDiv.className = 'lesson-card is-new';
                    lessonDiv.innerHTML = `
                        <div class="lesson-header"><span class="lesson-nr">${period.nr}</span> <span>${period.start}-${period.end}</span></div>
                        <div class="lesson-title">ZASTĘPSTWO</div>
                        <div class="lesson-loc">za: ${subAdded.rawSub || '?'}</div>
                        <div class="note">${subAdded.subject} - sala ${subAdded.room}</div>
                    `;
                } else if(myLesson) {
                    if(subAbsent) {
                        lessonDiv.className = 'lesson-card is-sub';
                        lessonDiv.innerHTML = `
                            <div class="lesson-header"><span class="lesson-nr">${period.nr}</span> <span>${period.start}-${period.end}</span></div>
                            <div class="lesson-title cancelled-text">${myLesson.subject}</div>
                            <div class="note">Nieobecność (Zast: ${subAbsent.rawSub})</div>
                        `;
                    } else {
                        lessonDiv.className = 'lesson-card';
                        lessonDiv.innerHTML = `
                            <div class="lesson-header"><span class="lesson-nr">${period.nr}</span> <span>${period.start}-${period.end}</span></div>
                            <div class="lesson-title">${myLesson.subject}</div>
                            <div class="lesson-loc">Sala: ${myLesson.room}</div>
                        `;
                    }
                } else {
                    lessonDiv.className = 'lesson-card empty';
                    lessonDiv.innerHTML = `${period.nr}. &nbsp; <small>${period.start}-${period.end}</small>`;
                }
                slotContainer.appendChild(lessonDiv);

                // B. CZY JEST DYŻUR PO TEJ LEKCJI? (W TYM SAMYM SLOT-CONTAINER)
                // Szukamy dyżuru, który zaczyna się w okolicach godziny zakończenia tej lekcji
                const pEndMin = timeToMin(period.end);
                // Margines błędu: -5 min do +15 min od dzwonka
                const breakDuties = getDutiesForTime(tId, dayNum, dateStr, pEndMin - 5, pEndMin + 15);

                breakDuties.forEach(bd => {
                    const dutyDiv = document.createElement('div');
                    dutyDiv.className = 'duty-card';
                    if(bd.status==='cancelled') dutyDiv.style.textDecoration='line-through';
                    
                    let html = `<span class="duty-time">DYŻUR ${bd.time}</span>`;
                    html += `<span class="duty-loc">${bd.place}</span>`;
                    if(bd.note) html += `<span class="note" style="color:red">${bd.note}</span>`;
                    
                    dutyDiv.innerHTML = html;
                    slotContainer.appendChild(dutyDiv);
                });

                body.appendChild(slotContainer);
            });

            col.appendChild(body);
            grid.appendChild(col);
        }
    }

    // Pomocnicza: Szuka dyżurów (stałych i dodanych) w zadanym oknie czasowym (w minutach)
    function getDutiesForTime(teacherId, dayNum, dateStr, rangeStart, rangeEnd) {
        let results = [];

        // 1. Stałe dyżury
        DB.duties.filter(d => d.teacherId === teacherId && d.day === dayNum).forEach(d => {
            if(d.startMin >= rangeStart && d.startMin < rangeEnd) {
                // Sprawdź czy nie odwołany
                const canc = DB.dutyChanges.find(c => c.date === dateStr && c.time === d.time && c.absent === teacherId);
                if(canc) {
                    results.push({ ...d, status: 'cancelled', note: 'Zastępstwo' });
                } else {
                    results.push({ ...d, status: 'ok' });
                }
            }
        });

        // 2. Dodane dyżury (zastępstwa)
        DB.dutyChanges.filter(c => c.date === dateStr && c.sub === teacherId).forEach(c => {
            const startMin = timeToMin(c.time.split('-')[0]);
            if(startMin >= rangeStart && startMin < rangeEnd) {
                results.push({
                    time: c.time,
                    place: c.place,
                    startMin: startMin,
                    status: 'added',
                    note: 'Zastępstwo (Nowe)'
                });
            }
        });

        return results;
    }

</script>

</body>
</html>
