<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interaktywny Plan Lekcji + Dyżury i Zastępstwa</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-color: #f4f6f9;
            --card-bg: #ffffff;
            --primary: #3498db;
            --text: #2c3e50;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --success: #2ecc71;
            --sub-bg: #fff3cd; /* Kolor tła dla zastępstw */
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg-color); color: var(--text); padding: 20px; margin: 0; }
        
        header { text-align: center; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
        select, input { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        button { padding: 10px 20px; background-color: var(--primary); color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #2980b9; }

        #loading { text-align: center; font-size: 1.2em; color: var(--primary); display: none; }
        #error-msg { text-align: center; color: var(--danger); font-weight: bold; margin: 10px 0; }

        .schedule-container { display: grid; grid-gap: 15px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }

        /* Styl kafelka lekcji/dyżuru */
        .slot-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 15px;
            border-left: 5px solid var(--primary);
            position: relative;
        }

        .slot-time { font-weight: bold; color: #7f8c8d; font-size: 0.9em; margin-bottom: 5px; }
        .slot-title { font-size: 1.1em; font-weight: bold; margin-bottom: 5px; }
        .slot-info { font-size: 0.9em; margin-bottom: 3px; }
        
        /* Warianty kafelków */
        .type-duty { border-left-color: var(--warning); background-color: #fffaf0; }
        .type-sub { border-left-color: var(--danger); background-color: var(--sub-bg); }
        .cancelled { text-decoration: line-through; opacity: 0.6; }
        
        .badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; color: white; font-weight: bold;
        }
        .badge-sub { background-color: var(--danger); }
        .badge-duty { background-color: var(--warning); color: #333; }
        .badge-ok { background-color: var(--success); }

        .sub-details {
            margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ccc; color: var(--danger); font-size: 0.9em;
        }
    </style>
</head>
<body>

<header>
    <h1>Pulpit Nauczyciela</h1>
    <p>Plan lekcji zintegrowany z dyżurami i zastępstwami</p>
</header>

<div id="error-msg"></div>

<div class="controls">
    <input type="date" id="date-picker">
    
    <select id="teacher-select">
        <option value="">-- Wybierz Nauczyciela --</option>
    </select>
    
    <button onclick="renderSchedule()">Pokaż Plan</button>
</div>

<div id="loading">Ładowanie danych...</div>
<div id="schedule-box" class="schedule-container"></div>

<script>
    // === KONFIGURACJA PLIKÓW ===
    const FILES = {
        xml: './plan.xml',
        dyzury: './dyzury.xlsx',
        zastepstwa: './zastepstwa.xlsx'
    };

    // Baza danych w pamięci
    const DB = {
        xmlDoc: null,      // sparsowany XML
        periods: [],       // godziny lekcyjne
        teachers: {},      // mapa id -> nazwa
        lessons: [],       // wszystkie lekcje z planu bazowego
        duties: [],        // sparsowane dyżury stałe
        substitutions: [], // sparsowane zastępstwa
        dutyChanges: []    // zmiany w dyżurach
    };

    async function init() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('date-picker').valueAsDate = new Date();

        try {
            await Promise.all([
                fetchXML(),
                fetchExcel(FILES.dyzury, 'dyzury'),
                fetchExcel(FILES.zastepstwa, 'zastepstwa')
            ]);
            
            populateTeacherSelect();
            renderSchedule(); // Pokaż plan dla domyślnej daty/nauczyciela
        } catch (e) {
            showError("Błąd ładowania danych: " + e.message);
            console.error(e);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // --- 1. ŁADOWANIE XML (PLAN BAZOWY) ---
    async function fetchXML() {
        const res = await fetch(FILES.xml);
        if (!res.ok) throw new Error(`Nie znaleziono pliku ${FILES.xml}`);
        const text = await res.text();
        const parser = new DOMParser();
        DB.xmlDoc = parser.parseFromString(text, "text/xml");
        
        parseXMLData();
    }

    function parseXMLData() {
        const xml = DB.xmlDoc;
        
        // 1. Pobierz godziny (Periods)
        const periods = xml.querySelectorAll('periods period');
        periods.forEach(p => {
            DB.periods.push({
                nr: p.getAttribute('period'),
                start: p.getAttribute('starttime'),
                end: p.getAttribute('endtime')
            });
        });

        // 2. Pobierz nauczycieli
        const teachers = xml.querySelectorAll('teachers teacher');
        teachers.forEach(t => {
            // "short" lub "name" jako identyfikator wyświetlany
            DB.teachers[t.getAttribute('id')] = t.getAttribute('name') + " " + t.getAttribute('firstname'); 
        });

        // 3. Pobierz lekcje (Cards)
        // W aSc lekcje są w <cards>. Trzeba połączyć classroom, subject, teacher
        const cards = xml.querySelectorAll('cards card');
        
        // Pomocnicze mapy
        const subjects = {};
        xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));
        const classrooms = {};
        xml.querySelectorAll('classrooms classroom').forEach(c => classrooms[c.getAttribute('id')] = c.getAttribute('name'));

        cards.forEach(card => {
            const lessonId = card.getAttribute('lessonid');
            // Znajdź definicję lekcji, by pobrać nauczyciela i przedmiot
            const lessonNode = xml.querySelector(`lessons lesson[id="${lessonId}"]`);
            if(!lessonNode) return;

            const teacherId = lessonNode.getAttribute('teacherids');
            const subjectId = lessonNode.getAttribute('subjectid');
            const classIds = lessonNode.getAttribute('classids'); // ID klasy (oddziału)

            // Dni są zapisane jako bitmaska np. "10000" (Poniedziałek)
            const daysStr = card.getAttribute('days'); 
            const dayIndex = daysStr.indexOf('1'); // 0 = Poniedziałek
            
            if (dayIndex === -1) return; // Lekcja bez dnia?

            DB.lessons.push({
                dayOfWeek: dayIndex + 1, // 1=Pon, 5=Piątek
                period: card.getAttribute('period'),
                teacherId: teacherId,
                teacherName: DB.teachers[teacherId],
                subject: subjects[subjectId] || 'Inny',
                room: classrooms[card.getAttribute('classroomids')] || '',
                rawDays: daysStr
            });
        });
    }

    // --- 2. ŁADOWANIE EXCEL (DYŻURY I ZASTĘPSTWA) ---
    async function fetchExcel(url, type) {
        const res = await fetch(url);
        if (!res.ok) throw new Error(`Nie znaleziono pliku ${url}`);
        const ab = await res.arrayBuffer();
        const workbook = XLSX.read(ab, {type: 'array'});

        if (type === 'dyzury') parseDuties(workbook);
        if (type === 'zastepstwa') parseSubstitutions(workbook);
    }

    function parseDuties(wb) {
        // Zakładamy, że dyżury są w pierwszym arkuszu lub arkuszu o nazwie 'plan dyżurów'
        const sheetName = wb.SheetNames.find(n => n.includes("plan")) || wb.SheetNames[0];
        const ws = wb.Sheets[sheetName];
        const data = XLSX.utils.sheet_to_json(ws, {header: 1}); // Tablica tablic

        // Szukamy nagłówka z dniami tygodnia
        let headerRowIdx = -1;
        for(let i=0; i<data.length; i++) {
            if(data[i].some(cell => cell && typeof cell === 'string' && cell.includes('Poniedziałek'))) {
                headerRowIdx = i;
                break;
            }
        }

        if(headerRowIdx === -1) {
            console.warn("Nie znaleziono nagłówka dni w pliku dyżurów.");
            return;
        }

        // Mapowanie kolumn na dni (np. kol 2 = Poniedziałek)
        const header = data[headerRowIdx];
        const dayMap = {}; // index kolumny -> numer dnia (1-5)
        header.forEach((val, idx) => {
            if(!val) return;
            if(val.includes('Poniedziałek')) dayMap[idx] = 1;
            if(val.includes('Wtorek')) dayMap[idx] = 2;
            if(val.includes('Środa')) dayMap[idx] = 3;
            if(val.includes('Czwartek')) dayMap[idx] = 4;
            if(val.includes('Piątek')) dayMap[idx] = 5;
        });

        // Iteracja po wierszach poniżej nagłówka
        for(let i = headerRowIdx + 1; i < data.length; i++) {
            const row = data[i];
            const location = row[0]; // Zakładamy: Kol 0 = Miejsce
            const time = row[1];     // Zakładamy: Kol 1 = Czas (np. 07:55-08:00)

            if(!time || !location) continue;

            // Iteruj po kolumnach z dniami
            for (const [colIdx, dayNum] of Object.entries(dayMap)) {
                const teacherRaw = row[colIdx];
                if (teacherRaw && teacherRaw.trim().length > 2 && !teacherRaw.includes("brak dyżuru")) {
                    DB.duties.push({
                        dayOfWeek: dayNum,
                        time: time.trim(),
                        location: location,
                        teacher: teacherRaw.trim()
                    });
                }
            }
        }
    }

    function parseSubstitutions(wb) {
        // Arkusz "Oddziały" - zastępstwa lekcyjne
        const subSheet = wb.Sheets["Oddziały"] || wb.Sheets[Object.keys(wb.Sheets)[0]];
        const subData = XLSX.utils.sheet_to_json(subSheet);

        subData.forEach(row => {
            // Oczekiwane kolumny: "Dzień", "Lekcja", "Nauczyciel/wakat", "Zastępca", "Uwagi"
            // Konwersja daty Excela lub stringa
            let dateStr = row['Dzień']; 
            if(!dateStr) return;
            
            // Proste normalizowanie daty do YYYY-MM-DD
            // Zakładamy format z pliku CSV użytkownika: "08.12.2025"
            // Uwaga: SheetJS może automatycznie zamienić na format daty JS jeśli typ komórki był Date
            
            DB.substitutions.push({
                date: normalizeDate(dateStr),
                lessonInfo: row['Lekcja'], // np. "2, 08:50-09:35"
                teacher: row['Nauczyciel/wakat'],
                substitute: row['Zastępca'],
                note: row['Uwagi'],
                subject: row['Przedmiot'],
                branch: row['Oddział']
            });
        });

        // Arkusz "Dyżury" - zastępstwa na dyżurach
        const dutySheet = wb.Sheets["Dyżury"];
        if(dutySheet) {
            const dutyData = XLSX.utils.sheet_to_json(dutySheet);
            dutyData.forEach(row => {
                DB.dutyChanges.push({
                    date: normalizeDate(row['Dzień']),
                    time: row['Godzina'],
                    originalTeacher: row['Nauczyciel'],
                    newTeacher: row['Zastępca'],
                    location: row['Miejsce dyżuru']
                });
            });
        }
    }

    // --- POMOCNICZE ---
    function normalizeDate(val) {
        if (!val) return "";
        // Jeśli Excel zwróci liczbę (serial date)
        if (typeof val === 'number') {
            const date = XLSX.SSF.parse_date_code(val);
            return `${date.y}-${String(date.m).padStart(2,'0')}-${String(date.d).padStart(2,'0')}`;
        }
        // Jeśli string "08.12.2025"
        if (val.includes('.')) {
            const parts = val.split('.');
            return `${parts[2]}-${parts[1]}-${parts[0]}`; // YYYY-MM-DD
        }
        return val;
    }

    function populateTeacherSelect() {
        const select = document.getElementById('teacher-select');
        const sortedTeachers = Object.values(DB.teachers).sort();
        
        // Używamy Set aby uniknąć duplikatów
        const uniqueTeachers = [...new Set(sortedTeachers)];

        uniqueTeachers.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t;
            opt.textContent = t;
            select.appendChild(opt);
        });
    }

    function showError(msg) {
        document.getElementById('error-msg').innerText = msg;
    }

    // --- 3. RENDEROWANIE (LOGIKA ŁĄCZENIA) ---
    function renderSchedule() {
        const container = document.getElementById('schedule-box');
        container.innerHTML = '';

        const selectedDateVal = document.getElementById('date-picker').value;
        const selectedTeacher = document.getElementById('teacher-select').value;

        if (!selectedDateVal || !selectedTeacher) {
            return;
        }

        const selectedDate = new Date(selectedDateVal);
        const dayOfWeek = selectedDate.getDay(); // 1=Poniedziałek
        const dateStr = selectedDateVal; // YYYY-MM-DD

        if (dayOfWeek === 0 || dayOfWeek === 6) {
            container.innerHTML = '<p>Wybrano weekend. Brak planu lekcji.</p>';
            return;
        }

        // 1. Pobierz lekcje z planu XML dla tego nauczyciela i dnia
        // Uwaga: W pliku XML nauczyciele mają ID, a w Excelu Imię Nazwisko.
        // Musimy dopasować te dane.
        // Znajdź ID nauczyciela na podstawie nazwy (proste wyszukiwanie)
        let teacherId = Object.keys(DB.teachers).find(key => {
            const nameInXml = DB.teachers[key]; // "Kowalski Jan"
            // Proste porównanie (można ulepszyć np. fuzzy search)
            return compareNames(nameInXml, selectedTeacher);
        });

        // KROK 1: PLAN BAZOWY
        let dayLessons = DB.lessons.filter(l => 
            l.dayOfWeek === dayOfWeek && 
            l.teacherId === teacherId
        );

        // Sortuj wg lekcji
        dayLessons.sort((a,b) => parseInt(a.period) - parseInt(b.period));

        // Przygotuj sloty czasowe (wszystkie lekcje + dyżury)
        // Musimy przeiterować przez wszystkie okresy lekcyjne, żeby pokazać też "okienka" jeśli jest dyżur
        const allEvents = [];

        DB.periods.forEach(p => {
            // Sprawdź czy jest lekcja
            const lesson = dayLessons.find(l => l.period === p.nr);
            
            // Sprawdź zastępstwo LEKCYJNE
            // W zastępstwach szukamy po nazwisku, nie ID
            let sub = DB.substitutions.find(s => 
                s.date === dateStr && 
                compareNames(s.teacher, selectedTeacher) &&
                s.lessonInfo.startsWith(p.nr + ",") // Format "2, 08:50..."
            );
            
            // Może nauczyciel jest "Zastępcą" (ma dodaną lekcję)?
            let addedSub = DB.substitutions.find(s =>
                s.date === dateStr &&
                compareNames(s.substitute, selectedTeacher) &&
                s.lessonInfo.startsWith(p.nr + ",")
            );

            // Sprawdź DYŻUR (przerwa po lekcji lub przed)
            // Zakładamy mapowanie czasu dyżuru na przerwy
            // Dyżury w pliku mają format "07:55-08:00". Musimy dopasować je do slotów.
            // Dla uproszczenia wyświetlimy dyżury jako osobne kafelki posortowane po czasie.
        });

        // Alternatywne podejście: Zbieramy listę obiektów {timeStart, type, content} i sortujemy
        let timeline = [];

        // A. Dodaj lekcje bazowe
        dayLessons.forEach(l => {
            const p = DB.periods.find(per => per.nr === l.period);
            timeline.push({
                type: 'lesson',
                start: p.start,
                end: p.end,
                periodNr: l.period,
                data: l,
                original: true
            });
        });

        // B. Przetwórz zastępstwa (usuń/zmodyfikuj bazowe, dodaj nowe)
        // 1. Anulowania i zmiany dla aktualnego nauczyciela
        const mySubs = DB.substitutions.filter(s => s.date === dateStr && compareNames(s.teacher, selectedTeacher));
        mySubs.forEach(sub => {
            const nr = sub.lessonInfo.split(',')[0];
            const existingIdx = timeline.findIndex(t => t.type === 'lesson' && t.periodNr == nr);
            
            if (existingIdx > -1) {
                // Modyfikacja istniejącej lekcji
                timeline[existingIdx].subInfo = sub;
                timeline[existingIdx].status = 'cancelled_or_changed';
            }
        });

        // 2. Dodane lekcje (gdzie nauczyciel jest zastępcą)
        const imSub = DB.substitutions.filter(s => s.date === dateStr && compareNames(s.substitute, selectedTeacher));
        imSub.forEach(sub => {
            const nr = sub.lessonInfo.split(',')[0];
            // Znajdź godziny dla tego numeru lekcji
            const p = DB.periods.find(per => per.nr == nr);
            if(p) {
                timeline.push({
                    type: 'lesson',
                    start: p.start,
                    end: p.end,
                    periodNr: nr,
                    subData: sub, // To jest zastępstwo
                    status: 'added'
                });
            }
        });

        // C. Dodaj Dyżury
        // 1. Stałe dyżury
        const myDuties = DB.duties.filter(d => d.dayOfWeek === dayOfWeek && compareNames(d.teacher, selectedTeacher));
        myDuties.forEach(d => {
            timeline.push({
                type: 'duty',
                start: d.time.split('-')[0], // Uproszczone sortowanie
                time: d.time,
                location: d.location,
                original: true
            });
        });

        // 2. Zmiany w dyżurach (zastepstwa.xlsx - Dyżury)
        // Jeśli ja mam dyżur, ale ktoś mnie zastępuje -> anuluj mój
        const dutyCancelled = DB.dutyChanges.filter(dc => dc.date === dateStr && compareNames(dc.originalTeacher, selectedTeacher));
        
        // Jeśli ja zastępuję kogoś -> dodaj nowy dyżur
        const dutyAdded = DB.dutyChanges.filter(dc => dc.date === dateStr && compareNames(dc.newTeacher, selectedTeacher));

        // Aplikuj zmiany dyżurów
        timeline.forEach(item => {
            if(item.type === 'duty') {
                const isCanc = dutyCancelled.find(dc => dc.time === item.time);
                if(isCanc) {
                    item.status = 'cancelled';
                    item.subInfo = isCanc;
                }
            }
        });

        dutyAdded.forEach(da => {
            timeline.push({
                type: 'duty',
                start: da.time.split('-')[0],
                time: da.time,
                location: da.location,
                status: 'added',
                subInfo: da
            });
        });

        // SORTOWANIE CAŁOŚCI PO GODZINIE
        timeline.sort((a, b) => {
            return a.start.localeCompare(b.start);
        });

        // RENDEROWANIE DO HTML
        if(timeline.length === 0) {
            container.innerHTML = "<p>Brak lekcji i dyżurów w tym dniu.</p>";
            return;
        }

        timeline.forEach(item => {
            const el = document.createElement('div');
            el.className = 'slot-card';
            
            if (item.type === 'lesson') {
                let html = `<div class="slot-time">Lekcja ${item.periodNr} (${item.start} - ${item.end})</div>`;
                
                if (item.status === 'added') {
                    // Dodana lekcja (zastępstwo za kogoś)
                    el.classList.add('type-sub');
                    html += `<div class="slot-title">Zastępstwo za: ${item.subData.teacher}</div>`;
                    html += `<div class="slot-info">Klasa: ${item.subData.branch || '?'} | Sala: ?</div>`;
                    html += `<div class="sub-details">Przedmiot: ${item.subData.subject} <br> ${item.subData.note || ''}</div>`;
                } else {
                    // Zwykła lekcja (być może odwołana)
                    const lesson = item.data;
                    const isCancelled = item.subInfo && !item.subInfo.substitute; // Jeśli brak zastępcy w wierszu, to często odwołane
                    const isChanged = item.subInfo && item.subInfo.substitute;
                    
                    if (isCancelled) el.classList.add('cancelled');
                    if (isChanged) el.classList.add('type-sub');

                    html += `<div class="slot-title">${lesson.subject}</div>`;
                    html += `<div class="slot-info">Klasa: ? | Sala: ${lesson.room}</div>`;

                    if (item.subInfo) {
                         html += `<div class="sub-details">
                            <span class="badge badge-sub">ZMIANA</span> 
                            ${item.subInfo.note || 'Zastępstwo'} 
                            ${item.subInfo.substitute ? '-> ' + item.subInfo.substitute : ''}
                         </div>`;
                    }
                }
                el.innerHTML = html;

            } else if (item.type === 'duty') {
                el.classList.add('type-duty');
                let html = `<div class="slot-time">DYŻUR: ${item.time}</div>`;
                
                if (item.status === 'cancelled') {
                    el.classList.add('cancelled');
                    html += `<div class="slot-title">${item.location}</div>`;
                    html += `<div class="sub-details">Zastępstwo: ${item.subInfo.newTeacher}</div>`;
                } else if (item.status === 'added') {
                    html += `<div class="slot-title">${item.location}</div>`;
                    html += `<div class="sub-details"><span class="badge badge-sub">NOWY</span> Za: ${item.subInfo.originalTeacher}</div>`;
                } else {
                    html += `<div class="slot-title">${item.location}</div>`;
                    html += `<span class="badge badge-duty">Twój dyżur</span>`;
                }
                el.innerHTML = html;
            }
            
            container.appendChild(el);
        });
    }

    // Funkcja pomocnicza do porównywania nazwisk (np. "Kowalski Jan" vs "Jan Kowalski" vs "Kowalski J.")
    function compareNames(n1, n2) {
        if(!n1 || !n2) return false;
        // Uproszczone: sprawdzamy czy jedno nazwisko zawiera się w drugim (case insensitive)
        const a = n1.toLowerCase().replace(',', '').split(' ');
        const b = n2.toLowerCase().replace(',', '').split(' ');
        
        // Sprawdź czy jakakolwiek część nazwiska (np. Kowalski) występuje w obu
        const surnameA = a[0].length > 2 ? a[0] : a[1];
        const surnameB = b[0].length > 2 ? b[0] : b[1];
        
        return n1.toLowerCase().includes(surnameB) || n2.toLowerCase().includes(surnameA);
    }

    // Start
    init();

</script>

</body>
</html>
