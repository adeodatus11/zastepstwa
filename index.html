<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan Tygodniowy Nauczyciela</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f4f7f6;
            --header-bg: #fff;
            --card-bg: #ffffff;
            --primary: #3498db;
            --primary-dark: #2980b9;
            --text: #2c3e50;
            --border: #e0e0e0;
            --lesson-border: #3498db;
            --duty-border: #f1c40f;
            --sub-border: #e74c3c;
            --new-border: #2ecc71;
            --duty-bg: #fffcf0;
            --sub-bg: #fff5f5;
        }

        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 0; color: var(--text); }
        
        /* HEADER */
        header { background: var(--header-bg); padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        h1 { margin: 0; font-size: 1.2rem; color: var(--primary-dark); }
        
        .controls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        select, input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9rem; }
        button { padding: 8px 15px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:hover { background: var(--primary-dark); }

        #status-bar { text-align: center; font-size: 0.8rem; padding: 5px; background: #eee; display: none; }
        #status-bar.show { display: block; }

        /* GRID TYGODNIOWY */
        .week-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* 5 równych kolumn */
            gap: 10px;
            padding: 20px;
            align-items: start;
        }

        /* KOLUMNA DNIA */
        .day-column {
            background: #eef2f3;
            border-radius: 8px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .day-header {
            background: var(--primary-dark);
            color: white;
            padding: 10px;
            text-align: center;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
        }
        .day-date { font-size: 0.8rem; opacity: 0.8; font-weight: normal; display: block; margin-top: 2px; }

        .day-content { padding: 10px; display: flex; flex-direction: column; gap: 10px; }

        /* KAFELEK LEKCJI/DYŻURU */
        .card {
            background: var(--card-bg);
            border-radius: 6px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border-left: 4px solid var(--border);
            position: relative;
            font-size: 0.9rem;
        }

        .card-time { font-weight: bold; color: #7f8c8d; font-size: 0.8em; margin-bottom: 4px; display: flex; justify-content: space-between; }
        .card-nr { background: #eee; padding: 1px 5px; border-radius: 3px; color: #555; }
        
        .card-title { font-weight: bold; margin-bottom: 2px; color: #333; }
        .card-info { font-size: 0.85em; color: #666; }
        .card-note { font-size: 0.8em; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #eee; font-style: italic; }

        /* TYPY KAFELKÓW */
        .type-lesson { border-left-color: var(--lesson-border); }
        .type-duty { border-left-color: var(--duty-border); background-color: var(--duty-bg); }
        .type-sub { border-left-color: var(--sub-border); background-color: var(--sub-bg); }
        .type-added { border-left-color: var(--new-border); }
        
        .cancelled { text-decoration: line-through; opacity: 0.6; }
        
        .badge { font-size: 0.7em; padding: 2px 4px; border-radius: 3px; color: white; vertical-align: middle; margin-right: 4px; }
        .bg-sub { background: var(--sub-border); }
        .bg-new { background: var(--new-border); }
        .bg-duty { background: var(--duty-border); color: #333; }

        .empty-msg { text-align: center; color: #999; font-size: 0.8rem; padding: 20px 0; font-style: italic; }

        /* RESPANSYWNOŚĆ - Na telefonie kolumny jedna pod drugą */
        @media (max-width: 800px) {
            .week-container { grid-template-columns: 1fr; }
            header { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>

<header>
    <h1>Plan Tygodniowy</h1>
    <div class="controls">
        <input type="date" id="date-picker" title="Wybierz dowolny dzień w tygodniu">
        <select id="teacher-select" disabled>
            <option>Ładowanie bazy...</option>
        </select>
        <button onclick="renderWeek()">Pokaż</button>
    </div>
</header>

<div id="status-bar"></div>

<div class="week-container" id="week-grid">
    </div>

<script>
    // === KONFIGURACJA PLIKÓW ===
    const CONFIG = {
        xmlUrl: './plan.xml',
        dyzuryUrl: './dyzury.xlsx',
        zastepstwaUrl: './zastepstwa.xlsx'
    };

    // Baza danych w pamięci
    const DB = {
        teachers: {}, 
        periods: [],  
        lessons: [],  
        duties: [],   
        substitutions: [], 
        dutyChanges: []    
    };

    const DAYS_PL = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];

    // === START ===
    window.onload = async () => {
        document.getElementById('date-picker').valueAsDate = new Date();
        setStatus("Ładowanie plików...");
        
        try {
            await Promise.all([
                loadXML(),
                loadExcel(CONFIG.dyzuryUrl, 'dyzury'),
                loadExcel(CONFIG.zastepstwaUrl, 'zastepstwa')
            ]);
            
            populateSelect();
            setStatus("");
        } catch (e) {
            console.error(e);
            setStatus("Błąd: " + e.message, true);
        }
    };

    function setStatus(msg, isError = false) {
        const el = document.getElementById('status-bar');
        el.textContent = msg;
        el.style.color = isError ? 'red' : 'black';
        el.className = msg ? 'show' : '';
    }

    // === 1. SILNIK FUZZY MATCHING (BEZ ZMIAN) ===
    function normalizeString(str) {
        if (!str) return "";
        return str.toString().toLowerCase()
            .replace(/^(x\.|ks\.|p\.|pani|pan)\s+/g, '')
            .replace(/[^a-złąceźżńóś\s]/g, '')
            .trim()
            .split(/\s+/)
            .sort()
            .join(' ');
    }

    function levenshtein(a, b) {
        const matrix = [];
        for(let i=0; i<=b.length; i++) matrix[i] = [i];
        for(let j=0; j<=a.length; j++) matrix[0][j] = j;
        for(let i=1; i<=b.length; i++){
            for(let j=1; j<=a.length; j++){
                if(b.charAt(i-1) == a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1];
                else matrix[i][j] = Math.min(matrix[i-1][j-1]+1, Math.min(matrix[i][j-1]+1, matrix[i-1][j]+1));
            }
        }
        return matrix[b.length][a.length];
    }

    function findTeacherId(rawName) {
        if (!rawName || rawName.length < 3) return null;
        if (rawName.toLowerCase().match(/wakat|brak|okienko/)) return null;

        const target = normalizeString(rawName);
        let bestId = null, minDistance = 100;

        for (const [id, tData] of Object.entries(DB.teachers)) {
            const source = tData.normalized;
            if (source === target) return id;
            if (target.length > 4 && (source.includes(target) || target.includes(source))) {
                if (minDistance > 1) { minDistance = 1; bestId = id; }
            }
            const dist = levenshtein(source, target);
            const threshold = source.length > 5 ? 3 : 1;
            if (dist < minDistance && dist <= threshold) { minDistance = dist; bestId = id; }
        }
        return bestId;
    }

    // === 2. ŁADOWANIE DANYCH ===
    async function loadXML() {
        const resp = await fetch(CONFIG.xmlUrl);
        if(!resp.ok) throw new Error("Brak pliku plan.xml");
        const txt = await resp.text();
        const xml = new DOMParser().parseFromString(txt, "text/xml");

        xml.querySelectorAll('teachers teacher').forEach(t => {
            const id = t.getAttribute('id');
            const fname = t.getAttribute('firstname') || '';
            const lname = t.getAttribute('lastname') || t.getAttribute('name');
            DB.teachers[id] = {
                name: `${fname} ${lname}`.trim(),
                normalized: normalizeString(`${fname} ${lname}`)
            };
        });

        xml.querySelectorAll('periods period').forEach(p => {
            DB.periods.push({ nr: p.getAttribute('period'), start: p.getAttribute('starttime'), end: p.getAttribute('endtime') });
        });

        const subjects = {};
        xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));
        const rooms = {};
        xml.querySelectorAll('classrooms classroom').forEach(r => rooms[r.getAttribute('id')] = r.getAttribute('name'));

        xml.querySelectorAll('cards card').forEach(c => {
            const lNode = xml.querySelector(`lessons lesson[id="${c.getAttribute('lessonid')}"]`);
            if (!lNode) return;
            const tId = lNode.getAttribute('teacherids');
            const days = c.getAttribute('days'); 
            const dayIdx = days.indexOf('1') + 1;
            if (dayIdx > 0 && tId) {
                DB.lessons.push({
                    teacherId: tId,
                    day: dayIdx,
                    period: c.getAttribute('period'),
                    subject: subjects[lNode.getAttribute('subjectid')] || 'Lekcja',
                    room: rooms[c.getAttribute('classroomids')] || ''
                });
            }
        });
    }

    async function loadExcel(url, type) {
        const resp = await fetch(url);
        if(!resp.ok) throw new Error("Brak pliku " + url);
        const ab = await resp.arrayBuffer();
        const wb = XLSX.read(ab, {type: 'array'});
        if(type==='dyzury') parseDuties(wb);
        if(type==='zastepstwa') parseSubstitutions(wb);
    }

    function parseDuties(wb) {
        const sheet = wb.Sheets[wb.SheetNames.find(n => n.includes('plan')) || wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
        let headRow = -1;
        const dayMap = {};
        
        for(let i=0; i<data.length; i++) {
            if(data[i].some(c => typeof c==='string' && c.includes('Poniedziałek'))) {
                headRow = i; 
                data[i].forEach((v, idx) => {
                    if(!v) return;
                    if(v.includes('Poniedziałek')) dayMap[idx]=1;
                    if(v.includes('Wtorek')) dayMap[idx]=2;
                    if(v.includes('Środa')) dayMap[idx]=3;
                    if(v.includes('Czwartek')) dayMap[idx]=4;
                    if(v.includes('Piątek')) dayMap[idx]=5;
                });
                break;
            }
        }
        if(headRow === -1) return;

        for(let i=headRow+1; i<data.length; i++) {
            const r = data[i];
            const place = r[0]; 
            const time = r[1];
            if(!time || !place) continue;
            for(const [col, day] of Object.entries(dayMap)) {
                if(r[col] && r[col].length > 2) {
                    const tid = findTeacherId(r[col]);
                    if(tid) DB.duties.push({ teacherId: tid, day: day, time: time.trim(), place: place });
                }
            }
        }
    }

    function parseSubstitutions(wb) {
        const sSub = wb.Sheets["Oddziały"] || wb.Sheets[0];
        XLSX.utils.sheet_to_json(sSub).forEach(r => {
            const d = normalizeDate(r['Dzień']);
            if(d) DB.substitutions.push({
                date: d,
                periodInfo: r['Lekcja'],
                absentId: findTeacherId(r['Nauczyciel/wakat']),
                subId: findTeacherId(r['Zastępca']),
                subject: r['Przedmiot'],
                branch: r['Oddział'],
                note: r['Uwagi'],
                rawSub: r['Zastępca']
            });
        });

        const sDuty = wb.Sheets["Dyżury"];
        if(sDuty) {
            XLSX.utils.sheet_to_json(sDuty).forEach(r => {
                const d = normalizeDate(r['Dzień']);
                if(d) DB.dutyChanges.push({
                    date: d,
                    time: r['Godzina'],
                    absentId: findTeacherId(r['Nauczyciel']),
                    subId: findTeacherId(r['Zastępca']),
                    place: r['Miejsce dyżuru']
                });
            });
        }
    }

    function normalizeDate(val) {
        if(!val) return null;
        if(typeof val === 'number') {
            const d = XLSX.SSF.parse_date_code(val);
            return `${d.y}-${pad(d.m)}-${pad(d.d)}`;
        }
        if(typeof val === 'string') {
            const p = val.trim().split('.');
            if(p.length === 3) return `${p[2]}-${p[1]}-${p[0]}`;
        }
        return null;
    }
    function pad(n) { return n < 10 ? '0'+n : n; }

    function populateSelect() {
        const sel = document.getElementById('teacher-select');
        sel.innerHTML = '<option value="">-- Wybierz Nauczyciela --</option>';
        sel.disabled = false;
        Object.entries(DB.teachers)
            .sort((a,b) => a[1].name.localeCompare(b[1].name))
            .forEach(([id, t]) => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = t.name;
                sel.appendChild(opt);
            });
    }

    // === 3. RENDEROWANIE TYGODNIA ===

    // Pomoc: Znajdź datę poniedziałku dla wybranego dnia
    function getMonday(d) {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6 : 1); 
        return new Date(d.setDate(diff));
    }

    function formatDate(d) {
        return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    function renderWeek() {
        const tId = document.getElementById('teacher-select').value;
        const rawDate = document.getElementById('date-picker').value;
        const grid = document.getElementById('week-grid');
        grid.innerHTML = '';

        if(!tId || !rawDate) return;

        const monday = getMonday(rawDate);

        // Pętla przez 5 dni tygodnia (Pon-Pt)
        for (let i = 0; i < 5; i++) {
            const currentObj = new Date(monday);
            currentObj.setDate(monday.getDate() + i);
            const dateStr = formatDate(currentObj);
            const dayNum = i + 1; // 1=Pon

            // Stwórz kolumnę
            const col = document.createElement('div');
            col.className = 'day-column';
            col.innerHTML = `
                <div class="day-header">
                    ${DAYS_PL[dayNum]}
                    <span class="day-date">${dateStr}</span>
                </div>
                <div class="day-content" id="content-${dayNum}"></div>
            `;
            grid.appendChild(col);

            const contentBox = col.querySelector('.day-content');
            const events = getEventsForDay(tId, dayNum, dateStr);

            if (events.length === 0) {
                contentBox.innerHTML = '<div class="empty-msg">Brak zajęć</div>';
            } else {
                events.forEach(ev => contentBox.appendChild(createCard(ev)));
            }
        }
    }

    // Pobiera i przetwarza zdarzenia dla jednego dnia
    function getEventsForDay(tId, dayNum, dateStr) {
        let events = [];

        // 1. Lekcje bazowe
        DB.lessons.filter(l => l.teacherId === tId && l.day === dayNum).forEach(l => {
            const p = DB.periods.find(p => p.nr == l.period);
            events.push({
                type: 'lesson',
                sortTime: p.start,
                period: l.period,
                time: `${p.start}-${p.end}`,
                title: l.subject,
                subtitle: `Sala: ${l.room}`,
                original: true
            });
        });

        // 2. Dyżury stałe
        DB.duties.filter(d => d.teacherId === tId && d.day === dayNum).forEach(d => {
            events.push({
                type: 'duty',
                sortTime: d.time.split('-')[0].trim(),
                time: d.time,
                title: 'DYŻUR',
                subtitle: d.place,
                original: true
            });
        });

        // 3. Zastępstwa (Lekcje)
        // A. Jestem nieobecny
        DB.substitutions.filter(s => s.date === dateStr && s.absentId === tId).forEach(sub => {
            const nr = sub.periodInfo.split(',')[0];
            const ev = events.find(e => e.type === 'lesson' && e.period == nr);
            if(ev) {
                ev.status = 'cancelled';
                ev.subInfo = `Zastępca: ${sub.rawSub || 'Brak'}`;
                ev.note = sub.note;
                ev.typeOverride = 'sub'; // Zmiana koloru
            }
        });

        // B. Zastępuję kogoś
        DB.substitutions.filter(s => s.date === dateStr && s.subId === tId).forEach(sub => {
            const parts = sub.periodInfo.split(',');
            const nr = parts[0].trim();
            const timeRange = parts[1] ? parts[1].trim() : "";
            const startTime = timeRange.split('-')[0] || "00:00";
            
            // Spróbuj znaleźć godziny jeśli timeRange pusty
            let pTime = timeRange;
            if(!pTime) {
                const p = DB.periods.find(x => x.nr == nr);
                if(p) { pTime = `${p.start}-${p.end}`; startTime = p.start; }
            }

            events.push({
                type: 'added',
                sortTime: startTime,
                period: nr,
                time: pTime,
                title: `ZASTĘPSTWO`,
                subtitle: `${sub.subject} (${sub.branch})`,
                note: sub.note
            });
        });

        // 4. Zmiany dyżurów
        // A. Odwołane moje
        DB.dutyChanges.filter(dc => dc.date === dateStr && dc.absentId === tId).forEach(dc => {
            const ev = events.find(e => e.type === 'duty' && e.time === dc.time);
            if(ev) {
                ev.status = 'cancelled';
                ev.subInfo = "Dyżur odwołany/zastępowany";
            }
        });

        // B. Dodane (zastępuję kogoś)
        DB.dutyChanges.filter(dc => dc.date === dateStr && dc.subId === tId).forEach(dc => {
            events.push({
                type: 'duty',
                sortTime: dc.time.split('-')[0],
                time: dc.time,
                title: 'DYŻUR (ZA KOGOŚ)',
                subtitle: dc.place,
                typeOverride: 'added'
            });
        });

        return events.sort((a,b) => a.sortTime.localeCompare(b.sortTime));
    }

    function createCard(ev) {
        const div = document.createElement('div');
        let cls = ['card'];
        
        // Ustalanie klasy CSS
        if (ev.typeOverride) {
            if (ev.typeOverride === 'sub') cls.push('type-sub');
            if (ev.typeOverride === 'added') cls.push('type-added');
        } else {
            if (ev.type === 'lesson') cls.push('type-lesson');
            if (ev.type === 'duty') cls.push('type-duty');
            if (ev.type === 'added') cls.push('type-added');
        }
        if (ev.status === 'cancelled') cls.push('cancelled');
        
        div.className = cls.join(' ');

        let html = `<div class="card-time">`;
        if(ev.period) html += `<span class="card-nr">${ev.period}</span>`;
        html += `<span>${ev.time}</span></div>`;

        html += `<div class="card-title">${ev.title}</div>`;
        html += `<div class="card-info">${ev.subtitle}</div>`;

        if (ev.subInfo) {
            html += `<div class="card-note" style="color:red; font-weight:bold">${ev.subInfo}</div>`;
        }
        if (ev.note) {
            html += `<div class="card-note">${ev.note}</div>`;
        }

        div.innerHTML = html;
        return div;
    }

</script>
</body>
</html>
