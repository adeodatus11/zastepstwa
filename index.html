<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan lekcji - Panel Kiosk</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg: #f3f4f6;
            --header-bg: #111827;
            --text-main: #1f2937;
            --card-bg: #ffffff;
            --accent: #2563eb;
            
            /* Kolory kafelków menu */
            --tile-teacher: #e0f2fe; --tile-teacher-hover: #bae6fd; --tile-teacher-text: #0369a1;
            --tile-room: #f3e8ff; --tile-room-hover: #e9d5ff; --tile-room-text: #7e22ce;
            --tile-class: #fce7f3; --tile-class-hover: #fbcfe8; --tile-class-text: #be185d;

            /* Paski boczne planu */
            --lesson-border: #3b82f6; 
            --room-border: #8b5cf6;    
            --class-border: #ec4899;   
            --loc-border: #f59e0b;     
            
            /* Statusy */
            --sub-bg: #fee2e2; --sub-color: #991b1b; --sub-border: #f87171; 
            --new-bg: #dcfce7; --new-color: #14532d; --new-border: #22c55e; 
            
            /* Dyżury */
            --duty-bg: #fef3c7; --duty-color: #92400e; --duty-border: #fcd34d;
            --duty-sub-bg: #ccff33; --duty-sub-border: #a3d700; --duty-sub-color: #000;

            --empty: #f9fafb;
        }

        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; padding: 0; 
            color: var(--text-main);
            display: flex; flex-direction: column;
            min-height: 100vh;
        }

        /* --- NAGŁÓWEK --- */
        header { 
            background: var(--header-bg); color: white; padding: 10px 20px; 
            position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
            display: flex; justify-content: space-between; align-items: center;
            min-height: 70px;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { height: 55px; width: auto; }
        .header-text h1 { margin: 0; font-size: 1.4rem; font-weight: 600; }
        .clock { font-family: monospace; font-size: 1.1rem; color: #9ca3af; margin-top: 4px; }

        .controls { display: flex; gap: 10px; align-items: center; }
        button.back-btn {
            background: #dc2626; color: white; border: none; padding: 10px 25px; 
            border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 1.1rem;
            display: flex; align-items: center; gap: 8px;
        }
        button.back-btn:hover { background: #b91c1c; }

        #debug-bar { 
            background: #e5e7eb; font-size: 0.75rem; padding: 4px 20px; color: #4b5563; 
            border-bottom: 1px solid #d1d5db; text-align: center;
        }

        /* --- DASHBOARD (KAFELKI) --- */
        #dashboard-view { padding: 30px; display: block; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .section-title { 
            font-size: 1.8rem; font-weight: 800; color: #374151; margin: 30px 0 15px 0; 
            border-bottom: 2px solid #e5e7eb; padding-bottom: 10px;
        }
        .section-title:first-child { margin-top: 0; }

        .tile-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); 
            gap: 15px;
        }

        .tile {
            padding: 20px 10px;
            text-align: center;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 1.25rem; 
            font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            min-height: 80px;
            border: 1px solid rgba(0,0,0,0.05);
        }
        .tile:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .tile:active { transform: scale(0.98); }

        .tile.teacher { background: var(--tile-teacher); color: var(--tile-teacher-text); border-bottom: 4px solid var(--tile-teacher-text); }
        .tile.teacher:hover { background: var(--tile-teacher-hover); }

        .tile.room { background: var(--tile-room); color: var(--tile-room-text); border-bottom: 4px solid var(--tile-room-text); }
        .tile.room:hover { background: var(--tile-room-hover); }

        .tile.class { background: var(--tile-class); color: var(--tile-class-text); border-bottom: 4px solid var(--tile-class-text); }
        .tile.class:hover { background: var(--tile-class-hover); }


        /* --- WIDOK PLANU --- */
        #schedule-view { display: none; width: 100%; }
        
        .week-container {
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 15px; padding: 20px; align-items: start;
        }
        .day-col {
            background: #fff; border-radius: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: flex; flex-direction: column;
        }
        .day-header {
            background: #f3f4f6; color: #374151; padding: 12px; 
            text-align: center; font-weight: 700; border-bottom: 1px solid #e5e7eb;
            border-top-left-radius: 10px; border-top-right-radius: 10px;
            position: sticky; top: 90px; z-index: 900;
        }
        .day-date { font-weight: 400; font-size: 0.8em; color: #6b7280; display: block; margin-top: 2px; }
        .day-content { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Slot wrapper może teraz zawierać wiele kart (grup) */
        .slot-wrapper { 
            border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; 
            display: flex; flex-direction: column; gap: 0px; /* Karty pod sobą bez odstępu, oddzielone borderem */
        }

        /* KAFELKI LEKCJI */
        .card {
            background: var(--card-bg); border-left: 4px solid var(--lesson-border);
            padding: 8px 10px; min-height: 45px; display: flex; flex-direction: column; gap: 2px;
            border-bottom: 1px solid #e5e7eb;
            position: relative;
        }
        .card:last-child { border-bottom: none; }

        .card.empty {
            background: var(--empty); border-left-color: #d1d5db; color: #9ca3af;
            display: flex; align-items: center; justify-content: center; font-style: italic; font-size: 0.85rem;
            min-height: 40px;
        }
        body.mode-room .card { border-left-color: var(--room-border); }
        body.mode-class .card { border-left-color: var(--class-border); }

        .meta { display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280; margin-bottom: 2px; font-weight: 600; }
        .nr { background: #f3f4f6; padding: 1px 6px; border-radius: 4px; color: #374151; }
        .main-info { font-weight: 700; font-size: 0.95rem; }
        .sub-line { font-weight: 600; font-size: 0.85rem; color: #111827; }
        
        /* Oznaczenie grupy */
        .group-badge {
            display: inline-block;
            background: #e5e7eb;
            color: #374151;
            font-size: 0.7rem;
            padding: 1px 5px;
            border-radius: 4px;
            margin-left: 5px;
            font-weight: normal;
            vertical-align: middle;
            border: 1px solid #d1d5db;
        }

        .is-sub { background: var(--sub-bg); border-left-color: var(--sub-border) !important; }
        .is-sub .main-info { text-decoration: line-through; opacity: 0.7; }
        .note-red { color: var(--sub-color); font-weight: 600; font-size: 0.8rem; }
        .is-new { background: var(--new-bg); border-left-color: var(--new-border) !important; }

        /* DYŻURY W PLANIE */
        .duty-section {
            background: var(--duty-bg); color: var(--duty-color);
            border-top: 1px dashed var(--duty-border); padding: 6px 10px; font-size: 0.8rem;
        }
        .morning-duty {
            background: var(--duty-bg); border-left: 4px solid #f59e0b;
            padding: 10px; border-radius: 8px; margin-bottom: 5px;
            color: var(--duty-color); font-size: 0.85rem;
        }

        footer {
            background: var(--header-bg); color: #9ca3af; text-align: center;
            padding: 20px; font-size: 0.85rem; border-top: 1px solid #374151;
            margin-top: auto;
        }
        footer a { color: #d1d5db; text-decoration: none; font-weight: bold; }

        @media (max-width: 900px) { .week-container { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="orzeł.png" alt="ZSZ5 Logo" class="logo" onerror="this.style.display='none'">
        <div class="header-text">
            <h1>Plan lekcji - ZSZ5</h1>
            <div id="clock" class="clock">--:--</div>
        </div>
    </div>
    
    <div class="controls" id="nav-controls" style="display:none">
        <select id="mode-select" style="display:none"><option value="teacher">Nauczyciel</option><option value="class">Oddział</option><option value="room">Sala</option></select>
        <select id="data-select" style="display:none"></select>
        
        <button class="back-btn" onclick="returnToDashboard()">
            <span>&#8617;</span> MENU GŁÓWNE
        </button>
    </div>
</header>

<div id="debug-bar">Ładowanie systemu...</div>

<div id="dashboard-view">
    <div id="tiles-container">Wczytywanie kafelków...</div>
</div>

<div id="schedule-view">
    <div id="grid" class="week-container"></div>
</div>

<footer>
    <a href="https://www.zsz5.edupage.org" target="_blank">www.zsz5.edupage.org</a>
</footer>

<script>
    // === KONFIGURACJA ===
    const CONFIG = {
        xml: './plan.xml',
        dyzury: './dyzury.xlsx',
        zastepstwa: './zastepstwa.xlsx',
        refreshInterval: 120000, // 2 minuty
        idleTimeout: 20000       // 20 sekund
    };

    const DB = {
        teachers: {}, rooms: [], classes: {}, classesList: [], groups: {},
        locations: [], periods: [], lessons: [], duties: [], subs: [], dutyChanges: []
    };

    const DAYS = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];
    let refreshTimer = null;
    let idleTimer = null;
    let isDashboardActive = true;

    window.onload = () => {
        startClock();
        refreshData();
        refreshTimer = setInterval(refreshData, CONFIG.refreshInterval);
        
        document.addEventListener('mousemove', resetIdle);
        document.addEventListener('click', resetIdle);
        document.addEventListener('touchstart', resetIdle);
    };

    function resetIdle() {
        if (isDashboardActive) return;
        clearTimeout(idleTimer);
        idleTimer = setTimeout(returnToDashboard, CONFIG.idleTimeout);
    }

    function returnToDashboard() {
        isDashboardActive = true;
        clearTimeout(idleTimer);
        document.getElementById('dashboard-view').style.display = 'block';
        document.getElementById('schedule-view').style.display = 'none';
        document.getElementById('nav-controls').style.display = 'none';
        document.body.className = '';
        log("Menu Główne");
    }

    function openSchedule(mode, id) {
        isDashboardActive = false;
        const modeSel = document.getElementById('mode-select');
        const dataSel = document.getElementById('data-select');
        modeSel.value = mode;
        populateSelect(false);
        dataSel.value = id;
        
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('schedule-view').style.display = 'block';
        document.getElementById('nav-controls').style.display = 'flex';
        
        render();
        resetIdle();
    }

    async function refreshData() {
        log("Aktualizacja danych...", false);
        DB.lessons = []; DB.periods = []; DB.duties = []; DB.subs = []; DB.dutyChanges = [];
        DB.teachers = {}; DB.classes = {}; DB.classesList = []; DB.rooms = []; DB.groups = {};

        try {
            await loadXML();
            await Promise.all([
                loadExcel(CONFIG.dyzury, 'dyzury').catch(() => {}),
                loadExcel(CONFIG.zastepstwa, 'zastepstwa').catch(() => {})
            ]);
            
            addMissingTeachers();
            
            if(isDashboardActive) renderDashboard();
            else { populateSelect(false); render(); }
            
            log(`Dane zaktualizowane: ${new Date().toLocaleTimeString()}`);
        } catch (e) {
            console.error(e);
            log("Błąd aktualizacji danych!", true);
        }
    }

    function renderDashboard() {
        const container = document.getElementById('tiles-container');
        container.innerHTML = "";

        const createSection = (title, items, type, clickFn) => {
            if(!items.length) return;
            const div = document.createElement('div');
            div.innerHTML = `<div class="section-title">${title}</div>`;
            const grid = document.createElement('div'); grid.className = 'tile-grid';
            items.forEach(item => {
                const tile = document.createElement('div');
                tile.className = `tile ${type}`;
                tile.innerText = item.txt;
                tile.onclick = () => clickFn(item.val);
                grid.appendChild(tile);
            });
            div.appendChild(grid);
            container.appendChild(div);
        };

        const teachers = Object.entries(DB.teachers)
            .sort((a,b) => a[1].name.localeCompare(b[1].name))
            .filter(([id, t]) => !t.name.toLowerCase().includes('wakat'))
            .map(([id, t]) => ({val: id, txt: t.name}));

        createSection("Nauczyciele", teachers, 'teacher', (id) => openSchedule('teacher', id));
        createSection("Sale Lekcyjne", DB.rooms.sort().map(r => ({val: r, txt: r})), 'room', (id) => openSchedule('room', id));
        createSection("Oddziały", DB.classesList.sort().map(c => ({val: c, txt: c})), 'class', (id) => openSchedule('class', id));
    }

    // === PARSOWANIE DANYCH ===
    async function fetchFresh(url) {
        const res = await fetch(url + "?t=" + new Date().getTime());
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return res;
    }
    async function fetchText(url) {
        const res = await fetchFresh(url);
        const blob = await res.blob();
        return new Promise(r => {
            const reader = new FileReader(); 
            reader.onload = () => r(reader.result); 
            reader.readAsText(blob, 'windows-1250'); 
        });
    }
    async function loadExcel(url, type) {
        const res = await fetchFresh(url);
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, {type: 'array'});
        if(type === 'dyzury') parseDuties(wb);
        if(type === 'zastepstwa') parseSub(wb);
    }
    async function loadXML() {
        const txt = await fetchText(CONFIG.xml);
        const xml = new DOMParser().parseFromString(txt, "text/xml");

        // Grupy
        xml.querySelectorAll('groups group').forEach(g => {
            DB.groups[g.getAttribute('id')] = g.getAttribute('name');
        });

        xml.querySelectorAll('teachers teacher').forEach(t => {
            const id = t.getAttribute('id');
            const name = (t.getAttribute('firstname')||'') + ' ' + (t.getAttribute('lastname')||t.getAttribute('name'));
            DB.teachers[id] = { name: name.trim(), normalized: normalize(name) };
        });
        xml.querySelectorAll('classes class').forEach(c => {
            const id = c.getAttribute('id'); const name = c.getAttribute('name');
            DB.classes[id] = name; if(!DB.classesList.includes(name)) DB.classesList.push(name);
        });
        const roomMap = {};
        const roomSet = new Set();
        xml.querySelectorAll('classrooms classroom').forEach(r => {
            const name = r.getAttribute('name'); roomMap[r.getAttribute('id')] = name; roomSet.add(name);
        });
        DB.rooms = Array.from(roomSet);
        xml.querySelectorAll('periods period').forEach(p => {
            DB.periods.push({ nr: parseInt(p.getAttribute('period')), start: p.getAttribute('starttime'), end: p.getAttribute('endtime') });
        });
        DB.periods.sort((a,b) => a.nr - b.nr);
        const subjects = {};
        xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));
        
        xml.querySelectorAll('cards card').forEach(c => {
            const lesson = xml.querySelector(`lessons lesson[id="${c.getAttribute('lessonid')}"]`);
            if(!lesson) return;
            const tidsRaw = lesson.getAttribute('teacherids');
            const dayIdx = c.getAttribute('days').indexOf('1') + 1;
            const roomId = c.getAttribute('classroomids');
            const classIds = lesson.getAttribute('classids').split(',');
            const classNames = classIds.map(cid => DB.classes[cid]).join(', ');
            
            // Pobranie nazwy grupy
            const groupIds = lesson.getAttribute('groupids');
            const groupName = groupIds ? groupIds.split(',').map(gid => DB.groups[gid]).join(',') : '';

            if(dayIdx > 0 && tidsRaw) {
                const tidsArray = tidsRaw.split(',');
                const mainTeacherId = tidsArray[0].trim();
                const supportTeachers = tidsArray.slice(1).map(tid => DB.teachers[tid.trim()]?.name || tid);
                DB.lessons.push({
                    teacherId: mainTeacherId, day: dayIdx, period: parseInt(c.getAttribute('period')),
                    subject: subjects[lesson.getAttribute('subjectid')] || 'Lekcja',
                    room: roomMap[roomId] || '', classNames: classNames, branch: '',
                    groupName: groupName, // Dodajemy nazwę grupy
                    supportInfo: supportTeachers.length ? supportTeachers.join(', ') : null
                });
            }
        });
    }

    function parseDuties(wb) { /* Skrót - logika dyżurów bez zmian */
        wb.SheetNames.forEach(sheetName => {
            const ws = wb.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(ws, {header: 1});
            let currentDayMap = null;
            for(let i=0; i<data.length; i++) {
                const row = data[i]; if(!row || !row.length) continue;
                const rowStr = row.map(c => String(c||"").toLowerCase());
                if(rowStr.some(s => s.includes('poniedziałek'))) {
                    currentDayMap = {};
                    row.forEach((cell, idx) => {
                        const val = String(cell||"").toLowerCase();
                        if(val.includes('poniedziałek')) currentDayMap[idx]=1;
                        if(val.includes('wtorek')) currentDayMap[idx]=2;
                        if(val.includes('środa')) currentDayMap[idx]=3;
                        if(val.includes('czwartek')) currentDayMap[idx]=4;
                        if(val.includes('piątek')) currentDayMap[idx]=5;
                    });
                    continue;
                }
                if(currentDayMap) {
                    let timeVal=null, placeVal=null;
                    for(let c=0; c<5; c++) {
                        if(row[c] && /\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/.test(String(row[c]))) {
                            timeVal = String(row[c]).trim();
                            if(c>0 && row[c-1]) placeVal=row[c-1]; else if(row[0]) placeVal=row[0]; break;
                        }
                    }
                    if(timeVal) {
                        for(const [colIdx, dayNum] of Object.entries(currentDayMap)) {
                            const rawTeacher = row[colIdx];
                            if(rawTeacher && String(rawTeacher).length>2) {
                                const tId = findTeacherId(String(rawTeacher).trim());
                                if(tId) DB.duties.push({
                                    teacherId: tId, day: dayNum, time: timeVal,
                                    startMin: timeToMin(timeVal.split('-')[0]),
                                    place: placeVal ? placeVal.trim() : "Dyżur"
                                });
                            }
                        }
                    }
                }
            }
        });
    }

    function parseSub(wb) {
        const sh = wb.Sheets["Oddziały"] || wb.Sheets[0];
        XLSX.utils.sheet_to_json(sh).forEach(r => {
            const d = parseDate(r['Dzień']);
            if(d) DB.subs.push({
                date: d, periodRaw: r['Lekcja'],
                absent: findTeacherId(r['Nauczyciel/wakat']),
                sub: findTeacherId(r['Zastępca']),
                rawSub: r['Zastępca'], rawAbs: r['Nauczyciel/wakat'],
                subject: r['Przedmiot'], room: r['Sala'], note: r['Uwagi'],
                branch: r['Oddział'], payInfo: r['Forma płatności']
            });
        });
        const shDy = wb.Sheets["Dyżury"];
        if(shDy) {
            XLSX.utils.sheet_to_json(shDy).forEach(r => {
                const d = parseDate(r['Dzień']);
                if(d) DB.dutyChanges.push({
                    date: d, time: r['Godzina'],
                    absent: findTeacherId(r['Nauczyciel']), sub: findTeacherId(r['Zastępca']),
                    rawSub: r['Zastępca'], place: r['Miejsce dyżuru']
                });
            });
        }
    }

    // === UTILS ===
    function normalize(str) { return (str||"").toLowerCase().replace(/^(x\.|ks\.|p\.|pani|pan)\s+/g, '').replace(/[^a-złąceźżńóś\s]/g, '').trim().split(/\s+/).sort().join(' '); }
    function levenshtein(a, b) { const m = []; for(let i=0; i<=b.length; i++) m[i]=[i]; for(let j=0; j<=a.length; j++) m[0][j]=j; for(let i=1; i<=b.length; i++) for(let j=1; j<=a.length; j++) m[i][j] = b.charAt(i-1)===a.charAt(j-1) ? m[i-1][j-1] : Math.min(m[i-1][j-1]+1, Math.min(m[i][j-1]+1, m[i-1][j]+1)); return m[b.length][a.length]; }
    function findTeacherId(rawName) {
        if(!rawName || rawName.length<3) return null; if(/wakat|brak|okienko/i.test(rawName)) return null;
        const target = normalize(rawName); let bestId = null, bestScore = 0;
        for(const [id, t] of Object.entries(DB.teachers)) {
            const source = t.normalized;
            if(source === target) return id;
            if(source.includes(target) || target.includes(source)) { if(bestScore<50) { bestScore=50; bestId=id; } }
            const dist = levenshtein(source, target);
            if(dist <= 2 && source.length>4 && bestScore<80) { bestScore=80; bestId=id; }
        }
        return bestId;
    }
    function timeToMin(str) { if(!str) return 0; const [h,m] = str.trim().split(':').map(Number); return h*60+m; }
    function parseDate(val) {
        if(!val) return null;
        if(typeof val === 'number') { const d = XLSX.SSF.parse_date_code(val); return `${d.y}-${d.m<10?'0':''}${d.m}-${d.d<10?'0':''}${d.d}`; }
        if(typeof val === 'string') { const p = val.trim().split('.'); if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`; }
        return null;
    }
    function getMonday(d) { d = new Date(d); const day = d.getDay(); const diff = d.getDate() - day + (day == 0 ? -6:1); return new Date(d.setDate(diff)); }
    function getTeacherName(id) { return DB.teachers[id] ? DB.teachers[id].name : id; }
    function normalizeClass(c) { return (c || "").replace(/\s/g, '').toLowerCase(); }
    function addMissingTeachers() {
        const check = (raw, obj, f) => { if(raw && !obj[f]) { const nid="EXT_"+normalize(raw).replace(/\s/g,'_'); if(!DB.teachers[nid]) DB.teachers[nid]={name:raw.trim(),normalized:normalize(raw)}; obj[f]=nid; }};
        DB.subs.forEach(s => check(s.rawSub, s, 'sub')); DB.dutyChanges.forEach(d => check(d.rawSub, d, 'sub'));
    }

    function populateSelect(renderIt=true) {
        const mode = document.getElementById('mode-select').value;
        const sel = document.getElementById('data-select');
        sel.innerHTML = "";
        let items = [];
        if (mode === 'teacher') items = Object.entries(DB.teachers).sort((a,b) => a[1].name.localeCompare(b[1].name)).map(x => ({val: x[0], txt: x[1].name}));
        else if (mode === 'room') items = DB.rooms.sort().map(x => ({val: x, txt: x}));
        else if (mode === 'class') items = DB.classesList.sort().map(x => ({val: x, txt: x}));
        
        items.forEach(i => {
            const opt = document.createElement('option'); opt.value = i.val; opt.innerText = i.txt; sel.appendChild(opt);
        });
        if(items.length && !sel.value) sel.value = items[0].val;
    }

    function getDutiesForTime(tid, day, date, min, max) {
        const res = [];
        DB.duties.filter(d => d.teacherId==tid && d.day==day).forEach(d => {
            if(d.startMin >= min && d.startMin < max) {
                const canc = DB.dutyChanges.find(c => c.date==date && c.time==d.time && c.absent==tid);
                res.push({...d, status: canc?'cancelled':'ok'});
            }
        });
        DB.dutyChanges.filter(c => c.date==date && c.sub==tid).forEach(c => {
            const start = timeToMin(c.time.split('-')[0]);
            if(start >= min && start < max) res.push({ time: c.time, place: c.place, startMin: start, status: 'added' });
        });
        return res;
    }

    // === RENDER PLANU (POPRAWIONA OBSŁUGA GRUP) ===
    function render() {
        const mode = document.getElementById('mode-select').value;
        const selectedId = document.getElementById('data-select').value;
        const grid = document.getElementById('grid');
        grid.innerHTML = "";
        if(!selectedId) return;
        const monday = getMonday(new Date());

        for(let i=0; i<5; i++) {
            const curDate = new Date(monday); curDate.setDate(monday.getDate() + i);
            const dateStr = curDate.toISOString().split('T')[0];
            const dayNum = i + 1;
            const col = document.createElement('div'); col.className = 'day-col';
            col.innerHTML = `<div class="day-header">${DAYS[dayNum]}<span class="day-date">${curDate.toLocaleDateString('pl-PL')}</span></div>`;
            const content = document.createElement('div'); content.className = 'day-content';

            // Dyżury poranne (tylko dla nauczyciela)
            if (mode === 'teacher') {
                getDutiesForTime(selectedId, dayNum, dateStr, 0, 480).forEach(d => {
                    const div = document.createElement('div'); div.className = 'card morning-duty'; 
                    if(d.status==='added') div.classList.add('duty-sub');
                    if(d.status==='cancelled') div.style.textDecoration='line-through';
                    div.innerHTML = `<div style="font-weight:700">${d.status==='added'?'ZASTĘPSTWO':'DYŻUR'} ${d.time}</div><div>${d.place}</div>`;
                    content.appendChild(div);
                });
            }

            DB.periods.forEach(p => {
                const wrapper = document.createElement('div'); wrapper.className = 'slot-wrapper';
                
                // 1. ZNAJDŹ WSZYSTKIE LEKCJE DLA TEGO SLOTU (FILTER ZAMIAST FIND)
                let lessons = [];
                if (mode === 'teacher') lessons = DB.lessons.filter(l => l.teacherId == selectedId && l.day == dayNum && l.period == p.nr);
                else if (mode === 'room') lessons = DB.lessons.filter(l => l.room === selectedId && l.day == dayNum && l.period == p.nr);
                else if (mode === 'class') lessons = DB.lessons.filter(l => l.classNames.includes(selectedId) && l.day == dayNum && l.period == p.nr);

                // 2. ZNAJDŹ WSZYSTKIE ZASTĘPSTWA DLA TEGO SLOTU
                // Szukamy zastępstw "nowych" (wstawionych w puste miejsce lub jako dodatkowa grupa)
                let subAdds = [];
                if (mode === 'teacher') subAdds = DB.subs.filter(s => s.date == dateStr && s.sub == selectedId && s.periodRaw.startsWith(p.nr+','));
                else if (mode === 'room') subAdds = DB.subs.filter(s => s.date == dateStr && s.room === selectedId && s.periodRaw.startsWith(p.nr+','));
                else if (mode === 'class') subAdds = DB.subs.filter(s => s.date == dateStr && normalizeClass(s.branch).includes(normalizeClass(selectedId)) && s.periodRaw.startsWith(p.nr+','));

                // Sortowanie lekcji (np. wg grupy)
                lessons.sort((a,b) => (a.groupName||"").localeCompare(b.groupName||""));

                // RENDEROWANIE KART LEKCJI
                if(lessons.length > 0) {
                    lessons.forEach(lesson => {
                        const div = document.createElement('div');
                        
                        // Sprawdź czy TA KONKRETNA lekcja ma zastępstwo (nieobecność nauczyciela)
                        // Próbujemy dopasować też grupę jeśli to możliwe (w uproszczeniu po nauczycielu)
                        const subAbs = DB.subs.find(s => s.date == dateStr && s.absent == lesson.teacherId && s.periodRaw.startsWith(p.nr+','));

                        if(subAbs) {
                            div.className = 'card is-sub';
                            div.innerHTML = `
                                <div class="meta">
                                    <span class="nr">${p.nr}</span> ${p.start}-${p.end}
                                    ${lesson.groupName ? `<span class="group-badge">${lesson.groupName}</span>` : ''}
                                </div>
                                <div class="main-info">${lesson.subject}</div>
                                <span class="note-red">Nieobecność</span>`;
                        } else {
                            div.className = 'card';
                            let line = "";
                            if(mode === 'teacher') line = `${lesson.classNames} / s.${lesson.room}`;
                            else if(mode === 'room') line = `${lesson.classNames} / ${getTeacherName(lesson.teacherId)}`;
                            else line = `${getTeacherName(lesson.teacherId)} / s.${lesson.room}`;
                            
                            div.innerHTML = `
                                <div class="meta">
                                    <span class="nr">${p.nr}</span> ${p.start}-${p.end}
                                    ${lesson.groupName ? `<span class="group-badge">${lesson.groupName}</span>` : ''}
                                </div>
                                <div class="main-info">${lesson.subject}</div>
                                <div class="sub-line">${line}</div>`;
                        }
                        wrapper.appendChild(div);
                    });
                }

                // RENDEROWANIE DODANYCH ZASTĘPSTW (NEW)
                if(subAdds.length > 0) {
                    subAdds.forEach(sub => {
                        // Spróbuj wyciągnąć grupę z nazwy oddziału w Excelu (np. "3K|DZ" -> "DZ")
                        let subGroup = "";
                        if(sub.branch && sub.branch.includes('|')) {
                            subGroup = sub.branch.split('|')[1];
                        }

                        const div = document.createElement('div');
                        div.className = 'card is-new';
                        let line = mode==='teacher' ? `s.${sub.room} / ${sub.branch}` : `${getTeacherName(sub.sub)}`;
                        
                        div.innerHTML = `
                            <div class="meta">
                                <span class="nr">${p.nr}</span> ${p.start}-${p.end}
                                ${subGroup ? `<span class="group-badge">${subGroup}</span>` : ''}
                            </div>
                            <div class="main-info">ZASTĘPSTWO</div>
                            <div class="sub-line">${line} / ${sub.subject}</div>
                            <div class="details">Za: ${sub.rawAbs}</div>`;
                        wrapper.appendChild(div);
                    });
                }

                // JEŚLI PUSTO
                if(lessons.length === 0 && subAdds.length === 0) {
                     const div = document.createElement('div');
                     div.className = 'card empty'; 
                     div.innerHTML = `${p.nr}. ${p.start}`;
                     wrapper.appendChild(div);
                }
                
                // Dyżury na przerwie (tylko nauczyciel)
                if(mode === 'teacher') {
                    const pEnd = timeToMin(p.end);
                    getDutiesForTime(selectedId, dayNum, dateStr, pEnd-5, pEnd+15).forEach(d => {
                        const dDiv = document.createElement('div'); dDiv.className = 'duty-section';
                        if(d.status === 'added') dDiv.classList.add('duty-sub');
                        dDiv.innerHTML = `<b>${d.time}</b> ${d.place}`;
                        wrapper.appendChild(dDiv);
                    });
                }
                
                content.appendChild(wrapper);
            });
            col.appendChild(content); grid.appendChild(col);
        }
    }

    function startClock() {
        const update = () => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleString('pl-PL', { weekday:'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        };
        update(); setInterval(update, 1000);
    }
    function log(msg, err=false) { const el = document.getElementById('debug-bar'); el.innerText = msg; el.style.color = err ? 'red' : '#4b5563'; }
</script>
</body>
</html>
