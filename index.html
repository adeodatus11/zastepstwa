<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>ZSZ nr 5 ‚Äì fullpit nauczyciela</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #2980b9; --bg: #ecf0f1; --white: #ffffff; --err: #c0392b; --ok: #27ae60; --dark: #2c3e50; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* NAG≈Å√ìWEK I LOGO */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px solid #bdc3c7; padding-bottom: 15px; margin-bottom: 20px;
        }
        h1 { margin: 0; color: var(--dark); font-weight: 400; font-size: 1.8rem; }
        .logo-img { height: 60px; width: auto; object-fit: contain; }

        /* STATUS BOX */
        #status-box { 
            padding: 15px; border-radius: 5px; margin-bottom: 20px; font-size: 0.9rem; 
            display: none; border-left: 5px solid; 
        }
        .status-loading { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .status-error { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        .status-success { background: #d4edda; color: #155724; border-color: #c3e6cb; }

        /* PANEL STEROWANIA */
        .dashboard { 
            background: var(--white); padding: 20px; border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; 
            align-items: flex-end; margin-bottom: 20px; 
        }
        
        .input-group { display: flex; flex-direction: column; flex: 1; min-width: 200px; }
        .input-group label { font-size: 0.75rem; font-weight: 700; color: #7f8c8d; margin-bottom: 5px; text-transform: uppercase; }
        .input-group select, .input-group input { padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; width: 100%; box-sizing: border-box; }
        .btn-refresh { padding: 10px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-refresh:hover { background: #1f618d; }

        /* Rƒôczne wgrywanie (ukryte) */
        .manual-upload { display: none; border-top: 1px dashed #ccc; padding-top: 15px; width: 100%; margin-top: 10px; }
        .manual-upload.visible { display: flex; flex-wrap: wrap; gap: 15px; }

        /* TABELA PLANU */
        .timetable { display: grid; grid-template-columns: 70px repeat(5, 1fr); gap: 10px; padding-bottom: 50px; }
        
        /* HEADER (STICKY - TO JEST NOWO≈öƒÜ) */
        .header { 
            background: var(--dark); color: white; padding: 12px; text-align: center; 
            border-radius: 4px; font-weight: 600; 
            /* Sticky logic */
            position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .time-col { background: #dfe6e9; padding: 5px; text-align: center; display: flex; flex-direction: column; justify-content: center; font-weight: bold; border-radius: 4px; font-size: 0.8rem; }
        .day-col { display: flex; flex-direction: column; gap: 8px; }

        /* KARTY LEKCJI */
        .card { background: white; border-left: 5px solid var(--primary); padding: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); min-height: 80px; position: relative; font-size: 0.9rem; }
        .card.empty { background: transparent; border: 2px dashed #dcdde1; box-shadow: none; border-left: none; }
        
        .subject { font-weight: 700; color: var(--dark); }
        .class-name { font-size: 0.85rem; color: #7f8c8d; font-weight: 600; margin-top: 2px; }
        .room { position: absolute; top: 8px; right: 8px; background: #f1c40f; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; font-weight: 700; }
        
        /* Zastƒôpstwa */
        .cancelled { background: #fff5f5; border-left-color: var(--err); opacity: 0.7; }
        .cancelled .subject { text-decoration: line-through; color: var(--err); }
        .added { background: #f0fdf4; border-left-color: var(--ok); }
        .added .subject { color: var(--ok); }
        .sub-info { display: block; font-size: 0.75rem; font-weight: bold; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ccc; }
        .sub-alert { color: var(--err); } 
        .sub-success { color: var(--ok); }

        /* Dy≈ºury */
        .duty { margin-top: 5px; padding: 5px; background: #e1f5fe; border: 1px solid #81d4fa; color: #0277bd; border-radius: 3px; font-size: 0.75rem; display: flex; flex-direction: column; }
        .duty-lbl { font-weight: 900; font-size: 0.65rem; text-transform: uppercase; margin-bottom: 2px; letter-spacing: 0.5px; }
        .duty-row { display: flex; justify-content: space-between; }
        .duty.cancelled { background: #ffebee; border-color: #ef9a9a; color: #c62828; text-decoration: line-through; opacity: 0.7; }
        .duty.added { background: #e8f5e9; border-color: #a5d6a7; color: #2e7d32; }

    </style>
</head>
<body>

    <div class="top-bar">
        <h1>ZSZ nr 5 ‚Äì fullpit nauczyciela</h1>
        <img src="orze≈Ç.png" alt="Logo Orze≈Ç" class="logo-img" onerror="this.style.display='none'"> 
    </div>

    <div id="status-box"></div>

    <div class="dashboard">
        <div class="input-group">
            <label>Wybierz Nauczyciela</label>
            <select id="teacherSelect" disabled><option>≈Åadowanie danych...</option></select>
        </div>
        <div class="input-group">
            <label>Data (Tydzie≈Ñ)</label>
            <input type="date" id="datePicker">
        </div>
        <div class="input-group" style="max-width: 120px;">
            <label>&nbsp;</label>
            <button onclick="initAutoLoad()" class="btn-refresh">Od≈õwie≈º</button>
        </div>

        <div id="manual-section" class="manual-upload">
            <div style="width:100%; color:#c0392b; font-weight:bold; margin-bottom:10px;">‚ö†Ô∏è Tryb rƒôczny (Automatyczne wczytywanie nie powiod≈Ço siƒô):</div>
            <div class="input-group"><label>1. Plan (XML)</label><input type="file" id="fileXml" accept=".xml"></div>
            <div class="input-group"><label>2. Dy≈ºury (XLSX)</label><input type="file" id="filePermDuty" accept=".xlsx"></div>
            <div class="input-group"><label>3. Zastƒôpstwa (XLSX)</label><input type="file" id="fileSubs" accept=".xlsx"></div>
        </div>
    </div>

    <div id="timetable" class="timetable"></div>

<script>
    // ==========================================
    // ‚öôÔ∏è KONFIGURACJA PLIK√ìW
    // ==========================================
    const CONFIG = {
        xml: 'plan.xml',        // Plik XML
        duties: 'dyzury.xlsx',  // Plik dy≈ºur√≥w sta≈Çych
        subs: 'zastepstwa.xlsx' // Plik zastƒôpstw
    };

    // --- Baza Danych ---
    const DB = { teachers: {}, lessons: [], periods: [], permDuties: [], subLessons: [], subDuties: [] };

    // --- Start ---
    document.getElementById('datePicker').valueAsDate = new Date();
    window.addEventListener('DOMContentLoaded', initAutoLoad);

    // Listenery
    document.getElementById('teacherSelect').addEventListener('change', render);
    document.getElementById('datePicker').addEventListener('change', render);
    document.getElementById('fileXml').addEventListener('change', (e) => loadFile(e.target.files[0], 'xml'));
    document.getElementById('filePermDuty').addEventListener('change', (e) => loadFile(e.target.files[0], 'duty'));
    document.getElementById('fileSubs').addEventListener('change', (e) => loadFile(e.target.files[0], 'subs'));

    // --- Status UI ---
    function setStatus(msg, type) {
        const box = document.getElementById('status-box');
        box.style.display = 'block';
        box.className = `status-${type}`;
        box.innerHTML = msg;
    }

    // ==========================================
    // 1. AUTO LOAD (GitHub / Server)
    // ==========================================
    async function initAutoLoad() {
        setStatus('üîÑ Pobieranie plik√≥w z serwera...', 'loading');
        document.getElementById('manual-section').classList.remove('visible');

        const t = new Date().getTime(); // Anti-cache
        const fetchList = [
            { url: `${CONFIG.xml}?t=${t}`, type: 'xml', name: CONFIG.xml },
            { url: `${CONFIG.duties}?t=${t}`, type: 'duty', name: CONFIG.duties },
            { url: `${CONFIG.subs}?t=${t}`, type: 'subs', name: CONFIG.subs }
        ];

        try {
            if (window.location.protocol === 'file:') throw new Error("Protok√≥≈Ç file:// nieobs≈Çugiwany automatycznie. U≈ºyj serwera (np. GitHub Pages) lub wgraj pliki rƒôcznie.");

            const responses = await Promise.all(fetchList.map(f => fetch(f.url)));
            for(let i=0; i<responses.length; i++) {
                if(!responses[i].ok) throw new Error(`Brak pliku: <b>${fetchList[i].name}</b>`);
            }

            const blobs = await Promise.all(responses.map(r => r.blob()));
            await loadFile(blobs[0], 'xml');
            await loadFile(blobs[1], 'duty');
            await loadFile(blobs[2], 'subs');

            setStatus('‚úÖ Dane za≈Çadowane pomy≈õlnie.', 'success');
        } catch (err) {
            console.warn(err);
            setStatus(`‚ùå <b>B≈ÇƒÖd pobierania:</b> ${err.message}<br>U≈ºyj panelu rƒôcznego poni≈ºej.`, 'error');
            document.getElementById('manual-section').classList.add('visible');
            document.getElementById('teacherSelect').innerHTML = '<option>Wybierz pliki rƒôcznie</option>';
        }
    }

    // ==========================================
    // 2. FILE READER
    // ==========================================
    function loadFile(blob, type) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            if(type === 'xml') reader.readAsText(blob, "windows-1250");
            else reader.readAsArrayBuffer(blob);

            reader.onload = (e) => {
                try {
                    if(type === 'xml') parseXml(e.target.result);
                    if(type === 'duty') parseDuties(e.target.result);
                    if(type === 'subs') parseSubs(e.target.result);
                    resolve();
                    render();
                } catch (err) { reject(err); }
            };
        });
    }

    // ==========================================
    // 3. PARSERS
    // ==========================================
    function parseXml(str) {
        const xml = new DOMParser().parseFromString(str, "text/xml");
        if(xml.querySelector("parsererror")) throw new Error("B≈ÇƒÖd XML");

        const sel = document.getElementById('teacherSelect');
        const oldVal = sel.value;
        sel.innerHTML = '<option value="">-- Wybierz Nauczyciela --</option>';
        
        const tList = Array.from(xml.querySelectorAll('teachers teacher'));
        tList.sort((a,b) => a.getAttribute('name').localeCompare(b.getAttribute('name')));
        tList.forEach(t => {
            const id = t.getAttribute('id');
            const name = t.getAttribute('name');
            DB.teachers[id] = { name };
            sel.innerHTML += `<option value="${id}">${name}</option>`;
        });
        sel.disabled = false;
        if(oldVal) sel.value = oldVal;

        // Metadata
        const classes = {}, subjs = {}, rooms = {};
        xml.querySelectorAll('classes class').forEach(x => classes[x.getAttribute('id')] = x.getAttribute('name'));
        xml.querySelectorAll('subjects subject').forEach(x => subjs[x.getAttribute('id')] = x.getAttribute('short') || x.getAttribute('name'));
        xml.querySelectorAll('classrooms classroom').forEach(x => rooms[x.getAttribute('id')] = x.getAttribute('short') || x.getAttribute('name'));

        DB.periods = Array.from(xml.querySelectorAll('periods period')).map(p => ({
            id: p.getAttribute('period'), start: p.getAttribute('starttime'), end: p.getAttribute('endtime')
        }));

        // Lessons
        const lDefs = {};
        xml.querySelectorAll('lessons lesson').forEach(l => {
            const cNames = l.getAttribute('classids').split(',').map(id => classes[id]).join(', ');
            lDefs[l.getAttribute('id')] = {
                subj: subjs[l.getAttribute('subjectid')]||'?',
                teaIds: l.getAttribute('teacherids'),
                cls: cNames
            };
        });

        DB.lessons = [];
        xml.querySelectorAll('cards card').forEach(c => {
            const def = lDefs[c.getAttribute('lessonid')];
            if(def) {
                const dayIdx = c.getAttribute('days').indexOf('1') + 1;
                if(dayIdx > 0) {
                    DB.lessons.push({
                        day: dayIdx, period: c.getAttribute('period'),
                        teacherIds: def.teaIds, subject: def.subj, className: def.cls,
                        room: rooms[c.getAttribute('classroomids')]||''
                    });
                }
            }
        });
    }

    function parseDuties(buf) {
        const wb = XLSX.read(buf, {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
        DB.permDuties = [];
        let loc = "";
        data.forEach(r => {
            if(r.length<3) return;
            if(r[0] && isNaN(parseInt(r[0][0]))) loc = r[0];
            const t = (r[1]||"").toString();
            if(t.match(/\d{1,2}:\d{2}-\d{1,2}:\d{2}/)) {
                const [s,e] = t.split('-');
                for(let d=0; d<5; d++) {
                    const tn = (r[d+2]||"").trim();
                    if(tn.length>2 && !tn.toLowerCase().includes('brak') && !tn.toLowerCase().includes('x.')) {
                        DB.permDuties.push({ day: d+1, start: s.trim(), end: e.trim(), loc: loc, teacher: tn });
                    }
                }
            }
        });
    }

    function parseSubs(buf) {
        const wb = XLSX.read(buf, {type: 'array'});
        const sl = wb.SheetNames.find(n => n.toLowerCase().includes('oddzia≈Ç'));
        if(sl) {
            DB.subLessons = XLSX.utils.sheet_to_json(wb.Sheets[sl], {raw:false, dateNF:'dd.mm.yyyy'}).map(r => ({
                date: r['Dzie≈Ñ'], period: (r['Lekcja']||'').split(',')[0].trim(),
                absent: r['Nauczyciel/wakat'], sub: r['Zastƒôpca'],
                subject: r['Przedmiot'], room: r['Sala'], info: r['Oddzia≈Ç']
            })).filter(x => x.date);
        }
        const sd = wb.SheetNames.find(n => n.toLowerCase().includes('dy≈ºur'));
        if(sd) {
            DB.subDuties = XLSX.utils.sheet_to_json(wb.Sheets[sd], {raw:false}).map(r => ({
                date: r['Dzie≈Ñ'], time: r['Godzina'],
                absent: r['Nauczyciel'], sub: r['Zastƒôpca'], loc: r['Miejsce dy≈ºuru']
            })).filter(x => x.date);
        }
    }

    // ==========================================
    // 4. LOGIC & RENDER
    // ==========================================
    function normalize(n) {
        if(!n) return "";
        return n.toLowerCase().replace(/x\./,'').replace(/[-.]/g,' ').split(/\s+/).filter(t=>t.length>1).sort().join('');
    }
    
    function isSame(n1, n2) {
        if(!n1 || !n2) return false;
        const t1 = n1.toLowerCase().replace(/x\./,'').replace(/[-]/g,' ').split(' ').filter(x=>x.length>1);
        const t2 = n2.toLowerCase().replace(/x\./,'').replace(/[-]/g,' ').split(' ').filter(x=>x.length>1);
        let hits = 0;
        t1.forEach(t => { if(t2.includes(t)) hits++; });
        return hits >= 2;
    }

    function timeToMin(t) {
        if(!t) return 0;
        const [h,m] = t.split(':').map(Number);
        return h*60+m;
    }

    function render() {
        const tid = document.getElementById('teacherSelect').value;
        if(!tid || !DB.teachers[tid]) return;
        const tName = DB.teachers[tid].name;
        
        const box = document.getElementById('timetable');
        box.innerHTML = '';

        // Dates
        const dateInput = document.getElementById('datePicker').value;
        const dObj = new Date(dateInput);
        const dayNum = dObj.getDay();
        const mon = new Date(dObj);
        mon.setDate(dObj.getDate() - (dayNum===0?6:dayNum-1));
        
        const week = [];
        for(let i=0; i<5; i++) {
            let d = new Date(mon); d.setDate(mon.getDate()+i);
            week.push(d.toLocaleDateString('pl-PL'));
        }

        const headers = ['Godziny', 'Poniedzia≈Çek', 'Wtorek', '≈öroda', 'Czwartek', 'PiƒÖtek'];
        headers.forEach((h, i) => {
            box.innerHTML += `<div class="header">${h}${i>0 ? '<br><small>'+week[i-1]+'</small>' : ''}</div>`;
        });

        const periods = (DB.periods.length) ? DB.periods : [1,2,3,4,5,6,7,8,9].map(i=>({id:i, start:'', end:''}));

        periods.forEach(p => {
            box.innerHTML += `<div class="time-col"><div>${p.id}</div><div>${p.start}<br>${p.end}</div></div>`;
            const pStart = timeToMin(p.start);
            const pEnd = timeToMin(p.end);

            for(let d=1; d<=5; d++) {
                const dateStr = week[d-1];
                const cell = document.createElement('div');
                cell.className = 'day-col';

                // LEKCJE
                const lXml = DB.lessons.find(l => l.day == d && l.period == p.id && l.teacherIds.includes(tid));
                const subAbs = DB.subLessons.find(s => s.date == dateStr && s.period == p.id && isSame(s.absent, tName));
                const subAdd = DB.subLessons.find(s => s.date == dateStr && s.period == p.id && isSame(s.sub, tName));

                if(lXml || subAdd) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    if(lXml) {
                        if(subAbs) {
                            card.classList.add('cancelled');
                            card.innerHTML = `<div class="subject">${lXml.subject}</div><div class="class-name">${lXml.className}</div><span class="sub-info sub-alert">Zastƒôpstwo: ${subAbs.sub||'TBA'}</span>`;
                        } else {
                            card.innerHTML = `<div class="subject">${lXml.subject}</div><div class="class-name">${lXml.className}</div><div class="room">${lXml.room}</div>`;
                        }
                    }
                    if(subAdd) {
                        const div = document.createElement('div');
                        if(lXml) div.style.marginTop = "8px"; else card.classList.add('added');
                        div.innerHTML = `<div class="subject" style="color:var(--ok)">${subAdd.subject}</div><div class="class-name">${subAdd.info} <span class="room" style="background:var(--ok)">${subAdd.room}</span></div><span class="sub-info sub-success">Za: ${subAdd.absent}</span>`;
                        if(!lXml) card.innerHTML = div.innerHTML; else card.appendChild(div);
                    }
                    cell.appendChild(card);
                } else {
                    cell.innerHTML += `<div class="card empty"></div>`;
                }

                // DY≈ªURY
                const showDuty = (tRange) => {
                    const ds = timeToMin(tRange.split('-')[0]);
                    if(p.id == 1 && ds < pStart) return true; 
                    if(Math.abs(ds - pEnd) <= 15) return true; 
                    return false;
                };

                const printDuty = (t, loc, type, info) => {
                    const el = document.createElement('div');
                    el.className = `duty ${type}`;
                    el.innerHTML = `<span class="duty-lbl">DY≈ªUR</span><div class="duty-row"><span>${t}</span> <span>${loc}</span></div>`;
                    if(info) el.innerHTML += `<small>${info}</small>`;
                    if(cell.lastElementChild) cell.lastElementChild.appendChild(el); else cell.appendChild(el);
                };

                DB.permDuties.filter(pd => pd.day == d && isSame(pd.teacher, tName)).forEach(pd => {
                    const t = `${pd.start}-${pd.end}`;
                    if(showDuty(t)) {
                        const isCanc = DB.subDuties.find(s => s.date == dateStr && s.time.startsWith(pd.start) && isSame(s.absent, tName));
                        if(isCanc) printDuty(t, pd.loc, 'cancelled', `Zast: ${isCanc.sub}`);
                        else printDuty(t, pd.loc, '', '');
                    }
                });
                DB.subDuties.filter(s => s.date == dateStr && isSame(s.sub, tName)).forEach(sd => {
                    if(showDuty(sd.time)) printDuty(sd.time, sd.loc, 'added', `Za: ${sd.absent}`);
                });

                box.appendChild(cell);
            }
        });
    }
</script>

</body>
</html>
