<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plan lekcji - Panel Kiosk</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            /* --- PALETA CIEMNA (FOREST THEME) --- */
            --bg: #020617;
            --text-main: #e2e8f0;
            --card-bg: #111827;
            
            /* Kafelki */
            --tile-bg: #0f172a;
            --tile-border: #1e293b;
            
            /* Akcenty */
            --accent-teacher: #22c55e;
            --accent-room: #fbbf24;
            --accent-class: #38bdf8;

            /* Paski boczne */
            --lesson-border: #16a34a;
            --room-border: #d97706;     
            --class-border: #0284c7;    
            
            /* Statusy */
            --sub-bg: #450a0a;
            --sub-color: #fca5a5;
            --sub-border: #ef4444;
            
            --new-bg: #064e3b;
            --new-color: #4ade80;
            --new-border: #22c55e;
            
            /* Dyżury */
            --duty-bg: #3f2c06;
            --duty-color: #fcd34d;
            --duty-border: #f59e0b;
            
            --duty-sub-bg: #14532d; 
            --duty-sub-border: #4ade80; 
            --duty-sub-color: #dcfce7;

            --empty: #1f2937;

            /* ZMIENNE WYSOKOŚCI NAGŁÓWKA DO STICKY HEADERÓW */
            /* Obliczone na podstawie paddingów i min-height głównego header'a */
            --header-height-desktop: 134px; 
            --header-height-mobile: 280px; /* Szacowana wysokość na telefonie po zawinięciu */
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); 
            margin: 0; padding: 0; 
            color: var(--text-main);
            display: flex; flex-direction: column;
            min-height: 100vh;
        }

        /* --- NAGŁÓWEK GŁÓWNY --- */
        header { 
            background: linear-gradient(
                to right, 
                #4dff88 0%, 
                #33cc66 30%, 
                #020617 100%
            );
            color: white; 
            padding: 10px 30px; 
            /* Główny nagłówek jest przyklejony do samej góry */
            position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: flex; justify-content: space-between; align-items: center;
            min-height: 110px;
            border-bottom: 4px solid #22c55e;
            flex-wrap: wrap; 
            /* Box-sizing jest ważny do obliczania wysokości */
            box-sizing: border-box;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }
        
        .logo { 
            height: 85px; 
            width: auto; 
            mix-blend-mode: multiply; 
            filter: contrast(1.1);
        }

        .header-text { display: flex; flex-direction: column; justify-content: center; }
        .header-text h1 { 
            margin: 0; font-size: 1.6rem; font-weight: 800; 
            text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.4);
        }
        .clock { 
            font-family: 'Consolas', monospace; font-size: 1.1rem; 
            color: #f0fdf4; margin-top: 4px; font-weight: 600;
        }

        /* --- NAWIGATOR TYGODNI --- */
        .week-nav {
            display: flex;
            align-items: center;
            gap: 20px;
            background: rgba(0, 0, 0, 0.25);
            padding: 8px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }

        .week-nav-btn {
            background: none; border: none; color: #4ade80;
            font-size: 2rem; cursor: pointer; padding: 0 10px;
            transition: transform 0.2s, color 0.2s; line-height: 1;
        }
        .week-nav-btn:hover { color: #fff; transform: scale(1.2); }

        .week-display { display: flex; flex-direction: column; align-items: center; min-width: 180px; }
        .week-label { font-size: 0.7rem; text-transform: uppercase; color: #a7f3d0; letter-spacing: 1px; }
        .week-range { 
            font-family: 'Consolas', monospace; font-size: 1.3rem; font-weight: 700; 
            color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5); 
        }

        .controls { display: flex; gap: 15px; align-items: center; }
        
        button.back-btn {
            background: #b91c1c; color: white; border: 1px solid #ef4444; 
            padding: 10px 20px; border-radius: 8px; cursor: pointer; 
            font-weight: 700; font-size: 0.9rem;
            display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: all 0.2s; text-transform: uppercase;
        }
        button.back-btn:hover { background: #dc2626; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.5); }

        /* --- RESPONSYWNOŚĆ (MOBILE) --- */
        @media (max-width: 900px) {
            header {
                flex-direction: column;
                height: auto;
                padding: 15px 10px;
                gap: 15px;
                background: linear-gradient(to bottom, #4dff88 0%, #020617 80%);
            }

            .header-left { width: 100%; justify-content: center; margin-bottom: 5px; }
            .logo { height: 60px; }
            .header-text h1 { font-size: 1.3rem; text-align: center; }
            .clock { font-size: 1rem; text-align: center; }

            .week-nav { width: 100%; justify-content: space-between; box-sizing: border-box; order: 2; }
            .week-display { min-width: auto; }
            .week-range { font-size: 1.1rem; }

            .controls { width: 100%; justify-content: center; order: 3; }
            button.back-btn { width: 100%; justify-content: center; }
            
            /* WYMUSZENIE JEDNEJ KOLUMNY NA TELEFONIE */
            .week-container { grid-template-columns: 1fr !important; }

            /* DOSTOSOWANIE PŁYWAJĄCEGO NAGŁÓWKA DNIA NA TELEFONIE */
            .day-header {
                /* Na telefonie główny header jest wyższy, więc ten musi przykleić się niżej */
                top: var(--header-height-mobile) !important;
            }
        }

        #debug-bar { 
            background: #111827; font-size: 0.75rem; padding: 4px 20px; color: #64748b; 
            border-bottom: 1px solid #1f2937; text-align: center; letter-spacing: 1px;
        }

        /* --- DASHBOARD --- */
        #dashboard-view { padding: 40px; display: block; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        .section-title { 
            font-size: 2rem; font-weight: 700; color: #f0fdf4; margin: 40px 0 20px 0; 
            border-bottom: 2px solid #22c55e; padding-bottom: 10px;
            text-transform: uppercase; letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(34, 197, 94, 0.3);
        }
        .section-title:first-child { margin-top: 0; }

        .tile-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }

        .tile {
            padding: 25px 15px; text-align: center; border-radius: 12px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            font-size: 1.3rem; font-weight: 600;
            display: flex; align-items: center; justify-content: center;
            min-height: 90px;
            background-color: var(--tile-bg); color: #e2e8f0;
            border: 1px solid var(--tile-border); position: relative; overflow: hidden;
        }
        .tile:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); z-index: 2; }
        .tile.teacher { border-bottom: 4px solid var(--accent-teacher); }
        .tile.room { border-bottom: 4px solid var(--accent-room); }
        .tile.class { border-bottom: 4px solid var(--accent-class); }

        /* --- WIDOK PLANU --- */
        #schedule-view { display: none; width: 100%; padding-bottom: 40px; }
        
        /* Domyślny widok (desktop) - 5 kolumn */
        .week-container {
            display: grid; grid-template-columns: repeat(5, 1fr); 
            gap: 15px; padding: 20px; align-items: start;
        }
        
        .day-col {
            background: #1e293b; 
            border-radius: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex; flex-direction: column;
            border: 1px solid #334155;
            /* Usunięto overflow:hidden, bo psuje sticky na niektórych przeglądarkach */
            /* overflow: hidden; */
        }
        
        /* --- PŁYWAJĄCY NAGŁÓWEK DNIA (KLUCZOWE ZMIANY) --- */
        .day-header {
            background: linear-gradient(to bottom, #065f46, #064e3b);
            color: #ecfdf5; 
            padding: 15px; 
            text-align: center; font-weight: 700; 
            border-bottom: 1px solid #047857;
            text-transform: uppercase;
            letter-spacing: 1px;
            
            /* Przywrócono sticky */
            position: sticky; 
            /* Ustawiono "top" tak, by zaczynał się pod głównym headerem */
            top: var(--header-height-desktop); 
            z-index: 900; /* Mniejszy z-index niż główny header (1000) */
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }
        .day-date { font-weight: 400; font-size: 0.8em; color: #a7f3d0; display: block; margin-top: 4px; }
        .day-content { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .slot-wrapper { 
            border: 1px solid #334155; border-radius: 8px; overflow: hidden; 
            display: flex; flex-direction: column; gap: 0px; 
            background: #0f172a;
        }

        .card {
            background: var(--card-bg); 
            border-left: 4px solid var(--lesson-border);
            color: #e2e8f0;
            padding: 10px 12px; min-height: 55px; display: flex; flex-direction: column; gap: 3px;
            border-bottom: 1px solid #334155;
            position: relative;
        }
        .card:last-child { border-bottom: none; }
        .card.empty {
            background: var(--empty); border-left-color: #4b5563; color: #64748b;
            display: flex; align-items: center; justify-content: center; font-style: italic; font-size: 0.85rem;
            min-height: 40px;
        }
        
        body.mode-room .card { border-left-color: var(--room-border); }
        body.mode-class .card { border-left-color: var(--class-border); }

        .meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: #94a3b8; margin-bottom: 2px; font-weight: 600; }
        .nr { background: #334155; padding: 1px 6px; border-radius: 4px; color: #f1f5f9; }
        .main-info { font-weight: 700; font-size: 1rem; color: #f8fafc; }
        .sub-line { font-weight: 500; font-size: 0.9rem; color: #cbd5e1; margin-top: 2px; }
        
        .group-badge {
            display: inline-block; background: #334155; color: #e2e8f0;
            font-size: 0.7rem; padding: 1px 6px; border-radius: 4px;
            margin-left: 6px; font-weight: bold; vertical-align: middle;
            border: 1px solid #475569;
        }

        .is-sub { background: var(--sub-bg); border-left-color: var(--sub-border) !important; }
        .is-sub .main-info { text-decoration: line-through; opacity: 0.6; color: #fca5a5; }
        .note-red { color: #f87171; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        .is-new { background: var(--new-bg); border-left-color: var(--new-border) !important; }
        .is-new .main-info { color: #86efac; }
        .is-new .sub-line { color: #dcfce7; }

        .duty-section {
            background: var(--duty-bg); color: var(--duty-color);
            border-top: 1px dashed var(--duty-border); padding: 8px 10px; font-size: 0.85rem;
        }
        .morning-duty {
            background: var(--duty-bg); border-left: 4px solid #f59e0b;
            padding: 12px; border-radius: 8px; margin-bottom: 8px;
            color: var(--duty-color); font-size: 0.9rem; border: 1px solid #78350f;
        }
        .duty-sub {
            background: var(--duty-sub-bg); border-left-color: var(--duty-sub-border);
            color: var(--duty-sub-color); border-color: #14532d;
        }

        footer {
            background: #064e3b; color: #a7f3d0; text-align: center;
            padding: 15px; font-size: 0.9rem; border-top: 1px solid #047857;
            margin-top: auto;
        }
        footer a { color: #fff; text-decoration: none; font-weight: bold; }

        /* MEDIA QUERIES DLA UKŁADU KOLUMN */
        @media (max-width: 1200px) { .week-container { grid-template-columns: repeat(3, 1fr); } }
        /* To już jest obsłużone w głównym bloku media query dla mobile, ale zostawiam dla porządku */
        /* @media (max-width: 900px) { .week-container { grid-template-columns: 1fr; } } */
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="orzeł.png" alt="ZSZ5 Logo" class="logo" onerror="this.style.display='none'">
        <div class="header-text">
            <h1>Plan lekcji - ZSZ5</h1>
            <div id="clock" class="clock">--:--</div>
        </div>
    </div>

    <div class="week-nav" id="week-nav-container" style="display:none">
        <button class="week-nav-btn" onclick="changeWeek(-1)">&#10094;</button>
        <div class="week-display">
            <span class="week-label">Wybrany tydzień</span>
            <span class="week-range" id="week-range-text">...</span>
        </div>
        <button class="week-nav-btn" onclick="changeWeek(1)">&#10095;</button>
    </div>
    
    <div class="controls" id="nav-controls" style="display:none">
        <select id="mode-select" style="display:none"><option value="teacher">Nauczyciel</option><option value="class">Oddział</option><option value="room">Sala</option></select>
        <select id="data-select" style="display:none"></select>
        
        <button class="back-btn" onclick="returnToDashboard()">
            <span>&#8617;</span> MENU GŁÓWNE
        </button>
    </div>
</header>

<div id="debug-bar">Ładowanie systemu...</div>

<div id="dashboard-view">
    <div id="tiles-container">Wczytywanie kafelków...</div>
</div>

<div id="schedule-view">
    <div id="grid" class="week-container"></div>
</div>

<footer>
    <a href="https://www.zsz5.edupage.org" target="_blank">www.zsz5.edupage.org</a>
</footer>

<script>
    // === KONFIGURACJA ===
    const CONFIG = {
        xml: './plan.xml',
        dyzury: './dyzury.xlsx',
        zastepstwa: './zastepstwa.xlsx',
        refreshInterval: 120000, 
        idleTimeout: 45000       
    };

    const DB = {
        teachers: {}, rooms: [], classes: {}, classesList: [], groups: {},
        locations: [], periods: [], lessons: [], duties: [], subs: [], dutyChanges: []
    };

    const DAYS = ["Niedziela", "Poniedziałek", "Wtorek", "Środa", "Czwartek", "Piątek", "Sobota"];
    let refreshTimer = null;
    let idleTimer = null;
    let isDashboardActive = true;
    let weekOffset = 0; 

    window.onload = () => {
        startClock();
        refreshData();
        refreshTimer = setInterval(refreshData, CONFIG.refreshInterval);
        document.addEventListener('mousemove', resetIdle);
        document.addEventListener('click', resetIdle);
        document.addEventListener('touchstart', resetIdle);
    };

    function resetIdle() {
        if (isDashboardActive) return;
        clearTimeout(idleTimer);
        idleTimer = setTimeout(returnToDashboard, CONFIG.idleTimeout);
    }

    function returnToDashboard() {
        isDashboardActive = true;
        weekOffset = 0;
        clearTimeout(idleTimer);
        document.getElementById('dashboard-view').style.display = 'block';
        document.getElementById('schedule-view').style.display = 'none';
        document.getElementById('nav-controls').style.display = 'none';
        document.getElementById('week-nav-container').style.display = 'none';
        document.body.className = '';
        log("Menu Główne");
    }

    function openSchedule(mode, id) {
        isDashboardActive = false;
        weekOffset = 0;
        const modeSel = document.getElementById('mode-select');
        const dataSel = document.getElementById('data-select');
        modeSel.value = mode;
        populateSelect(false);
        dataSel.value = id;
        document.body.className = `mode-${mode}`;

        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('schedule-view').style.display = 'block';
        document.getElementById('nav-controls').style.display = 'flex';
        document.getElementById('week-nav-container').style.display = 'flex';
        
        render();
        resetIdle();
    }

    function changeWeek(direction) {
        weekOffset += direction;
        render();
        resetIdle();
    }

    function getStartOfWeek(date) {
        const d = new Date(date);
        const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }

    function formatDateShort(d) {
        return `${d.getDate()}.${d.getMonth()+1}`;
    }

    async function refreshData() {
        log("Aktualizacja danych...", false);
        DB.lessons = []; DB.periods = []; DB.duties = []; DB.subs = []; DB.dutyChanges = [];
        DB.teachers = {}; DB.classes = {}; DB.classesList = []; DB.rooms = []; DB.groups = {};

        try {
            await loadXML();
            await Promise.all([
                loadExcel(CONFIG.dyzury, 'dyzury').catch(() => {}),
                loadExcel(CONFIG.zastepstwa, 'zastepstwa').catch(() => {})
            ]);
            addMissingTeachers();
            if(isDashboardActive) renderDashboard();
            else { populateSelect(false); render(); }
            log(`Dane zaktualizowane: ${new Date().toLocaleTimeString()}`);
        } catch (e) {
            console.error(e);
            log("Błąd aktualizacji danych!", true);
        }
    }

    function renderDashboard() {
        const container = document.getElementById('tiles-container');
        container.innerHTML = "";
        const createSection = (title, items, type, clickFn) => {
            if(!items.length) return;
            const div = document.createElement('div');
            div.innerHTML = `<div class="section-title">${title}</div>`;
            const grid = document.createElement('div'); grid.className = 'tile-grid';
            items.forEach(item => {
                const tile = document.createElement('div');
                tile.className = `tile ${type}`;
                tile.innerText = item.txt;
                tile.onclick = () => clickFn(item.val);
                grid.appendChild(tile);
            });
            div.appendChild(grid);
            container.appendChild(div);
        };
        const teachers = Object.entries(DB.teachers)
            .sort((a,b) => a[1].name.localeCompare(b[1].name))
            .filter(([id, t]) => !t.name.toLowerCase().includes('wakat'))
            .map(([id, t]) => ({val: id, txt: t.name}));
        createSection("Nauczyciele", teachers, 'teacher', (id) => openSchedule('teacher', id));
        createSection("Sale Lekcyjne", DB.rooms.sort().map(r => ({val: r, txt: r})), 'room', (id) => openSchedule('room', id));
        createSection("Oddziały", DB.classesList.sort().map(c => ({val: c, txt: c})), 'class', (id) => openSchedule('class', id));
    }

    async function fetchFresh(url) {
        const res = await fetch(url + "?t=" + new Date().getTime());
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        return res;
    }
    async function fetchText(url) {
        const res = await fetchFresh(url);
        const blob = await res.blob();
        return new Promise(r => {
            const reader = new FileReader(); 
            reader.onload = () => r(reader.result); 
            reader.readAsText(blob, 'windows-1250'); 
        });
    }
    async function loadExcel(url, type) {
        const res = await fetchFresh(url);
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, {type: 'array'});
        if(type === 'dyzury') parseDuties(wb);
        if(type === 'zastepstwa') parseSub(wb);
    }
    async function loadXML() {
        const txt = await fetchText(CONFIG.xml);
        const xml = new DOMParser().parseFromString(txt, "text/xml");
        xml.querySelectorAll('groups group').forEach(g => { DB.groups[g.getAttribute('id')] = g.getAttribute('name'); });
        xml.querySelectorAll('teachers teacher').forEach(t => {
            const id = t.getAttribute('id');
            const name = (t.getAttribute('firstname')||'') + ' ' + (t.getAttribute('lastname')||t.getAttribute('name'));
            DB.teachers[id] = { name: name.trim(), normalized: normalize(name) };
        });
        xml.querySelectorAll('classes class').forEach(c => {
            const id = c.getAttribute('id'); const name = c.getAttribute('name');
            DB.classes[id] = name; if(!DB.classesList.includes(name)) DB.classesList.push(name);
        });
        const roomMap = {};
        const roomSet = new Set();
        xml.querySelectorAll('classrooms classroom').forEach(r => {
            const name = r.getAttribute('name'); roomMap[r.getAttribute('id')] = name; roomSet.add(name);
        });
        DB.rooms = Array.from(roomSet);
        xml.querySelectorAll('periods period').forEach(p => {
            DB.periods.push({ nr: parseInt(p.getAttribute('period')), start: p.getAttribute('starttime'), end: p.getAttribute('endtime') });
        });
        DB.periods.sort((a,b) => a.nr - b.nr);
        const subjects = {};
        xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));
        
        xml.querySelectorAll('cards card').forEach(c => {
            const lesson = xml.querySelector(`lessons lesson[id="${c.getAttribute('lessonid')}"]`);
            if(!lesson) return;
            const tidsRaw = lesson.getAttribute('teacherids');
            const dayIdx = c.getAttribute('days').indexOf('1') + 1;
            const roomId = c.getAttribute('classroomids');
            const classIds = lesson.getAttribute('classids').split(',');
            const classNames = classIds.map(cid => DB.classes[cid]).join(', ');
            const groupIds = lesson.getAttribute('groupids');
            const groupName = groupIds ? groupIds.split(',').map(gid => DB.groups[gid]).join(',') : '';

            if(dayIdx > 0 && tidsRaw) {
                const tidsArray = tidsRaw.split(',');
                const mainTeacherId = tidsArray[0].trim();
                const supportTeachers = tidsArray.slice(1).map(tid => DB.teachers[tid.trim()]?.name || tid);
                DB.lessons.push({
                    teacherId: mainTeacherId, day: dayIdx, period: parseInt(c.getAttribute('period')),
                    subject: subjects[lesson.getAttribute('subjectid')] || 'Lekcja',
                    room: roomMap[roomId] || '', classNames: classNames, branch: '',
                    groupName: groupName,
                    supportInfo: supportTeachers.length ? supportTeachers.join(', ') : null
                });
            }
        });
    }

    function parseDuties(wb) {
        wb.SheetNames.forEach(sheetName => {
            const ws = wb.Sheets[sheetName];
            const data = XLSX.utils.sheet_to_json(ws, {header: 1});
            let currentDayMap = null;
            for(let i=0; i<data.length; i++) {
                const row = data[i]; if(!row || !row.length) continue;
                const rowStr = row.map(c => String(c||"").toLowerCase());
                if(rowStr.some(s => s.includes('poniedziałek'))) {
                    currentDayMap = {};
                    row.forEach((cell, idx) => {
                        const val = String(cell||"").toLowerCase();
                        if(val.includes('poniedziałek')) currentDayMap[idx]=1;
                        if(val.includes('wtorek')) currentDayMap[idx]=2;
                        if(val.includes('środa')) currentDayMap[idx]=3;
                        if(val.includes('czwartek')) currentDayMap[idx]=4;
                        if(val.includes('piątek')) currentDayMap[idx]=5;
                    });
                    continue;
                }
                if(currentDayMap) {
                    let timeVal=null, placeVal=null;
                    for(let c=0; c<5; c++) {
                        if(row[c] && /\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/.test(String(row[c]))) {
                            timeVal = String(row[c]).trim();
                            if(c>0 && row[c-1]) placeVal=row[c-1]; else if(row[0]) placeVal=row[0]; break;
                        }
                    }
                    if(timeVal) {
                        for(const [colIdx, dayNum] of Object.entries(currentDayMap)) {
                            const rawTeacher = row[colIdx];
                            if(rawTeacher && String(rawTeacher).length>2) {
                                const tId = findTeacherId(String(rawTeacher).trim());
                                if(tId) DB.duties.push({
                                    teacherId: tId, day: dayNum, time: timeVal,
                                    startMin: timeToMin(timeVal.split('-')[0]),
                                    place: placeVal ? placeVal.trim() : "Dyżur"
                                });
                            }
                        }
                    }
                }
            }
        });
    }

    function parseSub(wb) {
        const sh = wb.Sheets["Oddziały"] || wb.Sheets[0];
        XLSX.utils.sheet_to_json(sh).forEach(r => {
            const d = parseDate(r['Dzień']);
            if(d) DB.subs.push({
                date: d, periodRaw: r['Lekcja'],
                absent: findTeacherId(r['Nauczyciel/wakat']),
                sub: findTeacherId(r['Zastępca']),
                rawSub: r['Zastępca'], rawAbs: r['Nauczyciel/wakat'],
                subject: r['Przedmiot'], room: r['Sala'], note: r['Uwagi'],
                branch: r['Oddział'], payInfo: r['Forma płatności']
            });
        });
        const shDy = wb.Sheets["Dyżury"];
        if(shDy) {
            XLSX.utils.sheet_to_json(shDy).forEach(r => {
                const d = parseDate(r['Dzień']);
                if(d) DB.dutyChanges.push({
                    date: d, time: r['Godzina'],
                    absent: findTeacherId(r['Nauczyciel']), sub: findTeacherId(r['Zastępca']),
                    rawSub: r['Zastępca'], place: r['Miejsce dyżuru']
                });
            });
        }
    }

    function normalize(str) { return (str||"").toLowerCase().replace(/^(x\.|ks\.|p\.|pani|pan)\s+/g, '').replace(/[^a-złąceźżńóś\s]/g, '').trim().split(/\s+/).sort().join(' '); }
    function levenshtein(a, b) { const m = []; for(let i=0; i<=b.length; i++) m[i]=[i]; for(let j=0; j<=a.length; j++) m[0][j]=j; for(let i=1; i<=b.length; i++) for(let j=1; j<=a.length; j++) m[i][j] = b.charAt(i-1)===a.charAt(j-1) ? m[i-1][j-1] : Math.min(m[i-1][j-1]+1, Math.min(m[i][j-1]+1, m[i-1][j]+1)); return m[b.length][a.length]; }
    function findTeacherId(rawName) {
        if(!rawName || rawName.length<3) return null; if(/wakat|brak|okienko/i.test(rawName)) return null;
        const target = normalize(rawName); let bestId = null, bestScore = 0;
        for(const [id, t] of Object.entries(DB.teachers)) {
            const source = t.normalized;
            if(source === target) return id;
            if(source.includes(target) || target.includes(source)) { if(bestScore<50) { bestScore=50; bestId=id; } }
            const dist = levenshtein(source, target);
            if(dist <= 2 && source.length>4 && bestScore<80) { bestScore=80; bestId=id; }
        }
        return bestId;
    }
    function timeToMin(str) { if(!str) return 0; const [h,m] = str.trim().split(':').map(Number); return h*60+m; }
    function parseDate(val) {
        if(!val) return null;
        if(typeof val === 'number') { const d = XLSX.SSF.parse_date_code(val); return `${d.y}-${d.m<10?'0':''}${d.m}-${d.d<10?'0':''}${d.d}`; }
        if(typeof val === 'string') { const p = val.trim().split('.'); if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`; }
        return null;
    }
    function getTeacherName(id) { return DB.teachers[id] ? DB.teachers[id].name : id; }
    function normalizeClass(c) { return (c || "").replace(/\s/g, '').toLowerCase(); }
    function addMissingTeachers() {
        const check = (raw, obj, f) => { if(raw && !obj[f]) { const nid="EXT_"+normalize(raw).replace(/\s/g,'_'); if(!DB.teachers[nid]) DB.teachers[nid]={name:raw.trim(),normalized:normalize(raw)}; obj[f]=nid; }};
        DB.subs.forEach(s => check(s.rawSub, s, 'sub')); DB.dutyChanges.forEach(d => check(d.rawSub, d, 'sub'));
    }

    function populateSelect(renderIt=true) {
        const mode = document.getElementById('mode-select').value;
        const sel = document.getElementById('data-select');
        sel.innerHTML = "";
        let items = [];
        if (mode === 'teacher') items = Object.entries(DB.teachers).sort((a,b) => a[1].name.localeCompare(b[1].name)).map(x => ({val: x[0], txt: x[1].name}));
        else if (mode === 'room') items = DB.rooms.sort().map(x => ({val: x, txt: x}));
        else if (mode === 'class') items = DB.classesList.sort().map(x => ({val: x, txt: x}));
        items.forEach(i => {
            const opt = document.createElement('option'); opt.value = i.val; opt.innerText = i.txt; sel.appendChild(opt);
        });
        if(items.length && !sel.value) sel.value = items[0].val;
    }

    function getDutiesForTime(tid, day, date, min, max) {
        const res = [];
        DB.duties.filter(d => d.teacherId==tid && d.day==day).forEach(d => {
            if(d.startMin >= min && d.startMin < max) {
                const canc = DB.dutyChanges.find(c => c.date==date && c.time==d.time && c.absent==tid);
                res.push({...d, status: canc?'cancelled':'ok'});
            }
        });
        DB.dutyChanges.filter(c => c.date==date && c.sub==tid).forEach(c => {
            const start = timeToMin(c.time.split('-')[0]);
            if(start >= min && start < max) res.push({ time: c.time, place: c.place, startMin: start, status: 'added' });
        });
        return res;
    }

    function render() {
        const mode = document.getElementById('mode-select').value;
        const selectedId = document.getElementById('data-select').value;
        const grid = document.getElementById('grid');
        grid.innerHTML = "";
        if(!selectedId) return;
        
        const today = new Date();
        today.setDate(today.getDate() + (weekOffset * 7));
        const monday = getStartOfWeek(today);

        const friday = new Date(monday); friday.setDate(friday.getDate() + 4);
        document.getElementById('week-range-text').innerText = 
            `${formatDateShort(monday)} - ${formatDateShort(friday)}`;

        for(let i=0; i<5; i++) {
            const curDate = new Date(monday); curDate.setDate(monday.getDate() + i);
            const dateStr = curDate.toISOString().split('T')[0];
            const dayNum = i + 1;
            const col = document.createElement('div'); col.className = 'day-col';
            col.innerHTML = `<div class="day-header">${DAYS[dayNum]}<span class="day-date">${curDate.toLocaleDateString('pl-PL')}</span></div>`;
            const content = document.createElement('div'); content.className = 'day-content';

            if (mode === 'teacher') {
                getDutiesForTime(selectedId, dayNum, dateStr, 0, 480).forEach(d => {
                    const div = document.createElement('div'); div.className = 'card morning-duty'; 
                    if(d.status==='added') div.classList.add('duty-sub');
                    if(d.status==='cancelled') div.style.textDecoration='line-through';
                    div.innerHTML = `<div style="font-weight:700">${d.status==='added'?'ZASTĘPSTWO':'DYŻUR'} ${d.time}</div><div>${d.place}</div>`;
                    content.appendChild(div);
                });
            }

            DB.periods.forEach(p => {
                const wrapper = document.createElement('div'); wrapper.className = 'slot-wrapper';
                let lessons = [];
                if (mode === 'teacher') lessons = DB.lessons.filter(l => l.teacherId == selectedId && l.day == dayNum && l.period == p.nr);
                else if (mode === 'room') lessons = DB.lessons.filter(l => l.room === selectedId && l.day == dayNum && l.period == p.nr);
                else if (mode === 'class') lessons = DB.lessons.filter(l => l.classNames.includes(selectedId) && l.day == dayNum && l.period == p.nr);
                
                let subAdds = [];
                if (mode === 'teacher') subAdds = DB.subs.filter(s => s.date == dateStr && s.sub == selectedId && s.periodRaw.startsWith(p.nr+','));
                else if (mode === 'room') subAdds = DB.subs.filter(s => s.date == dateStr && s.room === selectedId && s.periodRaw.startsWith(p.nr+','));
                else if (mode === 'class') subAdds = DB.subs.filter(s => s.date == dateStr && normalizeClass(s.branch).includes(normalizeClass(selectedId)) && s.periodRaw.startsWith(p.nr+','));

                lessons.sort((a,b) => (a.groupName||"").localeCompare(b.groupName||""));

                if(lessons.length > 0) {
                    lessons.forEach(lesson => {
                        const div = document.createElement('div');
                        const subAbs = DB.subs.find(s => s.date == dateStr && s.absent == lesson.teacherId && s.periodRaw.startsWith(p.nr+','));

                        if(subAbs) {
                            div.className = 'card is-sub';
                            div.innerHTML = `
                                <div class="meta">
                                    <span class="nr">${p.nr}</span> ${p.start}-${p.end}
                                    ${lesson.groupName ? `<span class="group-badge">${lesson.groupName}</span>` : ''}
                                </div>
                                <div class="main-info">${lesson.subject}</div>
                                <span class="note-red">Nieobecność</span>`;
                        } else {
                            div.className = 'card';
                            let line = "";
                            if(mode === 'teacher') line = `${lesson.classNames} / s.${lesson.room}`;
                            else if(mode === 'room') line = `${lesson.classNames} / ${getTeacherName(lesson.teacherId)}`;
                            else line = `${getTeacherName(lesson.teacherId)} / s.${lesson.room}`;
                            
                            div.innerHTML = `
                                <div class="meta">
                                    <span class="nr">${p.nr}</span> ${p.start}-${p.end}
                                    ${lesson.groupName ? `<span class="group-badge">${lesson.groupName}</span>` : ''}
                                </div>
                                <div class="main-info">${lesson.subject}</div>
                                <div class="sub-line">${line}</div>`;
                        }
                        wrapper.appendChild(div);
                    });
                }

                if(subAdds.length > 0) {
                    subAdds.forEach(sub => {
                        let subGroup = "";
                        if(sub.branch && sub.branch.includes('|')) subGroup = sub.branch.split('|')[1];
                        const div = document.createElement('div');
                        div.className = 'card is-new';
                        let line = mode==='teacher' ? `s.${sub.room} / ${sub.branch}` : `${getTeacherName(sub.sub)}`;
                        div.innerHTML = `
                            <div class="meta">
                                <span class="nr">${p.nr}</span> ${p.start}-${p.end}
                                ${subGroup ? `<span class="group-badge">${subGroup}</span>` : ''}
                            </div>
                            <div class="main-info">ZASTĘPSTWO</div>
                            <div class="sub-line">${line} / ${sub.subject}</div>
                            <div class="details" style="font-size:0.75em; color:#a7f3d0">Za: ${sub.rawAbs}</div>`;
                        wrapper.appendChild(div);
                    });
                }

                if(lessons.length === 0 && subAdds.length === 0) {
                     const div = document.createElement('div');
                     div.className = 'card empty'; 
                     div.innerHTML = `${p.nr}. ${p.start}`;
                     wrapper.appendChild(div);
                }
                
                if(mode === 'teacher') {
                    const pEnd = timeToMin(p.end);
                    getDutiesForTime(selectedId, dayNum, dateStr, pEnd-5, pEnd+15).forEach(d => {
                        const dDiv = document.createElement('div'); dDiv.className = 'duty-section';
                        if(d.status === 'added') dDiv.classList.add('duty-sub');
                        dDiv.innerHTML = `<b>${d.time}</b> ${d.place}`;
                        wrapper.appendChild(dDiv);
                    });
                }
                content.appendChild(wrapper);
            });
            col.appendChild(content); grid.appendChild(col);
        }
    }

    function startClock() {
        const update = () => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleString('pl-PL', { weekday:'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
        };
        update(); setInterval(update, 1000);
    }
    function log(msg, err=false) { const el = document.getElementById('debug-bar'); el.innerText = msg; el.style.color = err ? '#ef4444' : '#64748b'; }
</script>
</body>
</html>
