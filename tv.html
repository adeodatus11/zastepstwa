<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1080, initial-scale=1.0">
    <title>ZSZ5 TV - Plan Lekcji</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        /* --- BAZA I CIEMNY MOTYW (DLA TV) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: #121212; /* Bardzo ciemne tło */
            color: #e0e0e0;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            width: 1080px;
            height: 1920px;
            overflow: hidden; /* Ukrywamy paski przewijania */
            display: flex;
            flex-direction: column;
        }

        /* --- NAGŁÓWEK --- */
        header {
            height: 130px;
            background: linear-gradient(90deg, #0d47a1 0%, #1565c0 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            border-bottom: 6px solid #ffca28; /* Akcent */
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .header-left h1 { font-size: 2.8rem; text-transform: uppercase; letter-spacing: 2px; margin: 0; }
        .header-left h2 { font-size: 1.2rem; color: #90caf9; font-weight: 400; margin-top: 5px; }
        
        .clock-container { text-align: right; }
        .clock-time { font-size: 3rem; font-weight: 700; font-family: monospace; line-height: 1; color: #fff; }
        .clock-date { font-size: 1.2rem; color: #bbdefb; text-transform: uppercase; margin-top: 5px; }

        /* --- KONTENER GŁÓWNY --- */
        #slide-container {
            flex: 1; /* Zajmuje resztę ekranu */
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px; /* Odstęp między klasami */
        }

        /* --- KARTA KLASY --- */
        .class-card {
            flex: 1; /* Każda z 3 kart zajmuje równą wysokość */
            background-color: #1e1e1e;
            border-radius: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-left: 12px solid #2196f3;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }

        .class-header {
            background-color: #2c2c2c;
            padding: 12px 25px;
            font-size: 2rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #444;
        }
        .class-name { color: #64b5f6; font-size: 2.4rem; }

        /* --- TABELA LEKCJI --- */
        .lesson-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.3rem; /* Duża czytelna czcionka */
        }
        
        .lesson-table th {
            text-align: left;
            padding: 8px 15px;
            color: #777;
            font-size: 0.9rem;
            text-transform: uppercase;
            border-bottom: 1px solid #444;
        }

        .lesson-table td {
            padding: 10px 15px;
            border-bottom: 1px solid #333;
            vertical-align: middle;
        }

        .col-nr { width: 50px; color: #777; font-weight: bold; text-align: center; }
        .col-subj { font-weight: 600; color: #fff; }
        .col-room { width: 100px; text-align: center; font-weight: bold; color: #ffca28; }
        .col-teach { width: 300px; font-size: 0.85em; color: #aaa; text-align: right; }

        /* --- STYL ZASTĘPSTW --- */
        .row-sub { background-color: #311b1b; } /* Lekkie czerwonawy tło */
        .row-sub .col-subj { color: #ef5350; } /* Czerwony przedmiot */
        .row-sub .col-teach { color: #e57373; }

        .row-new { background-color: #1b3320; } /* Lekkie zielone tło */
        .row-new .col-subj { color: #66bb6a; }

        .badge {
            display: inline-block; padding: 2px 6px; border-radius: 4px; 
            font-size: 0.6em; font-weight: bold; vertical-align: middle; margin-right: 6px;
            transform: translateY(-2px);
        }
        .badge-sub { background: #c62828; color: white; }
        .badge-canc { background: #424242; color: #aaa; text-decoration: line-through; }

        .cancelled-text { text-decoration: line-through; opacity: 0.5; }

        /* --- STOPKA I STATUS --- */
        footer {
            height: 50px;
            background-color: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 40px;
            font-size: 0.9rem;
            color: #666;
        }

        .fullscreen-msg {
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            color: #555;
            flex-direction: column;
            text-align: center;
        }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <h1>PLAN LEKCJI</h1>
        <h2 id="day-info">...</h2>
    </div>
    <div class="clock-container">
        <div id="clock-time" class="clock-time">--:--</div>
        <div id="clock-date" class="clock-date">--.--.----</div>
    </div>
</header>

<div id="slide-container">
    <div class="fullscreen-msg">
        <div>Ładowanie danych...</div>
        <div style="font-size:1rem; margin-top:20px">Pobieranie XML i Zastępstw</div>
    </div>
</div>

<footer>
    <div>ZSZ5 Wrocław • System Informacji Cyfrowej</div>
    <div>Odświeżanie danych: 2 min</div>
</footer>

<script>
    // === KONFIGURACJA ===
    const CONFIG = {
        xml: './plan.xml',
        zastepstwa: './zastepstwa.xlsx',
        refreshInterval: 2 * 60 * 1000, // 2 minuty
        slideDuration: 10 * 1000        // 10 sekund na jeden slajd (3 klasy)
    };

    const DB = {
        classes: {},     // Mapa ID -> Nazwa
        classesList: [], // Lista nazw
        lessons: [],     // Wszystkie lekcje
        subs: []         // Zastępstwa
    };

    let groupedClasses = [];
    let currentSlideIndex = 0;
    let carouselInterval = null;

    // === START ===
    window.onload = async () => {
        startClock();
        await reloadData();

        // Automatyczne przeładowanie całej strony co 2 minuty
        setInterval(() => {
            console.log("Auto-odświeżanie strony...");
            window.location.reload();
        }, CONFIG.refreshInterval);
    };

    // === POBIERANIE DANYCH ===
    async function reloadData() {
        try {
            await loadXML();
            // Próbujemy wczytać zastępstwa (cache busting jest wewnątrz funkcji)
            await loadExcel(CONFIG.zastepstwa).catch(e => console.warn("Brak pliku zastępstw:", e));
            
            initCarousel();
        } catch (e) {
            document.getElementById('slide-container').innerHTML = 
                `<div class="fullscreen-msg" style="color:#ef5350">
                    Błąd danych<br><span style="font-size:1.5rem">${e.message}</span>
                 </div>`;
        }
    }

    // === KARUZELA KLAS ===
    function initCarousel() {
        const today = new Date();
        const dayOfWeek = today.getDay(); // 0-ND, 1-PN
        
        // Ustawienie nagłówka dnia
        const daysPL = ["NIEDZIELA", "PONIEDZIAŁEK", "WTOREK", "ŚRODA", "CZWARTEK", "PIĄTEK", "SOBOTA"];
        document.getElementById('day-info').innerText = daysPL[dayOfWeek];

        // 1. Weekend?
        if(dayOfWeek === 0 || dayOfWeek === 6) {
            document.getElementById('slide-container').innerHTML = 
                `<div class="fullscreen-msg">WEEKEND<br><span style="font-size:2rem;color:#777">Szkoła zamknięta</span></div>`;
            return;
        }

        // 2. Filtrujemy klasy, które mają dzisiaj lekcje
        const activeClasses = [];
        DB.classesList.sort().forEach(className => {
            // Sprawdź czy klasa ma lekcje w XML w tym dniu
            const hasLessons = DB.lessons.some(l => l.day === dayOfWeek && normalize(l.className) === normalize(className));
            if(hasLessons) activeClasses.push(className);
        });

        if(activeClasses.length === 0) {
            document.getElementById('slide-container').innerHTML = 
                `<div class="fullscreen-msg">BRAK ZAJĘĆ<br><span style="font-size:2rem;color:#777">W dniu dzisiejszym</span></div>`;
            return;
        }

        // 3. Dzielimy na grupy po 3 (bo tyle mieści się na ekranie)
        groupedClasses = [];
        for (let i = 0; i < activeClasses.length; i += 3) {
            groupedClasses.push(activeClasses.slice(i, i + 3));
        }

        // 4. Start
        currentSlideIndex = 0;
        renderSlide();
        
        if(carouselInterval) clearInterval(carouselInterval);
        carouselInterval = setInterval(() => {
            currentSlideIndex++;
            if(currentSlideIndex >= groupedClasses.length) currentSlideIndex = 0;
            renderSlide();
        }, CONFIG.slideDuration);
    }

    function renderSlide() {
        const container = document.getElementById('slide-container');
        const classesToShow = groupedClasses[currentSlideIndex];
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        const dayOfWeek = today.getDay();

        let html = '';

        classesToShow.forEach(clsName => {
            html += `<div class="class-card">`;
            html += `<div class="class-header"><span>${clsName}</span></div>`;
            
            html += `<table class="lesson-table">`;
            //html += `<thead><tr><th>Nr</th><th>Przedmiot</th><th>Sala</th><th>Nauczyciel</th></tr></thead>`;
            html += `<tbody>`;

            // Pobierz lekcje bazowe
            const lessons = DB.lessons.filter(l => l.day === dayOfWeek && normalize(l.className) === normalize(clsName));
            
            // Renderuj sloty 1-9 (lub mniej jeśli wolisz)
            // Filtrujemy puste sloty na początku i końcu, żeby tabela była zwarta? 
            // Dla TV lepiej pokazać sztywny zakres np. 1-8 lub dynamiczny. 
            // Tutaj: sztywno 1-8 (najczęstsze godziny)
            for(let i=1; i<=9; i++) {
                let lesson = lessons.find(l => l.period === i);
                let sub = DB.subs.find(s => s.date === dateStr && normalize(s.branch) === normalize(clsName) && s.periodRaw.startsWith(i+','));

                if(sub) {
                    // ZASTĘPSTWO
                    const isCancelled = sub.sub === null && sub.note && sub.note.toLowerCase().includes('odwoł');
                    
                    html += `<tr class="row-sub">`;
                    html += `<td class="col-nr">${i}</td>`;
                    
                    if(sub.subject === 'Okienko' || isCancelled) {
                        html += `<td class="col-subj cancelled-text">${lesson ? lesson.subject : 'Lekcja'}</td>`;
                        html += `<td class="col-room">-</td>`;
                        html += `<td class="col-teach"><span class="badge badge-sub">ODWOŁANE</span></td>`;
                    } else {
                        html += `<td class="col-subj"><span class="badge badge-sub">ZAST</span> ${sub.subject}</td>`;
                        html += `<td class="col-room">${sub.room || '?'}</td>`;
                        html += `<td class="col-teach">${sub.rawSub}</td>`;
                    }
                    html += `</tr>`;

                } else if (lesson) {
                    // ZWYKŁA LEKCJA
                    // Sprawdzamy, czy nauczyciel nie ma nieobecności (bez przypisanego zastępstwa dla klasy)
                    const teacherAbsence = DB.subs.find(s => s.date === dateStr && s.absentId === lesson.teacherIdRaw); 
                    // ^ To wymagałoby mapowania ID. W trybie TV upraszczamy:
                    // Jeśli w pliku oddziały nie ma wiersza dla tej klasy i tej godziny, to zakładamy że lekcja jest ok.
                    
                    html += `<tr>`;
                    html += `<td class="col-nr">${i}</td>`;
                    html += `<td class="col-subj">${lesson.subject}</td>`;
                    html += `<td class="col-room">${lesson.room}</td>`;
                    html += `<td class="col-teach">${lesson.teacherName}</td>`;
                    html += `</tr>`;
                }
            }
            html += `</tbody></table></div>`;
        });

        container.innerHTML = html;
    }

    // === FETCH & PARSE (Z CACHE BUSTING) ===
    
    async function fetchFresh(url) {
        return fetch(url + "?t=" + new Date().getTime());
    }

    async function loadXML() {
        const res = await fetchFresh(FILES.xml);
        const txt = await res.text();
        const xml = new DOMParser().parseFromString(txt, "text/xml");

        // Mapy
        const teachers = {};
        xml.querySelectorAll('teachers teacher').forEach(t => {
            const name = (t.getAttribute('firstname')||'') + ' ' + (t.getAttribute('lastname')||t.getAttribute('name'));
            teachers[t.getAttribute('id')] = name.trim();
        });

        const rooms = {};
        xml.querySelectorAll('classrooms classroom').forEach(r => rooms[r.getAttribute('id')] = r.getAttribute('name'));

        const subjects = {};
        xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));

        // Klasy
        DB.classes = {}; DB.classesList = [];
        xml.querySelectorAll('classes class').forEach(c => {
            const name = c.getAttribute('name');
            DB.classes[c.getAttribute('id')] = name;
            DB.classesList.push(name);
        });

        // Lekcje
        DB.lessons = [];
        xml.querySelectorAll('cards card').forEach(c => {
            const lesson = xml.querySelector(`lessons lesson[id="${c.getAttribute('lessonid')}"]`);
            if(!lesson) return;
            
            const tids = lesson.getAttribute('teacherids').split(',');
            const classIds = lesson.getAttribute('classids').split(',');
            const subject = subjects[lesson.getAttribute('subjectid')];
            const room = rooms[c.getAttribute('classroomids')] || '';
            const dayIdx = c.getAttribute('days').indexOf('1') + 1;
            const period = parseInt(c.getAttribute('period'));

            classIds.forEach(cid => {
                const className = DB.classes[cid];
                if(dayIdx > 0 && className) {
                    DB.lessons.push({
                        day: dayIdx,
                        period: period,
                        className: className,
                        subject: subject,
                        room: room,
                        teacherName: teachers[tids[0].trim()],
                        teacherIdRaw: tids[0].trim()
                    });
                }
            });
        });
    }

    async function loadExcel(url) {
        const res = await fetchFresh(url);
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, {type: 'array'});
        
        const sheet = wb.Sheets["Oddziały"] || wb.Sheets[0];
        const data = XLSX.utils.sheet_to_json(sheet);
        
        DB.subs = [];
        data.forEach(r => {
            const dStr = r['Dzień']; 
            let isoDate = null;
            if(typeof dStr === 'number') {
                const d = XLSX.SSF.parse_date_code(dStr);
                isoDate = `${d.y}-${pad(d.m)}-${pad(d.d)}`;
            } else if (typeof dStr === 'string') {
                const p = dStr.split('.');
                if(p.length===3) isoDate = `${p[2]}-${p[1]}-${p[0]}`;
            }

            if(isoDate) {
                DB.subs.push({
                    date: isoDate,
                    periodRaw: r['Lekcja'], 
                    branch: r['Oddział'],
                    subject: r['Przedmiot'],
                    room: r['Sala'],
                    rawSub: r['Zastępca'],
                    subName: r['Zastępca'], 
                    note: r['Uwagi']
                });
            }
        });
    }

    // === ZEGAR ===
    function startClock() {
        const update = () => {
            const now = new Date();
            document.getElementById('clock-time').innerText = now.toLocaleTimeString('pl-PL', {hour:'2-digit', minute:'2-digit'});
            document.getElementById('clock-date').innerText = now.toLocaleDateString('pl-PL');
        };
        update(); setInterval(update, 1000);
    }

    function normalize(str) { return (str||"").toLowerCase().replace(/\s/g, ''); }
    function pad(n) { return n<10?'0'+n:n; }

</script>

</body>
</html>
