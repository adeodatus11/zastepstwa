<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Plan lekcji - Panel Kiosk</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            /* --- PALETA DARK FOREST --- */
            --bg: #020617;
            --text-main: #e2e8f0;
            --card-bg: #111827;
            
            /* Akcenty Kategorii */
            --accent-teacher: #22c55e;
            --accent-class: #38bdf8;
            --accent-room: #fbbf24;
            --accent-duty: #f472b6;

            /* Elementy UI */
            --tile-bg: #0f172a;
            --tile-border: #1e293b;

            /* Paski boczne planu */
            --lesson-border: #16a34a;
            --room-border: #d97706;     
            --class-border: #0284c7;    
            --duty-border: #db2777;

            /* Statusy */
            --sub-bg: #450a0a; --sub-color: #fca5a5; --sub-border: #ef4444;
            --new-bg: #064e3b; --new-color: #4ade80; --new-border: #22c55e;
            
            /* NOWO≈öƒÜ: Transfery (Jasny Niebieski) */
            --trans-bg: #083344; /* Bardzo ciemny b≈Çƒôkit t≈Ça */
            --trans-color: #bae6fd; /* Jasny b≈Çƒôkit tekstu */
            --trans-border: #0ea5e9; /* Sky blue pasek */

            /* P≈Çatno≈õci */
            --pay-bg: #451a03; --pay-text: #fbbf24; --pay-border: #f59e0b;

            /* Dy≈ºury */
            --duty-bg: #3f2c06; --duty-color: #fcd34d;
            --duty-sub-bg: #14532d; --duty-sub-border: #4ade80; --duty-sub-color: #dcfce7;

            --empty: #1f2937;
            --header-height-desktop: 134px; 
            --header-height-mobile: 130px; 

            /* --- NOWE STYLE DLA NAG≈Å√ìWKA --- */
        .lesson-indicator {
            font-size: 1.2rem;
            font-weight: 800;
            color: #fbbf24; /* Bursztynowy */
            text-transform: uppercase;
            margin-top: 5px;
            letter-spacing: 1px;
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.3);
            min-height: 24px; /* ≈ªeby nie skaka≈Ço jak puste */
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 0, 0, 0.25);
            padding: 8px 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            margin-left: auto; /* Dopycha do prawej */
        }

        .qr-text {
            text-align: right;
            font-size: 0.85rem;
            line-height: 1.3;
            color: #e2e8f0;
            font-weight: 600;
        }

        .qr-img {
            height: 75px;
            width: auto;
            border-radius: 6px;
            border: 2px solid white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        /* Ukryj QR na telefonach (bo po co skanowaƒá telefonem telefon) */
        @media (max-width: 900px) {
            .header-right { display: none; }
        }
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg); margin: 0; padding: 0; 
            color: var(--text-main); display: flex; flex-direction: column; min-height: 100vh;
        }

        /* --- NAG≈Å√ìWEK --- */
        header { 
            background: linear-gradient(to right, #4dff88 0%, #33cc66 30%, #020617 100%);
            color: white; padding: 10px 30px; 
            position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            display: flex; justify-content: space-between; align-items: center;
            min-height: 110px; border-bottom: 4px solid #22c55e;
            flex-wrap: wrap; box-sizing: border-box;
        }

        .header-left { display: flex; align-items: center; gap: 20px; }
        .logo { height: 85px; width: auto; mix-blend-mode: multiply; filter: contrast(1.1); }
        .header-text { display: flex; flex-direction: column; justify-content: center; }
        .header-text h1 { margin: 0; font-size: 1.6rem; font-weight: 800; text-transform: uppercase; text-shadow: 0 2px 4px rgba(0,0,0,0.4); }
        .clock { font-family: 'Consolas', monospace; font-size: 1.1rem; color: #f0fdf4; margin-top: 4px; font-weight: 600; }
        
        .selection-info {
            font-size: 1.4rem; font-weight: 700; color: #fbbf24; margin-top: 5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8); display: none; 
            text-transform: uppercase; letter-spacing: 0.5px;
        }

        .week-nav {
            display: flex; align-items: center; gap: 20px;
            background: rgba(0, 0, 0, 0.25); padding: 8px 20px;
            border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        .week-nav-btn {
            background: none; border: none; color: #4ade80;
            font-size: 2rem; cursor: pointer; padding: 0 10px;
            transition: transform 0.2s, color 0.2s; line-height: 1;
        }
        .week-nav-btn:hover { color: #fff; transform: scale(1.2); }
        .week-display { display: flex; flex-direction: column; align-items: center; min-width: 180px; }
        .week-label { font-size: 0.7rem; text-transform: uppercase; color: #a7f3d0; letter-spacing: 1px; }
        .week-range { font-family: 'Consolas', monospace; font-size: 1.3rem; font-weight: 700; color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }

        .controls { display: flex; gap: 15px; align-items: center; }
        button.back-btn {
            background: #b91c1c; color: white; border: 1px solid #ef4444; 
            padding: 10px 20px; border-radius: 8px; cursor: pointer; 
            font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: all 0.2s; text-transform: uppercase;
        }
        button.back-btn:hover { background: #dc2626; transform: translateY(-2px); }

        /* --- DASHBOARD: SELECT CARDS --- */
        #dashboard-view { 
            padding: 40px; display: block; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; 
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr); 
            gap: 30px;
            margin-bottom: 40px;
        }

        .selection-card {
            background: #1e293b;
            border-radius: 16px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            border-top: 6px solid #475569;
            transition: transform 0.3s;
        }
        .selection-card:hover { transform: translateY(-5px); }

        .selection-card.teacher { border-top-color: var(--accent-teacher); background: linear-gradient(180deg, #1e293b 0%, #064e3b 100%); }
        .selection-card.class { border-top-color: var(--accent-class); background: linear-gradient(180deg, #1e293b 0%, #0c4a6e 100%); }
        .selection-card.room { border-top-color: var(--accent-room); background: linear-gradient(180deg, #1e293b 0%, #451a03 100%); }
        .selection-card.duty { border-top-color: var(--accent-duty); background: linear-gradient(180deg, #1e293b 0%, #831843 100%); }

        .card-icon { font-size: 3rem; margin-bottom: 10px; }
        .card-title { 
            font-size: 1.5rem; font-weight: 800; text-transform: uppercase; 
            margin-bottom: 20px; color: white; letter-spacing: 1px; text-align: center;
        }

        .main-select {
            width: 100%; padding: 12px 15px; font-size: 1.1rem;
            background-color: rgba(0,0,0,0.3); color: white;
            border: 2px solid rgba(255,255,255,0.2); border-radius: 8px;
            cursor: pointer; outline: none;
        }
        .main-select:focus { border-color: white; }
        .main-select option { background-color: #1e293b; }

        /* --- OG≈ÅOSZENIA --- */
        #announcements-container {
            background: rgba(15, 23, 42, 0.8);
            border-radius: 16px; border: 1px solid #334155;
            padding: 30px; text-align: center; min-height: 200px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .anno-title { font-size: 1.5rem; color: #94a3b8; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 2px; }
        .anno-content { font-size: 1.8rem; color: #e2e8f0; font-weight: 300; line-height: 1.5; }
        .countdown { font-family: 'Consolas', monospace; font-size: 3rem; color: #4ade80; font-weight: bold; margin-top: 10px; }

        /* --- MOBILE HEADER & LAYOUT --- */
        @media (max-width: 900px) {
            header {
                flex-direction: row; flex-wrap: wrap; align-content: flex-start;
                height: auto; padding: 10px;
                background: linear-gradient(to bottom, #4dff88 0%, #020617 100%);
            }
            .header-left { width: 100%; flex-direction: row; justify-content: flex-start; align-items: center; gap: 10px; margin-bottom: 8px; }
            .logo { height: 50px; margin-right: 0; }
            .header-text { alignItems: flex-start; text-align: left; flex: 1; }
            .header-text h1 { font-size: 1.1rem; line-height: 1.1; margin-bottom: 2px; }
            .clock { font-size: 0.85rem; }
            
            .selection-info { font-size: 1rem; color: #fbbf24; margin: 2px 0; background: rgba(0,0,0,0.4); padding: 2px 8px; border-radius: 4px; display: inline-block; }

            .week-nav { 
                order: 2; flex: 6; justify-content: space-between; 
                margin-top: 0; padding: 4px 8px; gap: 5px; height: 42px; 
                box-sizing: border-box;
            }
            .week-display { min-width: auto; } .week-label { display: none; } .week-range { font-size: 0.95rem; white-space: nowrap; } .week-nav-btn { font-size: 1.4rem; padding: 0 5px; }

            .controls { order: 3; flex: 4; margin-top: 0; justify-content: flex-end; margin-left: 10px; }
            button.back-btn { width: 100%; justify-content: center; padding: 0 10px; height: 42px; font-size: 0.8rem; white-space: nowrap; }
            
            .selection-grid { grid-template-columns: 1fr; gap: 15px; }
            .selection-card { flex-direction: row; justify-content: space-between; padding: 15px; align-items: center; }
            .card-icon { font-size: 2rem; margin-bottom: 0; margin-right: 15px; }
            .card-title { font-size: 1.2rem; margin-bottom: 0; text-align: left; flex: 1; }
            .main-select { width: 50%; padding: 8px; font-size: 1rem; }

            #dashboard-view { padding: 15px; }
            .week-container { grid-template-columns: 1fr !important; }
            .day-header { top: var(--header-height-mobile) !important; }
            
            .anno-content { font-size: 1.2rem; }
            .countdown { font-size: 2rem; }
        }

        #debug-bar { background: #111827; font-size: 0.75rem; padding: 4px 20px; color: #64748b; border-bottom: 1px solid #1f2937; text-align: center; letter-spacing: 1px; }

        /* --- PLAN LEKCJI --- */
        #schedule-view { display: none; width: 100%; padding-bottom: 40px; }
        .week-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 20px; align-items: start; }
        .day-col { background: #1e293b; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); display: flex; flex-direction: column; border: 1px solid #334155; }
        .day-header {
            background: linear-gradient(to bottom, #065f46, #064e3b); color: #ecfdf5; 
            padding: 15px; text-align: center; font-weight: 700; border-bottom: 1px solid #047857; text-transform: uppercase; letter-spacing: 1px;
            position: sticky; top: var(--header-height-desktop); z-index: 900; border-top-left-radius: 10px; border-top-right-radius: 10px;
        }
        .day-date { font-weight: 400; font-size: 0.8em; color: #a7f3d0; display: block; margin-top: 4px; }
        .day-content { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
        .slot-wrapper { border: 1px solid #334155; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; gap: 0px; background: #0f172a; }

        .card { background: var(--card-bg); border-left: 4px solid var(--lesson-border); color: #e2e8f0; padding: 10px 12px; min-height: 55px; display: flex; flex-direction: column; gap: 3px; border-bottom: 1px solid #334155; position: relative; }
        .card:last-child { border-bottom: none; }
        .card.empty { background: var(--empty); border-left-color: #4b5563; color: #64748b; display: flex; align-items: center; justify-content: center; font-style: italic; font-size: 0.85rem; min-height: 40px; }
        
        body.mode-room .card { border-left-color: var(--room-border); }
        body.mode-class .card { border-left-color: var(--class-border); }
        body.mode-duty .card { border-left-color: var(--duty-border); }

        .meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: #94a3b8; margin-bottom: 2px; font-weight: 600; }
        .nr { background: #334155; padding: 1px 6px; border-radius: 4px; color: #f1f5f9; }
        .main-info { font-weight: 700; font-size: 1rem; color: #f8fafc; }
        .sub-line { font-weight: 500; font-size: 0.9rem; color: #cbd5e1; margin-top: 2px; }
        .group-badge { display: inline-block; background: #334155; color: #e2e8f0; font-size: 0.7rem; padding: 1px 6px; border-radius: 4px; margin-left: 6px; font-weight: bold; vertical-align: middle; border: 1px solid #475569; }

        /* STATUSY */
        .is-sub { background: var(--sub-bg); border-left-color: var(--sub-border) !important; }
        .is-sub .main-info { text-decoration: line-through; opacity: 0.6; color: #fca5a5; }
        .note-red { color: #f87171; font-weight: 700; font-size: 0.8rem; text-transform: uppercase; }
        
        .is-new { background: var(--new-bg); border-left-color: var(--new-border) !important; }
        .is-new .main-info { color: #86efac; }
        .is-new .sub-line { color: #dcfce7; }
        
        /* NOWO≈öƒÜ: KLASA DLA TRANSFER√ìW (JASNY NIEBIESKI) */
        .is-transfer { 
            background: var(--trans-bg); 
            border-left-color: var(--trans-border) !important; 
        }
        .is-transfer .main-info { color: #e0f2fe; }
        .is-transfer .sub-line { color: #bae6fd; }
        .is-transfer .transfer-note { color: #7dd3fc; }

        .pay-badge { display: inline-block; background: var(--pay-bg); color: var(--pay-text); border: 1px solid var(--pay-border); border-radius: 4px; padding: 2px 6px; font-size: 0.75rem; font-weight: bold; margin-top: 4px; text-transform: uppercase; box-shadow: 0 0 5px rgba(251, 191, 36, 0.2); }
        .transfer-note { font-size: 0.75em; font-style: italic; margin-top: 2px; line-height: 1.2; border-top: 1px dotted #475569; padding-top: 2px; }

        .duty-section { background: var(--duty-bg); color: var(--duty-color); border-top: 1px dashed var(--duty-border); padding: 8px 10px; font-size: 0.85rem; }
        .morning-duty { background: var(--duty-bg); border-left: 4px solid #f59e0b; padding: 12px; border-radius: 8px; margin-bottom: 8px; color: var(--duty-color); font-size: 0.9rem; border: 1px solid #78350f; }
        .duty-sub { background: var(--duty-sub-bg); border-left-color: var(--duty-sub-border); color: var(--duty-sub-color); border-color: #14532d; }

        footer { background: #064e3b; color: #a7f3d0; text-align: center; padding: 15px; font-size: 0.9rem; border-top: 1px solid #047857; margin-top: auto; }
        footer a { color: #fff; text-decoration: none; font-weight: bold; }
        @media (max-width: 1200px) { .week-container { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>
<body>

<header>
    <div class="header-left">
        <img src="orze≈Ç.png" alt="ZSZ5 Logo" class="logo" onerror="this.style.display='none'">
        <div class="header-text">
            <h1>PLAN LEKCJI - ZSZ5</h1>
            <div id="current-status" class="lesson-indicator"></div>
            
            <div id="selection-info" class="selection-info"></div>
            <div id="clock" class="clock">--:--</div>
        </div>
    </div>

    <div class="week-nav" id="week-nav-container" style="display:none">
        <button class="week-nav-btn" onclick="changeWeek(-1)">&#10094;</button>
        <div class="week-display">
            <span class="week-label">Wybrany tydzie≈Ñ</span>
            <span class="week-range" id="week-range-text">...</span>
        </div>
        <button class="week-nav-btn" onclick="changeWeek(1)">&#10095;</button>
    </div>
    
    <div class="controls" id="nav-controls" style="display:none">
        <select id="mode-select" style="display:none">
            <option value="teacher">Nauczyciel</option>
            <option value="class">Oddzia≈Ç</option>
            <option value="room">Sala</option>
            <option value="duty">Dy≈ºur</option>
        </select>
        <select id="data-select" style="display:none"></select>
        <button class="back-btn" onclick="returnToDashboard()"><span>&#8617;</span> MENU</button>
    </div>

    <div class="header-right">
        <div class="qr-text">
            strona z planem<br>lekcji na telefon
        </div>
        <img src="qr_nauczyciel.png" class="qr-img" alt="QR Code">
    </div>
</header>
    
<div id="debug-bar">≈Åadowanie systemu...</div>

<div id="dashboard-view">
    <div id="selection-grid" class="selection-grid"></div>
    <div id="announcements-container">
        <div class="anno-title">Og≈Çoszenia</div>
        <div id="announcement-content" class="anno-content">≈Åadowanie...</div>
    </div>
</div>

<div id="schedule-view">
    <div id="grid" class="week-container"></div>
</div>

<footer>
    <a href="https://www.zsz5.edupage.org" target="_blank">www.zsz5.edupage.org</a>
</footer>

<script>
    const CONFIG = { xml: './plan.xml', dyzury: './dyzury.xlsx', zastepstwa: './zastepstwa.xlsx', przeniesienia: './InformacjeOPrzeniesieniach.xlsx', refreshInterval: 120000, idleTimeout: 45000 };
    const DB = { teachers: {}, rooms: [], classes: {}, classesList: [], groups: {}, locations: [], periods: [], lessons: [], duties: [], subs: [], dutyChanges: [], transfers: [] };
    const DAYS = ["Niedziela", "Poniedzia≈Çek", "Wtorek", "≈öroda", "Czwartek", "PiƒÖtek", "Sobota"];
    let refreshTimer = null; let idleTimer = null; let isDashboardActive = true; let weekOffset = 0; 
    let countdownInterval = null;

    window.onload = () => {
        startClock(); refreshData(); loadAnnouncements();
        refreshTimer = setInterval(() => { refreshData(); loadAnnouncements(); }, CONFIG.refreshInterval);
        // Dodano 'scroll' i 'keydown' dla pewno≈õci
        ['mousemove', 'click', 'touchstart', 'scroll', 'keydown'].forEach(evt => 
            document.addEventListener(evt, resetIdle)
        );
    };

    function resetIdle() {
        // Je≈õli jeste≈õmy na panelu g≈Ç√≥wnym (Dashboard), nie musimy odliczaƒá
        if (isDashboardActive) return;
        
        clearTimeout(idleTimer);

        // Sprawdzamy szeroko≈õƒá okna (900px to granica mobilna w Twoim CSS)
        const isMobile = window.innerWidth <= 900;

        // Czas w milisekundach:
        // Mobile: 10 minut * 60 sekund * 1000 = 600000 ms
        // Desktop: 30 sekund * 1000 = 30000 ms
        const timeLimit = isMobile ? 600000 : 30000;

        idleTimer = setTimeout(returnToDashboard, timeLimit);
    }

    function returnToDashboard() {
        isDashboardActive = true; weekOffset = 0; clearTimeout(idleTimer);
        document.getElementById('dashboard-view').style.display = 'block';
        document.getElementById('schedule-view').style.display = 'none';
        document.getElementById('nav-controls').style.display = 'none';
        document.getElementById('week-nav-container').style.display = 'none';
        document.getElementById('selection-info').style.display = 'none';
        document.getElementById('selection-info').innerText = '';
        document.body.className = ''; log("Menu G≈Ç√≥wne");
    }

    function openSchedule(mode, id) {
        isDashboardActive = false; weekOffset = 0;
        const modeSel = document.getElementById('mode-select');
        const dataSel = document.getElementById('data-select');
        modeSel.value = mode; populateSelect(false); dataSel.value = id;
        document.body.className = `mode-${mode}`;

        const displayDiv = document.getElementById('selection-info');
        let displayName = id;
        if (mode === 'teacher' && DB.teachers[id]) displayName = DB.teachers[id].name;
        else if (mode === 'room') displayName = "Sala " + id;
        else if (mode === 'class') displayName = "Klasa " + id;
        else if (mode === 'duty') displayName = "Dy≈ºur: " + id;
        
        displayDiv.innerText = displayName; displayDiv.style.display = 'block';
        document.getElementById('dashboard-view').style.display = 'none';
        document.getElementById('schedule-view').style.display = 'block';
        document.getElementById('nav-controls').style.display = 'flex';
        document.getElementById('week-nav-container').style.display = 'flex';
        render(); resetIdle();
    }

    function changeWeek(direction) { weekOffset += direction; render(); resetIdle(); }
    function getStartOfWeek(date) {
        const d = new Date(date); const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6 : 1);
        return new Date(d.setDate(diff));
    }
    function formatDateShort(d) { return `${d.getDate()}.${d.getMonth()+1}`; }

    async function loadAnnouncements() {
        try {
            const res = await fetch('ogloszenia.txt?t=' + new Date().getTime());
            if(res.ok) {
                const text = await res.text();
                if(text.trim().length > 0) {
                    if(countdownInterval) clearInterval(countdownInterval);
                    document.getElementById('announcement-content').innerHTML = text.replace(/\n/g, '<br>');
                    return;
                }
            }
            throw new Error("Pusty plik");
        } catch(e) { startCountdown(); }
    }

    function startCountdown() {
        const target = new Date('2025-12-20T00:00:00');
        const el = document.getElementById('announcement-content');
        if(countdownInterval) clearInterval(countdownInterval);
        
        const tick = () => {
            const now = new Date();
            const diff = target - now;
            if(diff <= 0) {
                el.innerHTML = "Weso≈Çych ≈öwiƒÖt!";
                clearInterval(countdownInterval);
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            el.innerHTML = `Dobrego dnia!<br>Do przerwy ≈õwiƒÖtecznej zosta≈Ço:<br><div class="countdown">${d}d ${h}h ${m}m ${s}s</div>`;
        };
        tick();
        countdownInterval = setInterval(tick, 1000);
    }

    async function refreshData() {
        log("Aktualizacja danych...", false);
        DB.lessons = []; DB.periods = []; DB.duties = []; DB.subs = []; DB.dutyChanges = []; DB.transfers = [];
        DB.teachers = {}; DB.classes = {}; DB.classesList = []; DB.rooms = []; DB.groups = {}; DB.locations = [];

        try {
            await loadXML();
            await Promise.all([ 
                loadExcel(CONFIG.dyzury, 'dyzury').catch(() => {}), 
                loadExcel(CONFIG.zastepstwa, 'zastepstwa').catch(() => {}),
                loadExcel(CONFIG.przeniesienia, 'przeniesienia').catch(() => {})
            ]);
            addMissingTeachers();
            if(isDashboardActive) renderDashboard(); else { populateSelect(false); render(); }
            log(`Dane zaktualizowane: ${new Date().toLocaleTimeString()}`);
        } catch (e) { console.error(e); log("B≈ÇƒÖd aktualizacji danych!", true); }
    }

    function renderDashboard() {
        const container = document.getElementById('selection-grid'); container.innerHTML = "";
        
        const createCard = (title, items, type, icon, clickFn) => {
            const card = document.createElement('div'); card.className = `selection-card ${type}`;
            const ico = document.createElement('div'); ico.className = 'card-icon'; ico.innerText = icon;
            const tit = document.createElement('div'); tit.className = 'card-title'; tit.innerText = title;
            const select = document.createElement('select'); select.className = 'main-select';
            const def = document.createElement('option'); def.text = "Wybierz..."; def.value = ""; def.disabled = true; def.selected = true; select.add(def);
            items.forEach(i => { const opt = document.createElement('option'); opt.value = i.val; opt.text = i.txt; select.add(opt); });
            select.onchange = (e) => { if(e.target.value) clickFn(e.target.value); select.value = ""; };
            card.appendChild(ico); card.appendChild(tit); card.appendChild(select);
            container.appendChild(card);
        };

        const teachers = Object.entries(DB.teachers).sort((a,b) => a[1].name.localeCompare(b[1].name)).filter(([id, t]) => !t.name.toLowerCase().includes('wakat')).map(([id, t]) => ({val: id, txt: t.name}));
        const dutyPlaces = [...new Set(DB.duties.map(d => d.place).concat(DB.dutyChanges.map(d => d.place)))].filter(p => p).sort().map(p => ({val: p, txt: p}));

        createCard("Nauczyciele", teachers, 'teacher', 'üë®‚Äçüè´', (id) => openSchedule('teacher', id));
        createCard("Oddzia≈Çy", DB.classesList.sort().map(c => ({val: c, txt: c})), 'class', 'üéì', (id) => openSchedule('class', id));
        createCard("Sale Lekcyjne", DB.rooms.sort().map(r => ({val: r, txt: r})), 'room', 'üè´', (id) => openSchedule('room', id));
        createCard("Miejsca Dy≈ºur√≥w", dutyPlaces, 'duty', 'üëÅÔ∏è', (id) => openSchedule('duty', id));
    }

    async function fetchFresh(url) {
        const res = await fetch(url + "?t=" + new Date().getTime()); if(!res.ok) throw new Error(`HTTP ${res.status}`); return res;
    }
    async function fetchText(url) {
        const res = await fetchFresh(url); return await res.text(); 
    }
    async function loadExcel(url, type) {
        const res = await fetchFresh(url); const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, {type: 'array'});
        if(type === 'dyzury') parseDuties(wb); 
        if(type === 'zastepstwa') parseSub(wb);
        if(type === 'przeniesienia') parseTransfers(wb);
    }
    async function loadXML() {
        const txt = await fetchText(CONFIG.xml); const xml = new DOMParser().parseFromString(txt, "text/xml");
        xml.querySelectorAll('groups group').forEach(g => { DB.groups[g.getAttribute('id')] = g.getAttribute('name'); });
        xml.querySelectorAll('teachers teacher').forEach(t => {
            const id = t.getAttribute('id'); const name = (t.getAttribute('firstname')||'') + ' ' + (t.getAttribute('lastname')||t.getAttribute('name'));
            DB.teachers[id] = { name: name.trim(), normalized: normalize(name) };
        });
        xml.querySelectorAll('classes class').forEach(c => {
            const id = c.getAttribute('id'); const name = c.getAttribute('name');
            DB.classes[id] = name; if(!DB.classesList.includes(name)) DB.classesList.push(name);
        });
        const roomMap = {}; const roomSet = new Set();
        xml.querySelectorAll('classrooms classroom').forEach(r => { const name = r.getAttribute('name'); roomMap[r.getAttribute('id')] = name; roomSet.add(name); });
        DB.rooms = Array.from(roomSet);
        xml.querySelectorAll('periods period').forEach(p => {
            DB.periods.push({ nr: parseInt(p.getAttribute('period')), start: p.getAttribute('starttime'), end: p.getAttribute('endtime') });
        });
        DB.periods.sort((a,b) => a.nr - b.nr);
        const subjects = {}; xml.querySelectorAll('subjects subject').forEach(s => subjects[s.getAttribute('id')] = s.getAttribute('name'));
        
        xml.querySelectorAll('cards card').forEach(c => {
            const lesson = xml.querySelector(`lessons lesson[id="${c.getAttribute('lessonid')}"]`); if(!lesson) return;
            const tidsRaw = lesson.getAttribute('teacherids'); const dayIdx = c.getAttribute('days').indexOf('1') + 1;
            const roomId = c.getAttribute('classroomids'); const classIds = lesson.getAttribute('classids').split(',');
            const classNames = classIds.map(cid => DB.classes[cid]).join(', ');
            const groupIds = lesson.getAttribute('groupids'); const groupName = groupIds ? groupIds.split(',').map(gid => DB.groups[gid]).join(',') : '';

            if(dayIdx > 0 && tidsRaw) {
                const tidsArray = tidsRaw.split(','); const mainTeacherId = tidsArray[0].trim();
                const supportTeachers = tidsArray.slice(1).map(tid => DB.teachers[tid.trim()]?.name || tid);
                DB.lessons.push({
                    teacherId: mainTeacherId, day: dayIdx, period: parseInt(c.getAttribute('period')),
                    subject: subjects[lesson.getAttribute('subjectid')] || 'Lekcja',
                    room: roomMap[roomId] || '', classNames: classNames, branch: '', groupName: groupName,
                    supportInfo: supportTeachers.length ? supportTeachers.join(', ') : null
                });
            }
        });
    }

    function parseTransferString(str) {
        try {
            const parts = str.split(','); if (parts.length < 2) return null;
            const datePart = parts[0].trim(); const periodPart = parseInt(parts[1].trim());
            const d = datePart.split('.'); const isoDate = `${d[2]}-${d[1]}-${d[0]}`;
            let room = ""; const roomPart = parts.find(p => p.trim().includes('sala:'));
            if(roomPart) room = roomPart.replace('sala:', '').trim();
            return { date: isoDate, period: periodPart, room: room };
        } catch(e) { return null; }
    }

    function parseTransfers(wb) {
        const sh = wb.Sheets["Oddzia≈Çy"] || wb.Sheets[0]; const data = XLSX.utils.sheet_to_json(sh);
        data.forEach(r => {
            const fromStr = r['Przeniesiono z']; const toStr = r['Przeniesiono na'];
            const teacherRaw = r['Nauczyciel/wakat']; const classRaw = r['Oddzia≈Ç']; const subject = r['Przedmiot']; const note = r['Uwagi'];
            if(fromStr && toStr) {
                const fromInfo = parseTransferString(fromStr); const toInfo = parseTransferString(toStr);
                const teacherId = findTeacherId(teacherRaw);
                if(fromInfo) {
                    DB.transfers.push({ type: 'out', date: fromInfo.date, period: fromInfo.period, room: fromInfo.room, targetInfo: `Przeniesiono na: ${toInfo.date} lekcja ${toInfo.period}`, teacherId: teacherId, teacherName: teacherRaw, class: classRaw, subject: subject, note: note });
                }
                if(toInfo) {
                    DB.transfers.push({ type: 'in', date: toInfo.date, period: toInfo.period, room: toInfo.room, targetInfo: `Przeniesiono z: ${fromInfo.date} lekcja ${fromInfo.period}`, teacherId: teacherId, teacherName: teacherRaw, class: classRaw, subject: subject, note: note });
                }
            }
        });
    }

    function parseDuties(wb) {
        wb.SheetNames.forEach(sheetName => {
            const ws = wb.Sheets[sheetName]; const data = XLSX.utils.sheet_to_json(ws, {header: 1});
            let currentDayMap = null;
            for(let i=0; i<data.length; i++) {
                const row = data[i]; if(!row || !row.length) continue;
                const rowStr = row.map(c => String(c||"").toLowerCase());
                if(rowStr.some(s => s.includes('poniedzia≈Çek'))) {
                    currentDayMap = {};
                    row.forEach((cell, idx) => {
                        const val = String(cell||"").toLowerCase();
                        if(val.includes('poniedzia≈Çek')) currentDayMap[idx]=1; if(val.includes('wtorek')) currentDayMap[idx]=2;
                        if(val.includes('≈õroda')) currentDayMap[idx]=3; if(val.includes('czwartek')) currentDayMap[idx]=4;
                        if(val.includes('piƒÖtek')) currentDayMap[idx]=5;
                    });
                    continue;
                }
                if(currentDayMap) {
                    let timeVal=null, placeVal=null;
                    for(let c=0; c<5; c++) {
                        if(row[c] && /\d{1,2}:\d{2}\s*-\s*\d{1,2}:\d{2}/.test(String(row[c]))) {
                            timeVal = String(row[c]).trim();
                            if(c>0 && row[c-1]) placeVal = unifyPlaceName(row[c-1]); 
                                else if(row[0]) placeVal = unifyPlaceName(row[0]); 
                                break;
                        }
                    }
                    if(timeVal) {
                        for(const [colIdx, dayNum] of Object.entries(currentDayMap)) {
                            const rawTeacher = row[colIdx];
                            if(rawTeacher && String(rawTeacher).length>2) {
                                const tId = findTeacherId(String(rawTeacher).trim());
                                if(tId) DB.duties.push({
                                    teacherId: tId, day: dayNum, time: timeVal,
                                    startMin: timeToMin(timeVal.split('-')[0]), place: placeVal ? placeVal.trim() : "Dy≈ºur"
                                });
                            }
                        }
                    }
                }
            }
        });
    }

    function parseSub(wb) {
        const sh = wb.Sheets["Oddzia≈Çy"] || wb.Sheets[0];
        XLSX.utils.sheet_to_json(sh).forEach(r => {
            const d = parseDate(r['Dzie≈Ñ']);
            if(d) DB.subs.push({
                date: d, periodRaw: r['Lekcja'], absent: findTeacherId(r['Nauczyciel/wakat']),
                sub: findTeacherId(r['Zastƒôpca']), rawSub: r['Zastƒôpca'], rawAbs: r['Nauczyciel/wakat'],
                subject: r['Przedmiot'], room: r['Sala'], note: r['Uwagi'], branch: r['Oddzia≈Ç'], payInfo: r['Forma p≈Çatno≈õci']
            });
        });
        const shDy = wb.Sheets["Dy≈ºury"];
        if(shDy) {
            XLSX.utils.sheet_to_json(shDy).forEach(r => {
                const d = parseDate(r['Dzie≈Ñ']);
                if(d) DB.dutyChanges.push({
                    date: d, time: r['Godzina'], absent: findTeacherId(r['Nauczyciel']), sub: findTeacherId(r['Zastƒôpca']),
                    rawSub: r['Zastƒôpca'], place: unifyPlaceName(r['Miejsce dy≈ºuru']) // <-- TU ZMIANA
                });
            });
        }
    }

    function normalize(str) { return (str||"").toLowerCase().replace(/^(x\.|ks\.|p\.|pani|pan)\s+/g, '').replace(/[^a-z≈ÇƒÖce≈∫≈º≈Ñ√≥≈õ\s]/g, '').trim().split(/\s+/).sort().join(' '); }
    // --- NOWA FUNKCJA DO UJEDNOLICANIA NAZW MIEJSC ---
    function unifyPlaceName(raw) {
        if (!raw) return "";
        let str = String(raw).trim();
        let lower = str.toLowerCase();

        // --- 1. SEKCJA WF (Nowa) ---
        // Lista kod√≥w, kt√≥re majƒÖ byƒá wy≈õwietlane jako og√≥lny WF
        const wfCodes = [
            'edb+wf', 
            'sp1', 'sp2', 
            'ag2', 'aq1', 
            'sg1', 'sg2', 'sg3', 'sg4', 'sg5'
        ];

        // Je≈õli nazwa zawiera kt√≥rykolwiek z kod√≥w WF (np. "sg3/39" zawiera "sg3"), podmie≈Ñ nazwƒô
        if (wfCodes.some(code => lower.includes(code))) {
            return 'WF - wed≈Çug grafiku tygodniowego';
        }

        // --- 2. RESZTA UJEDNOLICE≈É (Poprzednie) ---
        if (lower.includes('boisko')) return 'boisko - dziedziniec wej≈õciowy';
        if (lower.includes('bramka')) return 'bramka wej≈õciowa';
        if (lower.includes('sto≈Ç√≥wka') || lower.includes('stolowka')) return 'sto≈Ç√≥wka';
        if (lower.includes('biblioteka') || lower.includes('czytelnia')) return 'biblioteka';
        if (lower.includes('parter')) return 'parter';

        // Piƒôtra
        if (lower.includes('1') && (lower.includes('p') || lower.includes('piƒôtro'))) return 'piƒôtro_1';
        if (lower.includes('2') && (lower.includes('p') || lower.includes('piƒôtro'))) return 'piƒôtro_2';
        if (lower.includes('3') && (lower.includes('p') || lower.includes('piƒôtro'))) return 'piƒôtro_3';

        // Je≈õli nic nie pasuje, zwr√≥ƒá orygina≈Ç
        return str;
    }
    
    function findTeacherId(rawName) {
        if(!rawName || rawName.length<3) return null; if(/wakat|brak|okienko/i.test(rawName)) return null;
        const target = normalize(rawName); let bestId = null, bestScore = 0;
        for(const [id, t] of Object.entries(DB.teachers)) {
            const source = t.normalized;
            if(source === target) return id;
            if(source.includes(target) || target.includes(source)) { if(bestScore<50) { bestScore=50; bestId=id; } }
        } return bestId;
    }
    function timeToMin(str) { if(!str) return 0; const [h,m] = str.trim().split(':').map(Number); return h*60+m; }
    function parseDate(val) {
        if(!val) return null; if(typeof val === 'number') { const d = XLSX.SSF.parse_date_code(val); return `${d.y}-${d.m<10?'0':''}${d.m}-${d.d<10?'0':''}${d.d}`; }
        if(typeof val === 'string') { const p = val.trim().split('.'); if(p.length===3) return `${p[2]}-${p[1]}-${p[0]}`; } return null;
    }
    function getTeacherName(id) { return DB.teachers[id] ? DB.teachers[id].name : id; }
    function normalizeClass(c) { return (c || "").replace(/\s/g, '').toLowerCase(); }
    function addMissingTeachers() { const check = (raw, obj, f) => { if(raw && !obj[f]) { const nid="EXT_"+normalize(raw).replace(/\s/g,'_'); if(!DB.teachers[nid]) DB.teachers[nid]={name:raw.trim(),normalized:normalize(raw)}; obj[f]=nid; }}; DB.subs.forEach(s => check(s.rawSub, s, 'sub')); DB.dutyChanges.forEach(d => check(d.rawSub, d, 'sub')); }
    function populateSelect(renderIt=true) {
        const mode = document.getElementById('mode-select').value; const sel = document.getElementById('data-select'); sel.innerHTML = ""; let items = [];
        if (mode === 'teacher') items = Object.entries(DB.teachers).sort((a,b) => a[1].name.localeCompare(b[1].name)).map(x => ({val: x[0], txt: x[1].name}));
        else if (mode === 'room') items = DB.rooms.sort().map(x => ({val: x, txt: x}));
        else if (mode === 'class') items = DB.classesList.sort().map(x => ({val: x, txt: x}));
        else if (mode === 'duty') items = [...new Set(DB.duties.map(d=>d.place).concat(DB.dutyChanges.map(d=>d.place)))].filter(p=>p).sort().map(x => ({val: x, txt: x}));
        items.forEach(i => { const opt = document.createElement('option'); opt.value = i.val; opt.innerText = i.txt; sel.appendChild(opt); }); if(items.length && !sel.value) sel.value = items[0].val;
    }

    function getDutiesForTime(tid, day, date, min, max) {
        const res = [];
        DB.duties.filter(d => d.teacherId==tid && d.day==day).forEach(d => {
            if(d.startMin >= min && d.startMin < max) {
                const canc = DB.dutyChanges.find(c => c.date==date && c.time==d.time && c.absent==tid);
                res.push({...d, status: canc?'cancelled':'ok'});
            }
        });
        DB.dutyChanges.filter(c => c.date==date && c.sub==tid).forEach(c => {
            const start = timeToMin(c.time.split('-')[0]);
            if(start >= min && start < max) res.push({ time: c.time, place: c.place, startMin: start, status: 'added' });
        }); return res;
    }

    function render() {
        const mode = document.getElementById('mode-select').value; const selectedId = document.getElementById('data-select').value;
        const grid = document.getElementById('grid'); grid.innerHTML = ""; if(!selectedId) return;
        
        const today = new Date(); if (today.getDay() === 6 || today.getDay() === 0) { today.setDate(today.getDate() + 2); }
        today.setDate(today.getDate() + (weekOffset * 7)); const monday = getStartOfWeek(today);
        const friday = new Date(monday); friday.setDate(friday.getDate() + 4);
        document.getElementById('week-range-text').innerText = `${formatDateShort(monday)} - ${formatDateShort(friday)}`;

        for(let i=0; i<5; i++) {
            const curDate = new Date(monday); curDate.setDate(monday.getDate() + i);
            const dateStr = curDate.toISOString().split('T')[0]; const dayNum = i + 1;
            const col = document.createElement('div'); col.className = 'day-col';
            col.innerHTML = `<div class="day-header">${DAYS[dayNum]}<span class="day-date">${curDate.toLocaleDateString('pl-PL')}</span></div>`;
            const content = document.createElement('div'); content.className = 'day-content';

            if (mode === 'teacher') {
                getDutiesForTime(selectedId, dayNum, dateStr, 0, 480).forEach(d => {
                    const div = document.createElement('div'); div.className = 'card morning-duty'; 
                    if(d.status==='added') div.classList.add('duty-sub'); if(d.status==='cancelled') div.style.textDecoration='line-through';
                    div.innerHTML = `<div style="font-weight:700">${d.status==='added'?'ZASTƒòPSTWO':'DY≈ªUR'} ${d.time}</div><div>${d.place}</div>`;
                    content.appendChild(div);
                });
            }

            if (mode === 'duty') {
                const duties = DB.duties.filter(d => d.day == dayNum && d.place === selectedId);
                const changes = DB.dutyChanges.filter(d => d.date == dateStr && d.place === selectedId);
                let allDuties = [];
                
                // --- ZMIANA TUTAJ ---
                duties.forEach(d => {
                    const cancelled = DB.dutyChanges.find(ch => ch.date == dateStr && ch.time == d.time && ch.absent == d.teacherId);
                    
                    // Je≈õli dy≈ºur ma zastƒôpstwo (cancelled istnieje), po prostu GO POMIJAMY.
                    // Nie dodajemy go do listy 'allDuties', wiƒôc nie wy≈õwietli siƒô czerwony pasek.
                    // Zastƒôpstwo i tak wejdzie z listy 'changes' (poni≈ºej) jako zielony pasek.
                    if (!cancelled) { 
                        allDuties.push({...d, type: 'normal'}); 
                    }
                });
                // --------------------

                changes.forEach(ch => { allDuties.push({ time: ch.time, teacherId: ch.sub, type: 'added', startMin: timeToMin(ch.time.split('-')[0]) }); });
                allDuties.sort((a,b) => a.startMin - b.startMin);
                allDuties.forEach(d => {
                    const div = document.createElement('div'); div.className = 'card';
                    if(d.type === 'cancelled') { 
                        div.classList.add('is-sub'); 
                        div.innerHTML = `<div class="meta">${d.time}</div><div class="main-info" style="text-decoration:line-through">${getTeacherName(d.teacherId)}</div><div class="sub-line" style="color:var(--sub-color)">Zastƒôpstwo: ${d.sub}</div>`; 
                    }
                    else if(d.type === 'added') { div.classList.add('is-new'); div.innerHTML = `<div class="meta">${d.time}</div><div class="main-info">${getTeacherName(d.teacherId)}</div><div class="sub-line">ZASTƒòPSTWO</div>`; }
                    else { div.innerHTML = `<div class="meta">${d.time}</div><div class="main-info">${getTeacherName(d.teacherId)}</div>`; }
                    content.appendChild(div);
                });
            } else {
                DB.periods.forEach(p => {
                    const wrapper = document.createElement('div'); wrapper.className = 'slot-wrapper';
                    let lessons = [], subAdds = [], transferOut = [], transferIn = [];
                    
                    if (mode === 'teacher') lessons = DB.lessons.filter(l => l.teacherId == selectedId && l.day == dayNum && l.period == p.nr);
                    else if (mode === 'room') lessons = DB.lessons.filter(l => l.room === selectedId && l.day == dayNum && l.period == p.nr);
                    else if (mode === 'class') lessons = DB.lessons.filter(l => l.classNames.includes(selectedId) && l.day == dayNum && l.period == p.nr);
                    
                    if (mode === 'teacher') subAdds = DB.subs.filter(s => s.date == dateStr && s.sub == selectedId && s.periodRaw.startsWith(p.nr+','));
                    else if (mode === 'room') subAdds = DB.subs.filter(s => s.date == dateStr && s.room === selectedId && s.periodRaw.startsWith(p.nr+','));
                    else if (mode === 'class') subAdds = DB.subs.filter(s => s.date == dateStr && normalizeClass(s.branch).includes(normalizeClass(selectedId)) && s.periodRaw.startsWith(p.nr+','));

                    if (mode === 'teacher') {
                        transferOut = DB.transfers.filter(t => t.type === 'out' && t.date === dateStr && t.period == p.nr && t.teacherId == selectedId);
                        transferIn = DB.transfers.filter(t => t.type === 'in' && t.date === dateStr && t.period == p.nr && t.teacherId == selectedId);
                    } else if (mode === 'class') {
                        transferOut = DB.transfers.filter(t => t.type === 'out' && t.date === dateStr && t.period == p.nr && normalizeClass(t.class).includes(normalizeClass(selectedId)));
                        transferIn = DB.transfers.filter(t => t.type === 'in' && t.date === dateStr && t.period == p.nr && normalizeClass(t.class).includes(normalizeClass(selectedId)));
                    } else if (mode === 'room') {
                        transferOut = DB.transfers.filter(t => t.type === 'out' && t.date === dateStr && t.period == p.nr && t.room == selectedId);
                        transferIn = DB.transfers.filter(t => t.type === 'in' && t.date === dateStr && t.period == p.nr && t.room == selectedId);
                    }

                    lessons.sort((a,b) => (a.groupName||"").localeCompare(b.groupName||""));

                    if(lessons.length > 0) {
                        lessons.forEach(lesson => {
                            const div = document.createElement('div');
                            const subAbs = DB.subs.find(s => s.date == dateStr && s.absent == lesson.teacherId && s.periodRaw.startsWith(p.nr+','));
                            const transOut = transferOut.find(t => t.period == p.nr);

                            if(subAbs) {
                                div.className = 'card is-sub'; div.innerHTML = `<div class="meta"><span class="nr">${p.nr}</span> ${p.start}-${p.end} ${lesson.groupName ? `<span class="group-badge">${lesson.groupName}</span>` : ''}</div><div class="main-info">${lesson.subject}</div><span class="note-red">Nieobecno≈õƒá</span>`;
                            } else if (transOut) {
                                div.className = 'card is-transfer'; 
                                div.style.textDecoration = "line-through";
                                div.innerHTML = `<div class="meta"><span class="nr">${p.nr}</span> ${p.start}-${p.end}</div><div class="main-info">${lesson.subject}</div><div class="transfer-note">${transOut.targetInfo}</div>`;
                            } else {
                                div.className = 'card'; let line = "";
                                if(mode === 'teacher') line = `${lesson.classNames} / s.${lesson.room}`; else if(mode === 'class') line = `${getTeacherName(lesson.teacherId)} / s.${lesson.room}`; else line = `${getTeacherName(lesson.teacherId)} / ${lesson.classNames}`;
                                div.innerHTML = `<div class="meta"><span class="nr">${p.nr}</span> ${p.start}-${p.end} ${lesson.groupName ? `<span class="group-badge">${lesson.groupName}</span>` : ''}</div><div class="main-info">${lesson.subject}</div><div class="sub-line">${line}</div>`;
                            }
                            wrapper.appendChild(div);
                        });
                    }

                    if(transferIn.length > 0) {
                        transferIn.forEach(t => {
                            const div = document.createElement('div'); div.className = 'card is-transfer';
                            div.innerHTML = `<div class="meta"><span class="nr">${p.nr}</span> ${p.start}-${p.end}</div><div class="main-info">${t.subject}</div><div class="sub-line">${t.teacherName} / s.${t.room}</div><div class="transfer-note">${t.targetInfo}<br>${t.note || ''}</div>`;
                            wrapper.appendChild(div);
                        });
                    }

                    if(subAdds.length > 0) {
                        subAdds.forEach(sub => {
                            let subGroup = ""; if(sub.branch && sub.branch.includes('|')) subGroup = sub.branch.split('|')[1];
                            const div = document.createElement('div'); div.className = 'card is-new';
                            let line = ""; if (mode === 'teacher') line = `s.${sub.room} / ${sub.branch}`; else if (mode === 'class') line = `${getTeacherName(sub.sub)} / s.${sub.room}`; else line = `${getTeacherName(sub.sub)} / ${sub.branch}`;
                            let payBadge = ""; if(mode === 'teacher' && sub.payInfo) payBadge = `<span class="pay-badge">$ ${sub.payInfo}</span>`;
                            div.innerHTML = `<div class="meta"><span class="nr">${p.nr}</span> ${p.start}-${p.end} ${subGroup ? `<span class="group-badge">${subGroup}</span>` : ''}</div><div class="main-info">ZASTƒòPSTWO</div><div class="sub-line">${line} / ${sub.subject}</div><div class="details" style="font-size:0.75em; color:#a7f3d0">Za: ${sub.rawAbs}</div>${payBadge}`;
                            wrapper.appendChild(div);
                        });
                    }

                    if(lessons.length === 0 && subAdds.length === 0 && transferIn.length === 0) { const div = document.createElement('div'); div.className = 'card empty'; div.innerHTML = `${p.nr}. ${p.start}`; wrapper.appendChild(div); }
                    
                    if(mode === 'teacher') {
                        const pEnd = timeToMin(p.end);
                        getDutiesForTime(selectedId, dayNum, dateStr, pEnd-5, pEnd+15).forEach(d => {
                            const dDiv = document.createElement('div'); dDiv.className = 'duty-section'; if(d.status === 'added') dDiv.classList.add('duty-sub'); dDiv.innerHTML = `<b>${d.time}</b> ${d.place}`; wrapper.appendChild(dDiv);
                        });
                    }
                    content.appendChild(wrapper);
                });
            }
            col.appendChild(content); grid.appendChild(col);
        }
    }

    function startClock() {
        const update = () => { 
            const now = new Date(); 
            document.getElementById('clock').innerText = now.toLocaleString('pl-PL', { weekday:'short', day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' }); 
            updateLessonStatus(); // <--- DODANO TO WYWO≈ÅANIE
        };
        update(); 
        setInterval(update, 1000);
    }
    
    function updateLessonStatus() {
        // Je≈õli nie ma danych o okresach (jeszcze siƒô nie za≈Çadowa≈Çy), nic nie r√≥b
        if (!DB.periods || DB.periods.length === 0) return;

        const now = new Date();
        const currentMin = now.getHours() * 60 + now.getMinutes();
        const el = document.getElementById('current-status');
        
        // Je≈õli jest informacja o wyborze (np. "Klasa 2TI"), ukrywamy status lekcji, ≈ºeby nie robiƒá ba≈Çaganu
        // lub zostawiamy - zale≈ºy od preferencji. Tutaj zostawiam widoczne.
        
        let statusText = "";
        let color = "#94a3b8"; // Szary domy≈õlny

        for (let i = 0; i < DB.periods.length; i++) {
            const p = DB.periods[i];
            const start = timeToMin(p.start);
            const end = timeToMin(p.end);

            if (currentMin >= start && currentMin < end) {
                statusText = `üî¥ TRWA LEKCJA ${p.nr} (${p.start} - ${p.end})`;
                color = "#fbbf24"; // Bursztynowy dla lekcji
                break;
            }

            // Sprawdzenie przerwy (je≈õli to nie ostatnia lekcja)
            if (i < DB.periods.length - 1) {
                const nextP = DB.periods[i+1];
                const nextStart = timeToMin(nextP.start);
                if (currentMin >= end && currentMin < nextStart) {
                    statusText = `üü¢ PRZERWA (po lekcji ${p.nr})`;
                    color = "#4ade80"; // Zielony dla przerwy
                    break;
                }
            }
        }

        // Obs≈Çuga przed i po lekcjach
        if (!statusText && DB.periods.length > 0) {
            const firstStart = timeToMin(DB.periods[0].start);
            const lastEnd = timeToMin(DB.periods[DB.periods.length-1].end);
            
            if (currentMin < firstStart) {
                statusText = "Przed lekcjami";
            } else if (currentMin >= lastEnd) {
                statusText = "Po lekcjach";
            }
        }

        el.innerText = statusText;
        el.style.color = color;
    }
    
    function log(msg, err=false) { const el = document.getElementById('debug-bar'); el.innerText = msg; el.style.color = err ? '#ef4444' : '#64748b'; }
</script>
</body>
</html>
